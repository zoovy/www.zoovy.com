#!/usr/bin/perl

use strict;

##
## This is called by Brandons shipping calculator to figure out where the merchant ships.
##

use CGI;
my $q = new CGI;

my $USERNAME = $q->param('USERNAME');
my $PRODUCT = $q->param('PRODUCT');
## strip brandons fuckup!
if ($PRODUCT =~ /^0*0*/) {
   $PRODUCT =~ s/0\*//gs; $PRODUCT = "0*".$PRODUCT;
   }

# my $USERNAME = 'brian';
my $webdb = &ZWEBSITE::fetch_website_dbref($USERNAME);

use lib "/httpd/modules";
use ZSHIP;

print "Content-type: text/xml\n\n";

print "<shipinfo>\n";
print "<flags>$webdb->{'cached_flags'}</flags>\n";


my $ERROR = '';

my $flags = $webdb->{'cached_flags'};
if ($flags =~ /,EBAY,/) {
	## you may pass
	}
elsif ($flags =~ /,L3,/) {
	## you may pass
	}
else {
	$ERROR = "Merchant does not have the necessary flags to use this feature.";
	}


if ($ERROR ne '') {
	print "<error msg=\"$ERROR\"></error>\n";

	}
else {
	print "<webdb>\n";
	foreach my $p (keys %{$webdb}) {
		next unless ($p =~ /^ship_/);
		print "<$p>".&ZTOOLKIT::encode($webdb->{$p})."</$p>\n";
		}	
	print "</webdb>\n";
	print "<key>FizzyWigDingleBerry</key>";

	print "<countries>\n";
	print "<country label=\"United States\" data=\"\"/>\n";

	if ($webdb->{'ship_int_risk'} ne 'NONE') { 
		print "<country label=\"Canada\" data=\"Canada\"/>\n";
		}

	my %dest = &ZSHIP::fetch_int_destinations_by_merchant($USERNAME);
	foreach my $d (sort keys %dest) {
		print "<country label=\"$d\" data=\"$d\"/>\n";
		}
	print "</countries>\n";
	}
print "</shipinfo>\n";

