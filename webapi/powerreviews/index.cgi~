#!/usr/bin/perl

use strict;
use lib "/httpd/modules";
use ZOOVY;
use ZWEBSITE;
use NAVCAT::FEED;
use ZSHIP;
use INVENTORY;
use GTOOLS;
use WHOLESALE;
use SYNDICATION;
use SYNDICATION::POWERREV;
use CGI;


my ($q) = new CGI;
my ($key) = $q->param('key');

my $ERROR = undef;
my ($USERNAME,$PRT,$KEY,$PROFILE) = split(/\:/,$key);
use ZTOOLKIT::SECUREKEY;
my ($realkey) = &ZTOOLKIT::SECUREKEY::gen_key($USERNAME,'PR');

print "Content-type: text/plain\n\n";

if ((not defined $ERROR) && ($USERNAME eq '')) { 
	$ERROR = 'Could not find username.'; 
	}

if ((not defined $ERROR) && ($realkey ne $KEY)) {
	$ERROR = "invalid security key\n";
	}

my ($so) = undef;
if ($ERROR ne '') {
	}
elsif ($PROFILE eq '') {
	($PROFILE) = &ZWEBSITE::prt_get_profile($USERNAME,$PRT);
	}

if ($ERROR eq '') {
	($so) = SYNDICATION->new($USERNAME,$PROFILE,'PRV');
	if (not defined $so) { $ERROR = "USERNAME:$USERNAME PROFILE:$PROFILE could not instantiate power reviews syndication object.\n"; }
	}

my $file = '';
if ($ERROR ne '') {
	}
elsif ($so->get('.url') eq '') {
	$ERROR = "USERNAME:$USERNAME PROFILE:$PROFILE found .url in syndication object is blank.\n";
	}
elsif ($so->get('.url') =~ /^site\:\/\/(.*?)$/) {
	$file = $1;
	my $userpath = &ZOOVY::resolve_userpath($USERNAME);
	if (-f "$userpath/IMAGES/$file") {
		$file = "$userpath/IMAGES/$file";
		}
	else {
		$ERROR = "USERNAME:$USERNAME PROFILE:$PROFILE syndication file does not actually exist.\n";
		}
	}

## 

use Data::Dumper;
print Dumper($USERNAME,$PROFILE,$so);

if ($ERROR eq '') {
	open F, "<$file";
	while (<F>) {
		print $_;
		}
	close F;	
	}
else {	
	print "REGRETABLY, WE HAD AN ERROR\nERROR:$ERROR\n\n";
	}


