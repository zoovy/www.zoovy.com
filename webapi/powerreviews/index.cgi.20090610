#!/usr/bin/perl

use lib "/httpd/modules";
use ZOOVY;
use ZWEBSITE;
use NAVCAT::FEED;
use ZSHIP;
use INVENTORY;
use GTOOLS;
use WHOLESALE;
use SYNDICATION;
use SYNDICATION::POWERREV;
use CGI;


my ($q) = new CGI;
my ($key) = $q->param('key');

my $ERROR = undef;
my ($USERNAME,$PRT,$KEY,$PROFILE) = split(/:/,$key);
use ZTOOLKIT::SECUREKEY;
my ($realkey) = &ZTOOLKIT::SECUREKEY::gen_key($USERNAME,'PR');

if ((not defined $ERROR) && ($USERNAME eq '')) { 
	$ERROR = 'Could not find username.'; 
	}

if ((not defined $ERROR) && ($realkey ne $KEY)) {
	$ERROR = "invalid security key\n";
	}

## 

if ($ERROR eq '') {
	if ($PROFILE eq '') {
		($PROFILE) = &ZWEBSITE::prt_get_profile($USERNAME,$PRT);
		}

	print "Content-type: text/plain\n\n";
	my ($so) = SYNDICATION->new($USERNAME,$PROFILE,'PRV');
	if ($so->get('.url') =~ /^site\:\/\/(.*?)$/) {
		my $file = $1;
		my $userpath = &ZOOVY::resolve_userpath($USERNAME);
		if (-f "$userpath/IMAGES/$file") {
			open F, "<$userpath/IMAGES/$file";
			while (<F>) {
				print $_;
				}
			close F;	
			}
		else {
			print "FILE $file does not appear to actually exist (even though it should).\n";
			}
		}
	else {	
		print "REGRETABLY, THE $USERNAME HAS NOT GENERATED FILE FOR PROFILE $PROFILE\n";
		}
	}
else {
	print "Content-type: text/error\n\nERROR: $ERROR\n";
	}

