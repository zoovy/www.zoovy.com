#!/usr/bin/perl

use lib "/httpd/modules";
use OVERSTOCK::API;
use CGI;
use ZOOVY;
use DBINFO;

my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate("/biz/syndication",2,'_P&16');
if ($USERNAME eq '') { exit; }

my $q = new CGI;
my $ACTION = $q->param('ACTION');

if ($ACTION eq 'SUCCESS') {
	my $dbh = DBINFO::db_zoovy_connect();
	my ($r,$rmsg) = &OVERSTOCK::API::apiRequest($USERNAME,'GetUser',\%params);	
	print STDERR $rmsg."\n";
	if ($r==0) {
		my $USERID = '';
		my $SCREENNAME = '';
		if ($rmsg =~ /<UserId>(.*?)<\/UserId>/) { $USERID = $1; }
		if ($rmsg =~ /<ScreenName>(.*?)<\/ScreenName>/) { $SCREENNAME = $1; }
		$pstmt = "update OVERSTOCK_USERS set STATUS_MSG='Succesfully Registered',OS_USERID=".$dbh->quote($USERID).",OS_SCREENNAME=".$dbh->quote($SCREENNAME)." where MERCHANT=".$dbh->quote($USERNAME);
		print STDERR $pstmt."\n";
		$dbh->do($pstmt);
		print "Location: http://www.zoovy.com/biz/syndication/overstock\n\n"; exit;
		## not reached!
		}
	else {
		$pstmt = "update OVERSTOCK_USERS set STATUS='Registration Failed' where MERCHANT=".$dbh->quote($USERNAME);
		print STDERR $pstmt."\n";
		$dbh->do($pstmt);
		$ACTION = 'REGISTER';	# lets try it again!
		}
	&DBINFO::db_zoovy_close();
	}

if ($ACTION eq 'REGISTER') {
	my %params = ();
	if ($q->param('dev')) { $params{'*'}++; }
	
	my ($r,$rmsg) = &OVERSTOCK::API::apiRequest('','GetCredentials',\%params);
	print "RMSG: $rmsg\n";

	my $URL = '';
	my $AUTHID = ''; if ($rmsg =~ /<AuthenticationId>(.*?)<\/AuthenticationId>/) { $AUTHID = $1; } 
	if ($rmsg =~ /\<LoginURL\>(.*?)\<\/LoginURL\>/s) {
		require URI::Escape;
		$URL = &ZOOVY::dcode($1);
		# $URL .= "&RedirectURL=".URI::Escape::uri_escape("http://www.zoovy.com/biz/syndication/overstock/index.cgi");
		# $URL .= "&RedirectURL=".URI::Escape::uri_escape("http://www.zoovy.com/biz/syndication/");
		$URL .= "&RedirectURL=".URI::Escape::uri_escape("http://webapi.zoovy.com/webapi/overstock/redirect.cgi?ACTION=SUCCESS");
		}
	else {
		}

	my $dbh = DBINFO::db_zoovy_connect();
	my $qtUSERNAME = $dbh->quote($USERNAME);
	$pstmt = "delete from OVERSTOCK_USERS where MERCHANT=$qtUSERNAME";
	print STDERR $pstmt."\n";	
	$dbh->do($pstmt);

	my $DEV = ($q->param('dev'))?1:0;
	$pstmt = "insert into OVERSTOCK_USERS (MID,MERCHANT,CREATED_GMT,DEV,AUTHKEY) values ";
	$pstmt .= " ($MID,$qtUSERNAME,".time().",$DEV,".$dbh->quote($AUTHID).")";
	print STDERR $pstmt."\n";
	$dbh->do($pstmt);
	

	if ($URL eq '') {
		print "Content-type: text/plain\n\n";
		print "Error, could not obtain credentials from Overstock";
		}
	else {
		print "Location: $URL\n\n";
		}

	}

&DBINFO::db_zoovy_close();
exit;

print "Content-type: text/plain\n\n";
use Data::Dumper;
print Dumper($q);
