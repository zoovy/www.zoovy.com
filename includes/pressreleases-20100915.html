<%perl>

use Cache::Memcached::libmemcached;

##
## this has to be broken out so it can be called by sitemap.pl
##	%options
##		filter
##			homepage : homepage news
##			newspage : /company/pressreleases
##
sub get_press {
	my (%options) = @_;

	my $memd = &ZOOVY::getMemd("");
	
	use POSIX qw(strftime);
	my $MEMD_OBJECT_ID = strftime("%press_release!Y-%m-%d-%H",localtime());
	if ($options{'filter'}) { $MEMD_OBJECT_ID = sprintf("%s/%s",$MEMD_OBJECT_ID,$options{'filter'}); }
	$MEMD_OBJECT_ID = time();
	
	my @AR = ();
	my $RESULT = $memd->get($MEMD_OBJECT_ID);

	if (defined $RESULT) {
		@AR = @{$RESULT};
		}
	else {
		use Lingua::EN::Summarize;

		my $dbh = &DBINFO::db_zoovy_connect();
	
		my $pstmt = "select PUBLIC,ID,TITLE,TOPIC, date_format(CREATED,\"%Y-%m-%d\") as CREATED_YYYYMMDD,MESSAGE from RECENT_NEWS where PUBLIC>0 and CREATED<now() order by ID desc";
		if ($options{'filter'} eq 'homepage') { $pstmt .= " limit 0,15"; }
		
		my $sth = $dbh->prepare($pstmt);
		$sth->execute();
		while ( my ($PUBLIC,$ID,$TITLE,$TOPIC,$CREATED,$MSG) = $sth->fetchrow() ) {
		
			next if ( ($options{'filter'} ne 'homepage') && ($PUBLIC & 8) );	# show seo fodder
			next if ( ($options{'filter'} eq 'homepage') && ($PUBLIC & 2) );	# skip tips

			next if ( ($options{'filter'} eq 'newspage') && ($PUBLIC & 4) );	# skip industry news
			next if ( ($options{'filter'} eq 'newspage') && ($PUBLIC & 2) );	# skip tips/tricks
		
			my $SEO_TITLE = $TITLE;
			$SEO_TITLE =~ s/[^A-Za-z0-9]+/-/g;
		
			if ($PUBLIC & 1) { $TITLE = "Zoovy Announces: $TITLE"; }
			elsif ($PUBLIC & 4) { $TITLE = "Industry: $TITLE"; }
		
			$MSG =~ s/<.*?>//gs;
			if (length($MSG)>256) {
				$MSG =  Lingua::EN::Summarize::summarize($MSG,maxlength=>128);
				}
			push @AR, "$CREATED|news|index.html/$SEO_TITLE?id=$ID|$TITLE|$MSG";
			}
		$sth->finish();

		if ($options{'filter'} ne 'homepage') {
			push @AR, "2010-06-07|html|articles/20100607.html|Zoovy Celebrates Ongoing Growth with Further Expansion at Their San Diego Office";
			push @AR, "2008-05-12|html|articles/20080512.html|Zoovy e-Commerce Technologies Forms Strategic Partnership with U-PIC Insurance Services";
			push @AR, "2008-04-05|html|articles/20080404.html|Zoovy, Inc. Increases Customer Conversion by Partnering With ControlScan";
			push @AR, "2008-04-05|html|articles/20080405.html|Zoovy Inc. Further Expands e-commerce Services by Providing Seamless Order Fulfillment Centers";
#			push @AR, "2008-03-13|html|articles/20080313.html|Zoovy Inc. Further Expands e-commerce Services by Providing Seamless Order Fulfillment Centers";
			push @AR, "2006-06-01|html|articles/20060601.html|Zoovy Inc. Websites are the First to Provide Worry Free Shopping with a Guarantee";
			push @AR, "2006-05-31|html|articles/20060531.html|buySAFE Solves Retail Websites' Number One Problem: Gaining Buyer Confidence";
			push @AR, "2006-04-06|html|articles/20060406.html|Zoovy, Inc.'s New Web 2.0/AJAX Based Software Boosts e-Ccommerce Sales";
			push @AR, "2006-03-14|html|articles/20060314.html|Zoovy, Inc. Releases New Order Manager 6.0";
			push @AR, "2006-02-22|html|articles/20060222.html|Zoovy, Inc. Launches JEDI Supply Chain Integration Function";
			push @AR, "2004-11-08|html|articles/20041108.html|Zoovy, Inc. Signs Strategic Partnership with buySAFE";
			push @AR, "2004-06-23|html|articles/20040623.html|Zoovy Named eBay Star Developer";
			push @AR, "2003-03-10|html|articles/20030310.html|Zoovy, Inc. is First Auction Management and e-Commerce Company to be Approved as UPS OnLine Tools Product Provider";
#			push @AR, "2003-01-13|html|articles/20030113.html|Zoovy, Inc. and AllDropShip.com Announce The Launch of a Revolutionary New eCommerce Marketplace";
			push @AR, "2003-01-07|html|articles/20030107.html|Zoovy, Inc. Integrates Online Business Management Solutions with Endicia Internet Postage";
			push @AR, "2002-12-17|html|articles/20021217.html|Zoovy, Inc. Enters into Strategic Alliance with eBay to Provide Online Merchants with Total Auction and Business Management Solutions";
			push @AR, "2002-12-09|html|articles/20021209.html|Zoovy, Inc. Announces Their Online Business Management Solutions Now Share Data with Intuit's QuickBooks 2003 Products";
#			push @AR, "2002-12-06|html|articles/20021206.html|Zoovy, Inc. and InterShopZone Announce Strategic Agreement";
#			push @AR, "2002-06-12|html|articles/20020612.html|Zoovy, Inc. and uBid Announce Strategic Agreement";
#			push @AR, "2002-02-25|html|articles/20020225.html|Zoovy Partners With ePier To Benefit Auction Community";
			push @AR, "2001-12-07|html|articles/20011207.html|300 Auction Templates Now Available at Zoovy";
#			push @AR, "2001-08-07|html|articles/20010807.html|Zoovy Gains 10,000 Small Business Customers for its E-Commerce System";
#			push @AR, "2001-07-26|html|articles/20010726.html|Zoovy Continues Growth; 10,000 Demos Strong";
			push @AR, "2001-06-06|html|articles/20010606.html|Zoovy Announces Availability Of E-Commerce Software That Enables Fast, Easy Online Sales For Small Businesses";
			push @AR, "2001-04-12|html|articles/20010412.html|The First Auction-Integrated Storefront to Track Inventory";
			push @AR, "2001-03-28|html|articles/20010328.html|Zoovy Integrates Western Union Moneyzap into Online Store and Auction Product";
			push @AR, "2001-01-17|html|articles/20010117.html|Zoovy Receives 1.5 Million in Venture Capital";
			}
	
		&DBINFO::db_zoovy_close();		
		$memd->set($MEMD_OBJECT_ID,\@AR);
		}
	
	return(@AR);
	}

if ($ARGS{'xml'}) {
	## return's content for the google sitemap
	my @AR = get_press();
	foreach my $info (@AR) {
		my ($date,$format,$link,$title) = split(/\|/,$info);
		$title =~ s/[\s\_]/+/g;
		$title =~ s/'//g;
		print "<url><loc>http://www.zoovy.com/$link?title=$title</loc><lastmod>$date</lastmod><changefreq>never</changefreq></url>\n";
		}
	}
</%perl>
