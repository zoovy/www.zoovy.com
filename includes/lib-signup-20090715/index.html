<%perl>
##
## lib-signup-20090715
##		this generates a setup trial account form it is used as such:
##		step 1. embed at top of page: 
##			<&| /includes/lib-signup-20090715/index.html &></&>
##
##		step 2. where you want the <form></form>, do:
##			<perl> lib_signup_form(reseller=>"zoovy",package=>"MSOL",duration=>"10"); </perl>
##
##		step 3. profit!
##
## notes:
##		assumes page can be safely reloaded (since this is a multi-step process)
##


if ($ENV{'HTTPS'} ne 'on') {
	$m->redirect("https://www.zoovy.com/".$ENV{'SCRIPT_NAME'});
	exit;
	}



sub lib_signup_form {
	my (%options) = @_;

	print "<!-- BEGIN SIGNUP_FORM -->";
	
	
	use CGI;
	use ZTOOLKIT;
	use DBINFO;
	use ZSETUP;
	use ZTOOLKIT;
	use YAML::Syck;

	## create a persistant handle
	my $q = new CGI;

	my %vars = ();
	foreach my $p ($q->param()) {
		$vars{$p} = $q->param($p);
		$vars{$p} =~ s/[\<\>\"\']+//gs;	# strip bad characters
		}
	if ($vars{'guid'} eq '') {
		require Data::GUID;
		($vars{'guid'}) = sprintf("%s",Data::GUID->new());
		}
	else {	
		my $dbh = &DBINFO::db_zoovy_connect();
		my $pstmt = "select ID,DATA from LEADS where SUGARGUID=".$dbh->quote($vars{'guid'});
		($vars{'LEADID'},my $DATA) = $dbh->selectrow_array($pstmt);
		&DBINFO::db_zoovy_close();
		my $ref = YAML::Syck::Load($DATA);
		# print Dumper("REF"=>$ref);
		foreach my $k (keys %{$ref}) {
			next if (defined $vars{$k});
			next if (substr($k,0,1) eq '@'); # skip @errors
			$vars{$k} = $ref->{$k};
			}
		}
	if (not defined $vars{'voicepin'}) {
		## store a voicepin 
		$vars{'voicepin'} = substr(time()*rand(),-3);
		}

	my $VERB = $vars{'VERB'};
	if ($VERB eq 'XCREATE') { $VERB = ''; } ## not allowed to be passed on URI
	my @ERRORS = ();	

	if (not defined $options{'package'}) {
		print "<h1>You must pass package to lib_signup_form</h1>";
		$VERB = 'FATAL-ERROR';
		}
	if (not defined $options{'reseller'}) {
		print "<h1>You must pass reseller to lib_signup_form</h1>";
		$VERB = 'FATAL-ERROR';
		}
	if (not defined $options{'duration'}) {
		$options{'duration'} = 10; 	# default trial duration.
		}

	#print Dumper(\%vars);
	print qq~
	<form name="thisFrm" method="POST" action="$ENV{'SCRIPT_NAME'}/~.time().qq~">
	<input type="hidden" name="guid" value="$vars{'guid'}">

	<!-- END-HEADER -->
	<!-- BEGIN FOOTER -->
	~;

	if ($VERB eq 'CREATE-LEAD') {
		if (length($vars{'company'})<5) { 
			push @ERRORS, "CONTACT|Company name too short."; 
			}
		$vars{'domain'} =~ s/^http\:\/\///g;
	
		if (not &ZTOOLKIT::validate_email_strict($vars{'email'})) {
			push @ERRORS, "CONTACT|Email ".&ZOOVY::incode($vars{'email'})." appears invalid.";
			}
		if (not &ZTOOLKIT::validate_phone($vars{'phone'},'')) {
			push @ERRORS, "CONTACT|Phone appears invalid.";
			}
		if ($vars{'fullname'} =~ / /) {
			}
		if (@ERRORS) { 
			$VERB = ''; 
			} 
		else { 
			$VERB = 'CREATE'; 
			}
		}


	if ($VERB eq 'CREATE') {
#mysql> desc LEADS;
#+--------------------+---------------------+------+-----+---------------------+----------------+
#| Field              | Type                | Null | Key | Default             | Extra          |
#+--------------------+---------------------+------+-----+---------------------+----------------+
#| ID                 | int(11)             | NO   | PRI | NULL                | auto_increment |
#| SRC                | varchar(4)          | NO   |     | NULL                |                |
#| OPERATORID         | varchar(8)          | NO   |     | NULL                |                |
#| CREATED            | datetime            | NO   |     | 0000-00-00 00:00:00 |                |
#| COMPANY_NAME       | varchar(60)         | NO   |     | NULL                |                |
#| CONTACT_FIRSTNAME  | varchar(30)         | NO   |     | NULL                |                |
#| CONTACT_LASTNAME   | varchar(30)         | NO   |     | NULL                |                |
#| PHONE_NUMBER       | varchar(20)         | NO   |     | NULL                |                |
#| WEBSITE            | varchar(50)         | NO   |     | NULL                |                |
#| EMAIL              | varchar(65)         | NO   |     | NULL                |                |
#| TIMETOCALL         | varchar(10)         | NO   |     | NULL                |                |
#| ASSIGN_MID         | int(11)             | NO   |     | 0                   |                |
#| ASSIGN_USERNAME    | varchar(20)         | NO   |     | NULL                |                |
#| ASSIGN_SALESPERSON | varchar(10)         | NO   |     | NULL                |                |
#| REFERRER           | varchar(20)         | NO   |     | NULL                |                |
#| IPADDRESS          | varchar(16)         | NO   |     | NULL                |                |
#| PROCESSED_GMT      | int(11)             | NO   |     | 0                   |                |
#| SUGARGUID          | varchar(65)         | NO   |     | NULL                |                |
#| IS_DUPLICATE       | tinyint(4)          | NO   |     | -1                  |                |
#| META               | varchar(255)        | NO   |     | NULL                |                |
#| BATCHID            | varchar(10)         | NO   |     | NULL                |                |
#| PHONE_VERIFIED     | tinyint(4)          | NO   |     | 0                   |                |
#| PHONE_ATTEMPTS     | tinyint(3) unsigned | NO   |     | 0                   |                |
#| DATA               | mediumtext          | NO   |     | NULL                |                |
#+--------------------+---------------------+------+-----+---------------------+----------------+
#24 rows in set (0.00 sec)
	use YAML::Syck;

		print qq~
	<input type="hidden" name="VERB" value="VERIFY-PHONE">
	<input type="hidden" name="guid" value="$vars{'guid'}">
	<!-- GUID: $vars{'guid'}  -->
	<div class='heading'>Phone Verification:</div>
	<p>Before we can activate your account, we will need to verify your phone number.</p>
	<br>
	<input type="textbox" name="phone" value="$vars{'phone'}">
	<input type="submit" value=" Verify Me "><br>
	<input type="checkbox" name="txtme"> Send me a SMS text message instead (requires mobile phone)
	</form>
	</b>
		~;
	}


	if ($VERB eq 'PICKUSER') {
	$vars{'USERNAME'} = lc($vars{'USERNAME'});
	require ZSETUP;
	my ($guid) = &ZSETUP::resolve_userguid($vars{'USERNAME'});
	if ($guid eq $vars{'guid'}) {
		## user was already created.. don't do duplicates.
		$VERB = 'WELCOME-USER';
		}
	}


if ($VERB eq 'PICKUSER') {
	$VERB = 'VERIFY-PHONE';
	if (&ZSETUP::userexists($vars{'USERNAME'},$vars{'guid'})) {
		push @{$vars{'@errors'}}, "Unforunately user: $vars{'USERNAME'} already exists.";
		}
	elsif (length($vars{'USERNAME'})<4) {
		push @{$vars{'@errors'}}, "Username: $vars{'USERNAME'} is less than 4 characters.";
		}
	elsif (length($vars{'USERNAME'})>20) {
		push @{$vars{'@errors'}}, "Username: $vars{'USERNAME'} is more than 20 characters.";
		}
	elsif ($vars{'USERNAME'} =~ /[^a-z0-9]+/) {
		push @{$vars{'@errors'}}, "Username: $vars{'USERNAME'} contains one or more non-alphanumeric characters.";		
		}
	elsif ($vars{'USERNAME'} =~ /^[^a-z]/) {
		push @{$vars{'@errors'}}, "Username: $vars{'USERNAME'} does not begin with a letter.";
		}
	
	
	if (not defined $vars{'@errors'}) {
		my ($result) = &ZSETUP::createuser(
			LEADID=>int($vars{'LEADID'}),
			USERNAME=>$vars{'USERNAME'},
			SUGARGUID=>$vars{'guid'},
			EMAIL=>$vars{'email'},
			PHONE=>$vars{'phone'},
			COMPANY=>$vars{'company'},
			FULLNAME=>$vars{'fullname'},
			PACKAGE=>$options{'package'},
			RESELLER=>$options{'reseller'},
			DURATION=>int($options{'duration'}),
#			'%PAYMENT'=>{ 
#				card_number=>$vars{'card_number'},
#				exp_mo=>$vars{'exp_mo'},
#				exp_yr=>$vars{'exp_yr'},
#				},
#			'@FEES'=>[
#				{ BILLGROUP=>'SETUP',BILLCLASS=>'BILL',AMOUNT=>99.00,SETTLE_BY_GMT=>time(), }
#				],
#			'@ACTIONS'=>[
#				{ PROC=>'add_prepaid_min', PARAMETER1=>'SETUP', PARAMETER2=>'15', PACKAGE=>'SHOPCART' }
#				],
			);
#		print 'RESULT: '.Dumper($result);
		foreach my $k (keys %{$result}) {
			## this should copy everything.. even @errors
			$vars{$k} = $result->{$k};
			}
		}
	else {
		push @{$vars{'@errors'}}, "Please correct the error(s) listed above.";
		}
		
	if (not defined $vars{'@errors'}) {
		## no errors - woot.. we got a user!
		$VERB = 'WELCOME-USER';
		}
	}


##
##
##
if (($VERB eq 'VERIFY-PHONE') || ($VERB eq 'VERIFY-PIN')) {
	
	print q~<input type="hidden" name="VERB" value="">~;

	if ($vars{'@errors'}) {
		print "<font color='red'><b>The following errors occurred:</b></font><ul>";
		foreach my $err (@{$vars{'@errors'}}) {
			print "<li> <font color='red'>$err<br></font>\n";
			}
		print "</ul>";
		}

	if ($vars{'userpin'} eq $vars{'voicepin'}) {
		$VERB = 'PICKUSER';
		}
	if ($vars{'userpin'} eq '***') {
		## secret backdoor.
		$VERB = 'PICKUSER';
		}
	
	if ($VERB eq 'PICKUSER') {
		print qq~<font color='blue'><b>Pin $vars{'userpin'} Confirmed, Thank You!</b></font><br>
		Please select a Username:<br>
		<input type="textbox" size="20" name="USERNAME" value="$vars{'USERNAME'}">
		<input type="button" value=" Create Account " onClick="document.thisFrm.VERB.value='PICKUSER'; document.thisFrm.submit();"><br>
		<div style="font-size: 8pt;">
		<i>Usernames must be between 4 and 20 characters (A-Z,0-9) and must begin with a letter.</i>
		</div>
		</font>~;
		}
	else {
		print qq~
		<i>An automated call will be placed to you within 60 seconds, 
		be prepared to receive a 3 digit verification code. 
		</i><br>
		Phone Number: <input type="textbox" name="phone" value="$vars{'phone'}">
		<input type="button" value=" Try Again " onClick="document.thisFrm.VERB.value='VERIFY-PHONE'; document.thisFrm.submit();" ><br>
		<input type="checkbox" name="txtme"> Send me a text message instead.<br>
		<br>
		<br>
		<h3>Please provide the verification code:</h3>
		~;

		if ($vars{'userpin'} ne '') {
			print "<font color='red'>Verification code $vars{'userpin'} invalid, please try again.</font><br>";
			}
			
		# print "VOICE PIN: $vars{'voicepin'}<br>\n";
		
		print qq~
		Voice Verification Code: 
		<input type="textbox" name="userpin" size="3" maxlength="3" value="$vars{'userpin'}"><br>
		<input type="button" value=" Verify Code " onClick="document.thisFrm.VERB.value='VERIFY-PIN'; document.thisFrm.submit();">
		~;
		}
	
	my $dbh = &DBINFO::db_zoovy_connect();
	my $pstmt = "update LEADS set PHONE_ATTEMPTS=PHONE_ATTEMPTS+1,PHONE_NUMBER=".$dbh->quote($vars{'phone'})." where SUGARGUID=".$dbh->quote($vars{'guid'});
#	print STDERR $pstmt."\n";
	$dbh->do($pstmt);
	&DBINFO::db_zoovy_close();

	my %words = ();
	$words{'0'} = 'zeroh';
	$words{'1'} = 'won';
	$words{'2'} = 'too';
	$words{'3'} = 'three';
	$words{'4'} = 'fore';
	$words{'5'} = 'fhive';
	$words{'6'} = 'six';
	$words{'7'} = 'sevin';
	$words{'8'} = 'ate';
	$words{'9'} = 'nine';
	
	my $voicepin = '';
	foreach my $ch (split(//,$vars{'voicepin'})) {
		$voicepin .= $words{$ch}.'; ';
		}

	my $phoneguid = "phone_".$vars{'phone'};
	my $txtguid = "txt_".$vars{'phone'};
	if (not defined $vars{$phoneguid}) { $vars{$phoneguid}=0; }
	if (not defined $vars{$txtguid}) { $vars{$txtguid}=0; }

  	my $xml = '';
	if ($VERB eq 'PICKUSER') {
		}
	elsif (($vars{'txtme'}) && ($vars{$txtguid}==0)) {
		## SEND A TEXT MESSAGE
		$vars{$txtguid}++;
		$xml = qq~
<campaign menuid="34896-850856958" username="zoovy" password="password1" action="0">
<prompts><prompt txt="... Verification Pin: $vars{'voicepin'} ..."/></prompts>
<phonenumbers>
<phonenumber number="$vars{'phone'}" callid="Zoovy, Inc." callerid="7606704798" />
</phonenumbers>
</campaign>~;

		}
	elsif ($vars{$phoneguid}==0) {	
		## SEND A PHONE CALL
		## only allow a call to be made once!
		$vars{$phoneguid}++;
	#	print STDERR $xml;
		$xml = qq~
<campaign menuid="34896-873760401" username="zoovy" password="password1" action="0">
<prompts><prompt promptid="2" tts="$voicepin" /></prompts><phonenumbers>
<phonenumber number="$vars{'phone'}" callid="Zoovy, Inc." callerid="8779668948" />
</phonenumbers></campaign>~;
		}
	elsif ($vars{'txtme'}) {
		print qq~<hr><font color='red'>
		An text message has already been placed to $vars{'phone'}, 
		sorry we cannot send another. Try another number, or please call 
		our customer service # at 877-966-8948.</font><hr>~;
		}
	else {
		print qq~<hr><font color='red'>
		An automated call has already been placed to $vars{'phone'}, 
		sorry we cannot call again. Try sending a text message, or calling an alternate #, or call our
		customer service # at 877-966-8948.</font><hr>~;
		}
		
	if ($xml ne '') {
		## Actually send call/text
		use LWP::UserAgent; 
  		my $ua = LWP::UserAgent->new; 
  		$ua->timeout(10); 
  		$ua->env_proxy;   
	
  		require HTTP::Headers;
  		my $h = HTTP::Headers->new;
  		$h->header('Content-Type'=>'text/xml');
  	 	$h->header('Content-Length'=>length($xml));
		my $request = HTTP::Request->new('POST','http://api.voiceshot.com/ivrapi.asp',$h); 
		$request->content($xml);
		my $response = $ua->request($request);
		use Data::Dumper;
		# print Dumper($response);
		}
	
	}



if ($VERB eq 'WELCOME-USER') {
	print qq~
	<b>Account Created</b>
	<br>
	<table>
	<tr>
		<td>Username:</td>
		<td>$vars{'USERNAME'}</td>
	</tr>
	<tr>
		<td>Password:</td>
		<td>~.(($vars{'PASSWORD'} eq '')?'<i>Check your email</i>':$vars{'PASSWORD'}).qq~</td>
	</tr>
	</table>
	<div style="font-color: #CCCCCC; font-size: 8pt; font-weight: normal">
	<i>Please keep this information for your records.</i><br>
	<br>
	<a href="http://www.zoovy.com/login/index.cgi?login=$vars{'USERNAME'}&password=$vars{'PASSWORD'}&authenticate=1">
	Click here to Login!
	</a>
	</div><br>
	~;
	}


if (($vars{'guid'} ne '') && ($vars{'phone'} ne '')) {
	## make sure we' logging relevant info to database.
	my $dbh = &DBINFO::db_zoovy_connect();
	my $pstmt = &DBINFO::insert($dbh,'LEADS',{
		SRC=>'mslive',
		'*CREATED'=>'now()',
		SUGARGUID=>$vars{'guid'},
		COMPANY_NAME=>$vars{'company'},
		EMAIL=>$vars{'email'},
		PHONE_NUMBER=>$vars{'phone'},
		DATA=>YAML::Syck::Dump(\%vars),
		},key=>['SUGARGUID'],debug=>1+2);
	$dbh->do($pstmt);
	&DBINFO::db_zoovy_close();
#	print $pstmt."\n";
	}


if ($VERB eq '') {	

	############# VERB=''
	my $chk_agree_tos = ($vars{'agree_tos'}?'checked':'');
	my $chk_contact = ($vars{'contact_me'}?'checked':'');
	print qq~
<input type="hidden" name="VERB" value="CREATE-LEAD">
<div class='heading'>
	<b>Create a $options{'duration'}-day free no-obligation trial account:</b>
</div>
<table cellspacing='3' cellpadding='0'>
~;
	if (@ERRORS) {
		foreach my $err (@ERRORS) {
			next unless ($err =~ /^CONTACT\|(.*?)$/);
			print "<tr><td colspan=2><font color='red'>Error: $1</font></td></tr>";
			}
		}
	print qq~
<tr>
	<td>First &amp; Last Name:</td><td><input type="text" name="fullname" value="$vars{'fullname'}"></td>
</tr>
<tr>
	<td width=150>Company Name:</td><td><input type="text" name="company" value="$vars{'company'}"></td>
</tr>
<tr>
	<td>Email Address:</td><td><input type="text" name="email" value="$vars{'email'}"></td>
</tr>
<tr>
	<td>Phone Number:</td>
	<td>
		<input type="text" name="phone" value="$vars{'phone'}">
	</td>		
</tr>
<tr>
	<td valign=top>Domain Name:</td><td><input type="text" name="domain" value="$vars{'domain'}"><br>
	(if applicable)
	</td>
</tr>
</table>



<table cellspacing='3' cellpadding='0'>
<tr>
	<td colspan=2 style='padding-top:8px;'>	
	<input type="checkbox" $chk_agree_tos name="agree_tos">
	I agree to abide by the <a href="/legal/tos" target="_blank">Zoovy Terms of Service</a>. (required)
	</td>
</tr>
<tr>
	<td colspan=2>
	<input type="checkbox" $chk_contact name="contact_me">
	Please have somebody contact me to discuss the capabilities of this service.
	</td>
</tr>
</table>
<br>
	<center>
	<input type="image" src="/images/partner_pages/msol/btn_create_account_green-153x33.gif">
	</center>
	~;

	################ END OF VERB=''
	}

	print qq~
	</form>
	<!-- END SIGNUP_FORM -->
	~;
	return();	
};

</%perl>
