#!/usr/bin/perl

use strict;
use Data::Dumper;
use lib "/httpd/modules";
use ZOOVY;
use GTOOLS;
use CALLCENTER;
use CGI;
use ORDER;
use CUSTOMER;
use CART;
use SITE::MSGS;
use ORDER::VIEW;

my ($q) = CGI->new();
$SITE::v = {};
foreach my $v ($q->param()) {
	$SITE::v->{$v} = $q->param($v);
	}

# print STDERR Dumper($SITE::v);

my @MSGS = ();
my $key = $SITE::v->{'key'};
my ($USERNAME,$PRT,$GUID) = split(/\./,$key);
my $DOMAIN = "$USERNAME.zoovy.com";

$USERNAME =~ s/[^\w]+//gs;
$PRT =~ s/[^\d]+//gs;
$GUID =~ s/[^\w\-]+//gs; 

my $VERB = $SITE::v->{'VERB'};

my $template_file = '';
my $PAGE_TITLE = '';

$SITE::CART = undef;
my $CARTID = $SITE::v->{'CARTID'};
if (defined $CARTID) {
	($SITE::CART) = CART->new($USERNAME,$CARTID);
	}

my ($webdbref) = &ZWEBSITE::fetch_website_dbref($USERNAME,$PRT);
my $CFG = $webdbref->{'%callcenter'};

if (not defined $CFG) { $VERB = 'DENIED'; push @MSGS, "ERROR|No configuration defined for this partition"; }
elsif ($CFG->{'enabled'}<1) { $VERB = 'DENIED'; push @MSGS, "ERROR|Call center functionality not enabled"; }
elsif ($CFG->{'guid'} ne $GUID) { $VERB = 'DENIED'; push @MSGS, "ERROR|Access Denied: GUID/Token not valid."; }
else {
	$GTOOLS::TAG{'<!-- KEY -->'} = &ZOOVY::incode($key);
	}


if ($VERB ne 'DENIED') {
	## now lets try an establish authentication.
	my $ACCESS_GRANTED = 0;
	if ($CFG->{'public'}) {
		$ACCESS_GRANTED++;		
		}
	if ($CFG->{'private'}) {
		$ACCESS_GRANTED++;
		}
	if (not $ACCESS_GRANTED) {
		$VERB = 'DENIED';
		}
	}


$SITE::MSGS = undef;
if ($VERB eq 'DENIED') {
	$GTOOLS::TAG{'<!-- USERNAME -->'} = &ZOOVY::incode($USERNAME);
	$GTOOLS::TAG{'<!-- PRT -->'} = &ZOOVY::incode($PRT);
	$GTOOLS::TAG{'<!-- GUID -->'} = &ZOOVY::incode($GUID);
	$template_file = 'denied.shtml';
	$PAGE_TITLE = 'ACCESS DENIED';
	}
else {
	$SITE::MSGS = SITE::MSGS->new($USERNAME,PRT=>$PRT);
	}


if ($VERB eq 'FINDCART-NEXT') {
	my $CARTID = $SITE::v->{'CARTID'};
	}


if ($VERB eq 'CREATEORDER-ADD') {
	my @errors = ();
	require STUFF::CGI;
	my @items = &STUFF::CGI::parse_products($USERNAME,$SITE::v,0,\@errors);

	if (scalar(@items)==0) {
		push @errors, "No items could be added.";
		}
	foreach my $item (@items) {
		next if ($item->{'qty'}<=0); # if we dont' do this then certain items which have no price will throw errrs.
												# when sent from a multi-item prodlist.
		my ($err, $message) = $SITE::CART->cart_add_stuff($item,1);	 
		if (defined($message) && ($message ne '')) {
			push @errors, "$message";
			}
		else {
			push @errors, "ERR:$err MSG:$message\n";
			}
		}

	$SITE::CART->save();
	$GTOOLS::TAG{'<!-- ERRORS -->'} = '<div color="red">'.join("<br>",@errors).'</div>';
	$VERB = 'CREATEORDER';
	}

#	if (defined $v->{'couponcode'}) {
#		$SITE::CART->add_coupon($v->{'couponcode'},\@errors);
#		}
#
#	if (defined $v->{'giftcardcode'}) {
#		## first thing we need to do is figure out
#		$SITE::CART->add_giftcard($v->{'giftcardcode'},\@errors);
#		}

if ($VERB eq 'CREATEORDER-DELETE') {
	my $stid = $SITE::v->{'VAR'};
	$SITE::CART->delete($stid);
	$VERB = 'CREATEORDER';
	}

if ($VERB eq 'CREATEORDER-SEARCH') {
	my $c = '';
	my $SEARCHTXT = $q->param('SEARCHTXT');
	require SEARCH;
	my ($outref,$prodsref) = &SEARCH::search($USERNAME,'KEYWORDS'=>$SEARCHTXT,'PRT'=>$PRT,'speed'=>1);
	if (not defined $prodsref) {
		$prodsref = &ZOOVY::fetchproducts_into_hashref($USERNAME,$outref);
		}
	my @SKU = ();

	$c .= "<tr><td colspan=5>SEARCH RESULTS FOR: $SEARCHTXT</td></tr>";
	my $row = '';
	foreach my $pid (@{$outref}) {
		$row = ($row eq 'r0')?'r1':'r0';
		my $prodref = $prodsref->{$pid};
		$c .= sprintf(qq~
<tr class="$row">
	<td>
		<a target="_blank" href="http://$DOMAIN/product/$pid">VIEW</a> | 
		<a href="index.cgi?VERB=CREATEORDER-ADD&quantity=1&product_id=$pid&CARTID=$CARTID&key=$key">ADD</a> 
	</td>
	<td>$pid</td>
	<td>%s</td>
	<td>\$%.2f</td>
</tr>~
	,$prodref->{'zoovy:prod_name'},$prodref->{'zoovy:base_price'});
		}

	$GTOOLS::TAG{'<!-- SEARCH_RESULTS -->'} = "<pre>$c</pre>";
	$VERB = 'CREATEORDER';
	}




if (($VERB eq 'CREATEORDER-SAVE') || ($VERB eq 'CREATEORDER-FINISHED')) {
	tie my %chash, 'CART', CART=>$SITE::CART;

	foreach my $field ('payby','order_notes','ship.selected_id') {
		$chash{'chkout.'.$field} = $SITE::v->{$field};
		}

	if ($SITE::v->{'shipmethod'} ne '') {
		$SITE::CART->set_shipmethod($SITE::v->{'shipmethod'});
		}

	$chash{'chkout.bill_to_ship'} = (defined $SITE::v->{'bill_to_ship'})?1:0;
	foreach my $type ('bill','ship') {
		foreach my $field ('firstname','lastname','company','address1','address2','city','state','zip','country','phone','email','province') {
			$chash{'data.'.$type.'_'.$field} = $SITE::v->{$type.'_'.$field};

			if (($type eq 'ship') && ($chash{'chkout.bill_to_ship'})) {
				$chash{'data.bill_'.$field} = $chash{'data.ship_'.$field};
				}
			}
		}

	my %payment = ();
	foreach my $var ('CC','YY','MM','CV','PO') {
		next if (not defined $SITE::v->{$var});
		$payment{$var} = $SITE::v->{$var};
		}

	my @ISSUES = ();
	if ($VERB eq 'CREATEORDER-FINISHED') {
		## more field verification
		(my $validation_issues) = $SITE::CART->verify_checkout('CALLCENTER',$webdbref);
		foreach my $issue (@{$validation_issues}) {
			push @ISSUES, $issue;
			}

		my ($payment_issues) = $SITE::CART->verify_payment(\%payment,$webdbref);
		foreach my $issue (@{$payment_issues}) {
			push @ISSUES, $issue;
			}
		if (scalar(@ISSUES)>0) {
			$VERB = 'CREATE_ORDER';
			foreach my $issue (@ISSUES) {
				$GTOOLS::TAG{'<!-- CHECKOUT_ISSUES -->'} .= "<div class=\"alert\">ERROR: $issue</div>";
				}
			}
		}


	if ($VERB eq 'CREATEORDER-FINISHED') {
		require CHECKOUT;
		require ZWEBSITE;
		## NOTE: Eventually might want to do something with SREF

		$SITE::merchant_id = $USERNAME;
		my ($webdbref) = &ZWEBSITE::fetch_website_dbref($USERNAME);
		my ($orderid,$pay_success,$o,$ERROR) = CHECKOUT::finalize($SITE::CART,'webdb'=>$webdbref,'payment_cgi_vars'=>\%payment);
		$SITE::v->{'orderid'} = $orderid;
		$GTOOLS::TAG{'<!-- ORDERID -->'} = $orderid;
		$VERB = 'CREATEORDER-SUCCESS';
		$GTOOLS::TAG{'<!-- HEADER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_ordercreated_msg'));
		$template_file = 'ordercreated.shtml';
		$SITE::CART->nuke();
		}
	else {
		$SITE::CART->save();
		$VERB = 'CREATEORDER';
		}

	untie %chash;
	}




##
##
##
if ($VERB eq 'CREATEORDER') {
	$template_file = 'createorder.shtml';

	$GTOOLS::TAG{'<!-- HEADER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_createorder_header_msg'));
	$GTOOLS::TAG{'<!-- PAYMENT_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_createorder_payment_msg'));
	$GTOOLS::TAG{'<!-- SHIPPING_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_createorder_shipping_msg'));
	$GTOOLS::TAG{'<!-- FOOTER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_createorder_footer_msg'));
	
	if (not defined $SITE::CART) { $SITE::CART = CART->new($USERNAME,'prt'=>$PRT); }

	require SITE::URLS;
	require ZPAY;

	$SITE::URL = SITE::URLS->new($USERNAME);
	my ($html) = ORDER::VIEW::as_html($SITE::CART->as_tmp_order(),'CALLCENTER',undef,undef,undef);
	$GTOOLS::TAG{'<!-- CARTVIEW -->'} = $html;

	$CARTID = $SITE::CART->id();
	$GTOOLS::TAG{'<!-- CARTID -->'} = $CARTID;	

	tie my %chash, 'CART', CART=>$SITE::CART;

	foreach my $type ('bill','ship') {
		foreach my $field ('firstname','lastname','company','address1','address2','city','state','zip','country','phone','email','province') {
			$GTOOLS::TAG{uc('<!-- '.$type.'_'.$field.' -->')} = $chash{'data.'.$type.'_'.$field};
			}
		}

	$GTOOLS::TAG{'<!-- CB_BILL_TO_SHIP -->'} = ($chash{'chkout.bill_to_ship'})?'checked':'';

	$GTOOLS::TAG{'<!-- ORDER_NOTES -->'} = &ZOOVY::incode($chash{'chkout.order_notes'});

	my $c = '';
	my ($payref) = &ZPAY::payment_methods($USERNAME, cart=>$SITE::CART, country=>$chash{'bill_country'}, webdb=>$webdbref);
	my $r = 'r0';
	foreach my $ref (@{$payref}) {
		next if ($ref->{'id'} eq 'CHKOD');
		next if ($ref->{'id'} eq 'COD');
		next if ($ref->{'id'} eq 'WIRE');
		next if ($ref->{'id'} eq 'ECHECK');
		$r = ($r eq 'r0')?'r1':'r0';

		$c .= "<tr class=\"$r\"><td><input ".(($chash{'chkout.payby'} eq $ref->{'id'})?'checked':'')." type=\"radio\" name=\"payby\" value='$ref->{'id'}'></td><td><b>$ref->{'id'}</b></td></tr>";

		if ($ref->{'id'} eq "PO") {
			$c .= "<tr class=\"$r\"><td></td><td>PO Number: <input type='textbox' name='PO' value=\"".&ZOOVY::incode($SITE::v->{'PO'})."\"></td></tr>";
			}
  
		if ($ref->{'id'} eq "CREDIT") {
			$c .= "<tr class=\"$r\"><td></td><td><table width='618'>";
			$c .= "<tr><td>Card Number:</td><td><input type='textbox' name='CC' value='".&ZOOVY::incode($SITE::v->{'CC'})."'></td></tr>";
			$c .= "<tr><td>Expires:</td><td>mo: <input maxlength='2' size ='2' type='textbox' name='MM' value='".&ZOOVY::incode($SITE::v->{'MM'})."'> / ";
			$c .= "yy:<input maxlength='2' type='textbox' size='2' name='YY' value='".&ZOOVY::incode($SITE::v->{'YY'})."'></td></tr>";
			$c .= "<tr><td>CCVCID:</td><td><input type='textbox' size='4' name='CV' value='".&ZOOVY::incode($SITE::v->{'CV'})."'><br></td></tr>"; 
			$c .= "</table></td></tr>";
			}

#		if ($ref->{'id'} eq "ECHECK") {
#			$c .= "<tr class=\"$r\"><td></td><td><table align='center'>";
#			$c .= "<tr><td align='right'>Name on Account:</td><td><input type='textbox' name='echeck_acct_name' value=\"".$chash{'data.echeck_acct_name'}."\"></td></tr>";
#			$c .= "<tr><td align='right'>Bank Name:</td><td><input maxlength='50' size ='30' type='textbox' name='echeck_bank_name' value=\"".$chash{'data.echeck_bank_name'}."\"></td></tr>";
#			$c .= "<tr><td align='right'>ABA / Routing Number:</td><td><img src=\"/images/orders/mirc1.gif\" border=\"0\" width=\"14\" height=\"14\"><input maxlength='9' size ='9' type='textbox' name='echeck_aba_number' value=\"".$chash{'data.echeck_aba_number'}."\"><img src=\"/images/orders/mirc1.gif\" border=\"0\" width=\"14\" height=\"14\"></td></tr>";
#			$c .= "<tr><td align='right'>Account Number:</td><td><input maxlength='20' size ='20' type='textbox' name='echeck_acct_number' value=\"".$chash{'data.echeck_acct_number'}."\"><img src=\"/images/orders/mirc2.gif\" border=\"0\" width=\"14\" height=\"14\"></td></tr>";
#			$c .= "<tr><td align='right'>Check Number:</td><td><input type='textbox' name='echeck_check_number' value=\"".$chash{'data.echeck_check_number'}."\"></td></tr>";
#			$c .= "</table></td></tr>";
#			}
		}
	$GTOOLS::TAG{"<!-- PAYMENT_METHODS -->"} = $c;


	if ($chash{'ship.selected_id'} eq '') { 
		## default $chash{'ship.selected_method'} so we don't need to refresh on INVOICE_DISPLAY if they like the defaults
		}

	my $ship_options = '';	
	$ship_options .= qq~<table border="0" cellpadding="0" cellspacing="0" align="center">\n~;
	my $i = 0;
	foreach my $shipmethod (@{$SITE::CART->shipmethods()}) {
		my $checked = '';
		if ($shipmethod->{'id'} eq $chash{'ship.selected_id'}) { $checked = ' checked'; }
		my $sprice = &ZTOOLKIT::moneyformat($shipmethod->{'amount'});
		$ship_options .= qq~
			<tr>
				<td align="left"><font class="ztxt"><input class="zradio" type="radio" name="shipmethod" value="$shipmethod->{'id'}" $checked> $shipmethod->{'name'}&nbsp;&nbsp;&nbsp;&nbsp;</font></td>
					<td align="right"><font class="ztxt">$sprice</font></td>
				</tr>
			~;
		$i++;
		}
	if ($i==0) {
		$ship_options .= "<i>ERR: no shipping available</i>";
		}
	$ship_options .= qq~</table>\n~;
	$GTOOLS::TAG{'<!-- SHIPPING_METHODS -->'} = $ship_options;

	untie %chash;
	}


##
## NOT IMPLEMENTED YET!
##
if ($VERB eq 'FINDCART') {
	## Place an order
	my ($callar) = &CALLCENTER::listRequests($USERNAME,TYPE=>'CALL',PROFILE=>$PRT,PENDING=>1);
	my $c = '';
	if (defined $callar) {
		foreach my $callref (@{$callar}) {
			$c .= "<tr><td>$callref->{'ID'}</td><td>".&ZTOOLKIT::pretty_date($callref->{'CREATED_GMT'},1)."</td></tr>";
			}
		}
	if ($c eq '') { $c = "<tr><td colspan=2>There are no pending calls.</td></tr>"; }
	$GTOOLS::TAG{"<!-- CALLS -->"} = $c; 	$template_file = 'findcart.shtml';
	}



if ($VERB eq '') {
	$template_file = 'index.shtml';
	}






##
## if we do a FINDORDER-ORDER then we go directly to EDITORDER 
##		(instead of showing possible matches)
##
if ($VERB eq 'FINDORDER-ORDER') {
	my $ORDERID = $q->param('order');
	my ($o) = ORDER->new($USERNAME,$ORDERID);
	if (defined $o) {
		$VERB = 'EDITORDER';
		}
	}


if ($VERB eq 'RETURNS') {
	$template_file = 'returns.shtml';
	}




##
## EDITORDER
##
if ($VERB =~ /^EDITORDER(.*?)$/) {
	my $METHOD = $1;
	my $ORDERID = $SITE::v->{'order'};
	$GTOOLS::TAG{'<!-- ORDERID -->'} = $ORDERID;	

	require ZPAY;
	my ($o) = ORDER->new($USERNAME,$ORDERID);

	my $ORDERREF = $o->attribs();
	if ($METHOD eq '-UPDATENOTES') {
		$ORDERREF->{'order_notes'} = $SITE::v->{'order_notes'};
		$o->save();
		}

	if ($METHOD eq '-UPDATECC') {
		## update the credit card #
		foreach my $field ('card_number','card_exp_month','card_exp_year','cvvcid_number') {
			$ORDERREF->{ $field } = $SITE::v->{ $field };
			$ORDERREF->{ $field } =~ s/[^\d]+//gs;	# all these fields should only have numbers.
			}

		my ($err) = &ZPAY::verify_credit_card( $ORDERREF->{'card_number'}, $ORDERREF->{'card_exp_month'}, $ORDERREF->{'card_exp_year'}, $ORDERREF->{'cvvcid_number'});
		if ($err eq '') {
			## Automatically attempt to reprocess card.	
			my ($success,$message) = $o->payment('CHARGE');
			}
		else {
			## ZPAY::cc_charge will automatically save the order!
			$o->save();
			}
		}


	if ($ORDERREF->{'payment_status'} =~ /^0/) {
		$GTOOLS::TAG{'<!-- PAID -->'} = &ZTOOLKIT::pretty_date($ORDERREF->{'paid_date'});	
		$GTOOLS::TAG{'<!-- PAYMENT_METHOD -->'} = $ORDERREF->{'payby'};
		}
	else {
		$GTOOLS::TAG{'<!-- PAID -->'} = ' ** UNPAID ** ';
		}

	$GTOOLS::TAG{'<!-- CREATED -->'} = &ZTOOLKIT::pretty_date($ORDERREF->{'created_gmt'});
	if ($ORDERREF->{'ship_country'} eq 'United States') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'ship_country'} eq 'USA') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'ship_country'} eq 'US') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'United States') { $ORDERREF->{'bill_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'USA') { $ORDERREF->{'bill_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'US') { $ORDERREF->{'bill_country'} = ''; }

	# $GTOOLS::TAG{"<!-- SHIP_NAME -->"} = ($ORDERREF->{"ship_fullname"})?($ORDERREF->{"ship_fullname"}):($ORDERREF->{"ship_firstname"}." ".$ORDERREF->{"ship_lastname"});
	$GTOOLS::TAG{"<!-- SHIP_NAME -->"} = $ORDERREF->{"ship_firstname"}." ".$ORDERREF->{"ship_lastname"};	
   $GTOOLS::TAG{"<!-- SHIP_COMPANY -->"} = ($ORDERREF->{"ship_company"})?($ORDERREF->{"ship_company"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_ADDRESS1 -->"} = ($ORDERREF->{"ship_address1"})?($ORDERREF->{"ship_address1"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_ADDRESS2 -->"} = ($ORDERREF->{"ship_address2"})?($ORDERREF->{"ship_address2"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_CITY -->"} = ($ORDERREF->{"ship_city"})?($ORDERREF->{"ship_city"}.", "):"";
   $GTOOLS::TAG{"<!-- SHIP_STATE -->"} = ($ORDERREF->{"ship_state"})?($ORDERREF->{"ship_state"}." "):"";

   if ($ORDERREF->{"ship_country"} eq '')
		{ $GTOOLS::TAG{"<!-- SHIP_ZIP -->"} = ($ORDERREF->{"ship_zip"})?($ORDERREF->{"ship_zip"}." "):""; }
	else { $GTOOLS::TAG{'<!-- SHIP_ZIP -->'} = $ORDERREF->{'ship_province'}.', '.$ORDERREF->{"ship_int_zip"}.'<br>'.$ORDERREF->{'ship_country'}; }

   $GTOOLS::TAG{"<!-- SHIP_PHONE -->"} = ($ORDERREF->{"ship_phone"})?($ORDERREF->{"ship_phone"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_EMAIL -->"} = ($ORDERREF->{"ship_email"});	

	# $GTOOLS::TAG{"<!-- BILL_NAME -->"} = ($ORDERREF->{"bill_fullname"})?($ORDERREF->{"bill_fullname"}):($ORDERREF->{"bill_firstname"}." ".$ORDERREF->{"bill_lastname"});
	$GTOOLS::TAG{"<!-- BILL_NAME -->"} = $ORDERREF->{"bill_firstname"}." ".$ORDERREF->{"bill_lastname"};	
   $GTOOLS::TAG{"<!-- BILL_COMPANY -->"} = ($ORDERREF->{"bill_company"})?($ORDERREF->{"bill_company"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_ADDRESS1 -->"} = ($ORDERREF->{"bill_address1"})?($ORDERREF->{"bill_address1"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_ADDRESS2 -->"} = ($ORDERREF->{"bill_address2"})?($ORDERREF->{"bill_address2"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_CITY -->"} = ($ORDERREF->{"bill_city"})?($ORDERREF->{"bill_city"}.", "):"";
   $GTOOLS::TAG{"<!-- BILL_STATE -->"} = ($ORDERREF->{"bill_state"})?($ORDERREF->{"bill_state"}." "):"";

   if ($ORDERREF->{"bill_country"} eq '')
		{ $GTOOLS::TAG{"<!-- BILL_ZIP -->"} = ($ORDERREF->{"bill_zip"})?($ORDERREF->{"bill_zip"}." "):""; }
	else { $GTOOLS::TAG{'<!-- BILL_ZIP -->'} = $ORDERREF->{'bill_province'}.', '.$ORDERREF->{"bill_int_zip"}.'<br>'.$ORDERREF->{'bill_country'}; }

   $GTOOLS::TAG{"<!-- BILL_PHONE -->"} = ($ORDERREF->{"bill_phone"})?($ORDERREF->{"bill_phone"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_EMAIL -->"} = ($ORDERREF->{"bill_email"});	

	#if (&CUSTOMER::customer_exists($USERNAME,$ORDERREF->{'bill_email'})) {		
	#	$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = "<a>Edit Customer Account</a>";
	#	}

	$GTOOLS::TAG{'<!-- ORDER_NOTES -->'} = &ZOOVY::incode($ORDERREF->{'order_notes'});

	if ($ORDERREF->{'payby'} eq 'PAYPAL') {
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} = qq~
		<tr><td><br>Paypal Account: $ORDERREF->{'paypal_acct'} &nbsp; &nbsp; Transaction Id: $ORDERREF->{'payment_authorization'}</td></tr>
		~;
		}

	my ($CUSTOMER) = CUSTOMER->new($USERNAME,EMAIL=>$SITE::CART->{'data.bill_email'},INIT=>33);
	if ($CUSTOMER->{'_CID'} == -1) { $CUSTOMER = undef; }
	
	if (defined $CUSTOMER) {
		my $NOTES = '';
		
		foreach my $note (@{$CUSTOMER->fetch_notes()}) {
			$NOTES .= "<tr><td valign='top' nowrap>".&ZTOOLKIT::pretty_date($note->{'CREATED_GMT'},-1)." $note->{'LUSER'}</td><td valign='top'>&nbsp; - &nbsp; </td><td valign='top'>$note->{'NOTE'}</td></tr>";
			}

		$GTOOLS::TAG{'<!-- CRMNOTES -->'} = qq~
		<table bgcolor="#000000" cellspacing=1 cellpadding=3 width="100%">
		<tr>
			<td bgcolor='FFFFFF'>
				<b>Customer Notes</b> 
				<i>(Reminder: customer notes are shared across all orders - they are never displayed to the customer.)</i><br>
			<table cellpadding='0' cellspacing='0'>
				$NOTES
			</table>
			<table cellpadding='0' cellspacing='0'><tr><td nowrap>
				Add Note: <input class="input" maxlength="80" type="textbox" size="80" name="NOTE"> <input onClick="document.thisFrm.CMD.value='SAVENOTE'; document.thisFrm.submit();" type="button" value=" Add ">	
			</td></tr></table>
			</td>
		</tr>
		</table>
		~;	
		}

		
	require SITE::URLS;
	$SITE::URL = SITE::URLS->new($USERNAME);
	$GTOOLS::TAG{'<!-- CARTVIEW -->'} = ORDER::VIEW::as_html($SITE::CART,'INVOICE',undef,undef,undef);


	my $c = '';
	foreach my $trkref (@{$o->tracking()}) {
		my ($method, $value) = ($trkref->{'carrier'},$trkref->{'track'});
		my $notes = $trkref->{'notes'};
		my $cost = $trkref->{'cost'};
		my $actualwt = $trkref->{'actualwt'};

		next if ($value eq '');

		$c .= "<tr>";
		$c .= "<td>&nbsp;</td>";
		$c .= "<td><input type=\"checkbox\" name=\"delete-$value\"></td>";
	
		$c .= "<td>$trkref->{'carrier'}</td>";
		$c .= "<td>$trkref->{'track'}</td>";

		if ($trkref->{'carrier'} eq 'UPS') {
			$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://wwwapps.ups.com/WebTracking/processInputRequest?HTMLVersion=5.0&loc=en_US&Requester=UPSHome&tracknum=$value&AgreeToTermsAndConditions=yes\">visit UPS.com</a>";
			}
		elsif ($trkref->{'carrier'} eq 'USPS') {
			## updated 11/01/2006
			#$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.usps.com/shipping/trackandconfirm.htm?CUT_AND_PASTE=$value\">visit USPS.com</a>";
			# Apparently usps can have numbers now too! 2/15/07 $value =~ s/[^\d]+//g;
			$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://trkcnfrm1.smi.usps.com/PTSInternetWeb/InterLabelInquiry.do?CAMEFROM=OK&origTrackNum=$value\">visit USPS.com</a>";
			}
		elsif (($trkref->{'carrier'} eq 'FEDX') || ($trkref->{'carrier'} eq 'FDXG') || ($trkref->{'carrier'} eq 'FDXE') || ($trkref->{'carrier'} eq 'FDX')) {
			## updated 08/04/2005, added &tracknumbers=
			#$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.fedex.com/cgi-bin/tracking?last_action=track&ascend_header=1&action=track&language=english&mps=y&ssc=n&ssd=&dsc=n&dsd=&msc=n&msd=&track_type=&cntry_code=us&generic_tracknumber_list=$value%2C&tracknumber_list=&track_number_0=$value&tracknumbers=$value\">visit FedEx.com</a>";
	
			## updated 10/10/2006
			$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.fedex.com/Tracking?ascend_header=1&clienttype=dotcom&cntry_code=us&language=english&tracknumbers=$value\">visit FedEx.com</a>";
	
			## updated 3/1/02
			##http://www.fedex.com/us/tracking/?action=track&language=english&ascend_header=1&cntry_code=1&tracknumbers=$value
			}
		else {
			$c .= "<td bgcolor='FFFFFF'>n/a</td>";
			}
	
		$c .= "</tr>";
		if ($actualwt || $cost || $notes) {
			$c .= "<tr><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>";
			if ($cost) { $c .= "Shipping Cost: ".sprintf("%.2f",$cost)."<br>"; }
			if ($actualwt) { $c .= "Actual Weight: ".$actualwt."<br>"; }
			if ($notes) { $c .= "Shipping Notes: ".$notes."<br>"; }
			$c .= "</td></tr>";
			}
		}

	if ($c eq '') {
		$c = "<tr bgcolor='white'><td></td><td colspan='3'><i>Sorry, no tracking information is available.</td></tr>";
		}
	$GTOOLS::TAG{"<!-- TRACKING -->"} = $c;


	my $paytxt = '';
	my $getcc = 0;
	if ($ORDERREF->{'payment_status'} =~ /^0/) {
		$paytxt .= "<b>Status [$ORDERREF->{'payment_status'}]:</b> Order is paid in full, no further action is required.<br>";
		}
	elsif ($ORDERREF->{'payment_status'} eq '196') {
		$paytxt .= "<b>Status [$ORDERREF->{'payment_status'}]:</b> Customer indicated they would call in to provide credit card #";
		$getcc++;
		}
	elsif (($ORDERREF->{'payment_status'} =~ /^2/) && ($ORDERREF->{'payment_method'} eq 'CREDIT')) {
		$paytxt .= "<b>Status [$ORDERREF->{'payment_status'}]:</b> Denied";
		$getcc++;
		}
	elsif (defined $ZPAY::PAYMENT_STATUS{ $ORDERREF->{'payment_status'} }) {
		$paytxt .= "<b>Status [$ORDERREF->{'payment_status'}]:</b> ".$ZPAY::PAYMENT_STATUS{ $ORDERREF->{'payment_status'} };
		}
	else {
		$paytxt .= "<b>ERROR Status [$ORDERREF->{'payment_status'}]:</b> Unknown!";
		}
	$paytxt .= "<br>";

	if ($getcc) {
		# $paytxt .= Dumper($SITE::v,$ORDERREF);
		my ($error) = &ZPAY::verify_credit_card( $ORDERREF->{'card_number'}, $ORDERREF->{'card_exp_month'}, $ORDERREF->{'card_exp_year'}, $ORDERREF->{'cvvcid_number'});
		if ($error ne '') {
			$paytxt .= "<font color='red'>ERROR: $error</font><br>";
			}
		$paytxt .= "<table>";
		$paytxt .= "<tr><td>Card Number:</td><td><input type='textbox' name='card_number' value='".$ORDERREF->{'card_number'}."'></td></tr>";
		$paytxt .= "<tr><td>Expires:</td><td>mo:<input maxlength='2' size ='2' type='textbox' name='card_exp_month' value='".$ORDERREF->{'card_exp_month'}."'> / ";
		$paytxt .= "yy:<input maxlength='2' type='textbox' size='2' name='card_exp_year' value='".$ORDERREF->{'card_exp_year'}."'></td></tr>";
		$paytxt .= "<tr><td>CCVCID:</td><td><input type='textbox' size='4' name='cvvcid_number' value='".$ORDERREF->{'cvvcid_number'}."'><br></td></tr>"; 
		$paytxt .= "</table>";
		$paytxt .= qq~<input type="button" class="button" 
				onClick="document.thisFrm['VERB'].value='EDITORDER-UPDATECC'; document.thisFrm.submit();"
				value=" Update Payment ">~;
		}

	$GTOOLS::TAG{'<!-- PAYMENT -->'} = $paytxt;

#	if ($ORDERATTRIBS->{'payby'} eq 'CREDIT') {
#		}


		
	
#	<!-- PAYMENT -->

	$template_file = 'editorder.shtml';
	}







##
## NOTE: FINDORDER-ORDER on success goes directly to EDITORDER
##
if ($VERB =~ /FINDORDER(.*?)$/) {
	my $METHOD = $1;
	require ORDER::BATCH;
#	require CUSTOMER::BATCH;
	my ($MID) = &ZOOVY::resolve_mid($USERNAME);
	my $ERROR = '';

	my @RESULTS = ();
	my @EMAIL = ();
	$GTOOLS::TAG{'<!-- ORDERID -->'} = $SITE::v->{'order'};
	$GTOOLS::TAG{'<!-- EMAIL -->'} = $SITE::v->{'email'};
	$GTOOLS::TAG{'<!-- PHONE -->'} = $SITE::v->{'phone'};

	if ($METHOD eq '') {}
	elsif ($METHOD eq '-ORDER') {
		my $ORDERID = $q->param('order');
		if ($ORDERID eq '') { 
			$ERROR = 'Order Id Not Set'; 
			}
		else {
			$ERROR = "ORDER# $ORDERID is non-existant or corrupt";
			}		
		}
	elsif ($METHOD eq '-EMAIL') {
		my %result = &CUSTOMER::BATCH::find_customers($USERNAME,$SITE::v->{'email'},'EMAIL');
		foreach my $CID (keys %result) {
			push @RESULTS, $CID;
			}
		}
	elsif ($METHOD eq '-PHONE') {
		my %result = &CUSTOMER::BATCH::find_customers($USERNAME,$SITE::v->{'phone'},'PHONE');
		foreach my $CID (keys %result) {
			push @RESULTS, $CID;
			}
		}
	else {
		$ERROR = "METHOD [$METHOD] is not valid";
		}


	## SANITY: at this point we've either found an order, or we're not going to find.
	if ($ERROR ne '') {
		$GTOOLS::TAG{'<!-- ORDERS -->'} = "<tr><td><Font color='red'>ERROR: $ERROR</td></td>";
		}
	elsif ($METHOD eq '') {}	# FINDORDER by itself doesn't show anything!
	else {
		## HURRAH!
		my $c = '';
		my $CID = 0;
		foreach my $el (@RESULTS) {
			if (substr($el,0,1) eq '#') {
				## FOUND ORDER
				$el = substr($el,1); 	# strip leading # from #2007-06-1000
				$c .= "<tr><td>ORDER:</td><td><a href='index.cgi'>$el</a></td></tr>";			
				}
			else {
				## FOUND CUSTOMER
				$c .= "<tr><td>CUSTOMER:</td><td>$el</td></tr>";
				my @oids = &CUSTOMER::BATCH::customer_orders($USERNAME,$CID,100);
				foreach my $oid (@oids) {
					$c .= "<tr><td>ORDER:</td><td><a href=\"index.cgi?VERB=EDITORDER&order=$oid&key=$key\">$oid</a></td></tr>";
					}
				}
			}
		if ($c eq '') { $c = "<tr><td><i>No matching orders found</td></tr>"; }
		$GTOOLS::TAG{'<!-- ORDERS -->'} = $c;
		}

	$GTOOLS::TAG{'<!-- HEADER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_findorder_header_msg'));
	$VERB = 'FINDORDER';
	$template_file = 'findorder.shtml';
	}


if ($VERB eq 'FAQ') {
	$template_file = 'faq.shtml';
	}

if ($VERB eq 'POLICIES') {

	$GTOOLS::TAG{'<!-- POLICIES_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_policies_msg'));

	$GTOOLS::TAG{'<!-- zoovy:return_policy -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('zoovy:return_policy'));
	if ($GTOOLS::TAG{'<!-- zoovy:return_policy -->'} eq '') {
		$GTOOLS::TAG{'<!-- zoovy:return_policy -->'} = '<i>Return Policy Not Set</i><br>';
		}
	
	my $c = '';
	require SITE::FAQS;
	my ($faqs) = SITE::FAQS->new($USERNAME);
	my $topics = $faqs->list_topics();
	foreach my $topic (@{$topics}) {
		$c .= "<tr><td><b>$topic->{'TITLE'}</b><br></td></tr>\n";
		my ($faqs) = $faqs->list_faqs($topic->{'ID'});
		foreach my $f (@{$faqs}) {
			$c .= "<tr><td><li> $f->{'QUESTION'}<br>$f->{'ANSWER'}</td></tr>";
			}
		}
	$GTOOLS::TAG{'<!-- FAQS -->'} = $c;

	$template_file = 'policies.shtml';
	}



##
##
##
if ($VERB eq 'MESSAGE-SAVE') {
	
	my $msg = $SITE::v->{'caller_msg'};
	if ($SITE::v->{'caller_phone'} ne '') {
		$msg = "PHONE: ".$SITE::v->{'caller_phone'}."\n".$msg;
		}

	my $SUBJECT = $SITE::v->{'caller_subject'};
	&ZMAIL::notify_customer(
		$USERNAME,$SITE::v->{'caller_email'},
		$SUBJECT,
		$msg,
		'CALLCENTER','',1,"#$PRT");
		
	$VERB = 'MESSAGE';
	}

if ($VERB eq 'MESSAGE') {
	$GTOOLS::TAG{'<!-- HEADER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_takemsg_header_msg'));
	$GTOOLS::TAG{'<!-- FOOTER_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_takemsg_footer_msg'));

	$template_file = 'message.shtml';
	}




##
## Builds the standard header!
##


my $logoimg = '';
my ($PROFILE) = &ZWEBSITE::prt_get_profile($USERNAME,$PRT);
my ($nsref) = &ZOOVY::fetchmerchant_ref($USERNAME,$PROFILE);
if (($nsref->{'zoovy:company_logo'} eq '') && ($nsref->{'zoovy:logo_website'} eq '')) {
	$logoimg = "Profile[$PROFILE] Invoice Logo Not Set!";
	}
elsif ($nsref->{'zoovy:company_logo'} ne '') {
	$logoimg = &GTOOLS::imageurl($USERNAME,$nsref->{'zoovy:company_logo'},50,0,'FFFFFF');
	$logoimg = "<img border=0 height=\"50\" src=\"$logoimg\">";
	}
elsif ($nsref->{'zoovy:logo_website'} ne '') {
	$logoimg = &GTOOLS::imageurl($USERNAME,$nsref->{'zoovy:logo_website'},50,0,'FFFFFF');
	$logoimg = "<img border=0 height=\"50\" src=\"$logoimg\">";
	}
else {
	$logoimg = "This line is never reached";
	}

$GTOOLS::TAG{'<!-- HEADER -->'} = qq~
<html>
<head>
<title>$PAGE_TITLE</title>
<link rel="stylesheet" type="text/css" href="/callcenter/css/cc_styles.css?1">
</head>
<body>
<div align='center'>
	<div style='position:relative; width:800px; text-align:left'>
<table cellspacing='0' cellpadding='0' style='border-bottom:1px solid #0066FF; margin-bottom:5px;' width='800'>
<tr>
	<td width='150'><a href="index.cgi?key=$key">$logoimg</td>
	<td nowrap width='450' align='right' valign='bottom'><div style='width:auto; float:right;'>
	<div class='tab ~.(($VERB eq 'CREATEORDER')?'tab_on':'').qq~'><a href="index.cgi?key=$key&VERB=CREATEORDER">CREATE ORDER</a></div>
	<div class='tab ~.(($VERB eq 'FINDORDER')?'tab_on':'').qq~'><a href="index.cgi?key=$key&VERB=FINDORDER">LOOKUP ORDER</a></div>
	<div class='tab ~.(($VERB eq 'RETURNS')?'tab_on':'').qq~'><a href="index.cgi?key=$key&VERB=RETURNS">RETURNS</a></div>
	<div class='tab ~.(($VERB eq 'POLICIES')?'tab_on':'').qq~'><a href="index.cgi?key=$key&VERB=POLICIES">POLICIES</a></div>
	<div class='tab ~.(($VERB eq 'MESSAGE')?'tab_on':'').qq~'><a href="index.cgi?key=$key&VERB=MESSAGE">TAKE MESSAGE</a></div>
	</div>
	</td>
</tr>
</table>
~;


if (defined $SITE::MSGS) {
	$GTOOLS::TAG{'<!-- WELCOME_MSG -->'} = &CALLCENTER::scriptformat($SITE::MSGS->get('callcenter_welcome_msg'));
	}


#my $x = q~
#<div>
#<div class='wiki_actions'><a href=''>Action 1</a></div>
#<div class='wiki_actions'><a href=''>Action 2</a></div>
#<div class='wiki_actions'><a href=''>Action 3</a></div>
#<div class='wiki_actions'><a href=''>Action 4</a></div>
#</div>
#
#<p class='wiki_hint'>Lorem ipsum dolor sit amet, perspiciatis vivamus et donec sapien ultricies, fermentum nunc vestibulum nullam aptent vestibulum, enim justo magna faucibus. Suspendisse ligula, nunc ultrices nonummy at netus iste ac. Enim purus vestibulum viverra mauris nisl est, enim rhoncus ac cras justo elementum, id odio arcu eu. </p>
#
#~;

	$GTOOLS::TAG{'<!-- FOOTER -->'} = qq~
	</div>
</div>
</body></html>
~;


print STDERR "ENDED: $template_file / VERB=$VERB\n";

&GTOOLS::output(file=>$template_file,header=>1,msgs=>\@MSGS);
