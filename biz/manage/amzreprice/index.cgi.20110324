#!/usr/bin/perl

use lib "/httpd/modules";
require GTOOLS;
require ZWEBSITE;

use strict;

use Data::Dumper;
use lib "/httpd/modules";
use GTOOLS;
use ZOOVY;
use LUSER;
use AMZREPRICE;
use Text::CSV_XS;


my ($LU) = LUSER->authenticate(flags=>'_M&16');
if (not defined $LU) { warn "Auth"; exit; }

my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
if ($MID<=0) { warn "No auth"; exit; }

my ($gref) = ZWEBSITE::fetch_globalref($USERNAME);

my $VERB = uc($ZOOVY::cgiv->{'VERB'});
if ($VERB eq '') { 
	$VERB = 'GLOBAL'; 
	if ($gref->{'amz_merchantname'} ne '') {
		$VERB = 'STRATEGIES';
		}
	}

my $template_file = '';

if ($VERB eq 'SAVE-STRATEGY') {
	my ($STRATEGY_ID) = uc($ZOOVY::cgiv->{'strategy_id'});
	$STRATEGY_ID =~ s/[^A-Z09-9\-]+//gs; # we only allow URI safe characters in strategy id's
	my %config = ();
	$config{'seller'} = $gref->{'amz_merchantname'};
	$config{'sellerid'} = $gref->{'amz_sellerid'};
	$config{'ignore_sellers'} = $ZOOVY::cgiv->{'ignore_sellers'};
	$config{'bully_sellers'} = $ZOOVY::cgiv->{'bully_sellers'};
	&AMZREPRICE::add_strategy($USERNAME,$STRATEGY_ID,\%config);
	## we should really add some check and give a success message or something.
	$VERB = 'STRATEGIES';
	}

if ($VERB eq 'STRATEGIES') {
	my $c = '';
	my ($strats) = &AMZREPRICE::list_strategies($USERNAME);
	my $r = '';
	foreach my $stratref (@{$strats}) {
		$r = ($r eq 'r0')?'r1':'r0';
		$c .= "<tr class=\"$r\">";
		$c .= "<td><a href=\"index.cgi?VERB=EDIT-STRATEGY&STRATEGY_ID=$stratref->{'STRATEGY_ID'}\">[EDIT]</a></td>";
		$c .= "<td>$stratref->{'STRATEGY_ID'}</td>";
		# $c .= "<td>".Dumper($stratref->{'%'})."</td>";
		$c .= "<td>".&ZTOOLKIT::pretty_date($stratref->{'MODIFIED_GMT'},2)."</td>";
		$c .= "</tr>";
		}
	if (scalar(@{$strats})==0) {
		$c .= qq~<tr><td colspan=5><div class="warning">No strategies configured. Click "Add Strategy" to create one.</td></tr>~;
		}
	$GTOOLS::TAG{'<!-- STRATEGIES -->'} = $c;
	$template_file = 'strategies.shtml';
	}



##
##
##
if (($VERB eq 'ADD-STRATEGY') || ($VERB eq 'EDIT-STRATEGY')) {
	my $stratref = {};
	if ($VERB eq 'EDIT-STRATEGY') {
		($stratref) = &AMZREPRICE::get_strategy($USERNAME,$ZOOVY::cgiv->{'STRATEGY_ID'});
		if (not defined $stratref) { $stratref = {}; }
		}
	
	# $GTOOLS::TAG{'<!-- DEBUG -->'} = Dumper($stratref);
	$GTOOLS::TAG{'<!-- SELLER -->'} = $gref->{'amz_merchantname'};
	$GTOOLS::TAG{'<!-- STRATEGY_ID -->'} = $stratref->{'STRATEGY_ID'};
	$template_file = 'add-strategy.shtml';
	}

if ($VERB eq 'EDIT') {	
	$template_file = 'profile.shtml';
	}

##
##
##
if ($VERB eq 'GLOBAL-SAVE') {
	$gref->{'amz_merchantname'} = '';
	if ($ZOOVY::cgiv->{'enable'}) {
		$gref->{'amz_merchantname'} = $ZOOVY::cgiv->{'amz_merchantname'};	
		$gref->{'amz_sellerid'} = $ZOOVY::cgiv->{'amz_sellerid'};
		}
	&ZWEBSITE::save_globalref($USERNAME,$gref);
	if ($gref->{'amz_merchantname'} eq '') {
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = qq~<div class="error">Need a Amazon Merchant name</div>~;
		}
	else {
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = qq~<div class="success">Saved settings</div>~;
		}
	$VERB = 'GLOBAL';
	}

##
##
##
if ($VERB eq 'GLOBAL') {
	my ($gref) = ZWEBSITE::fetch_globalref($USERNAME);
	$GTOOLS::TAG{'<!-- AMZ_MERCHANTNAME -->'} = $gref->{'amz_merchantname'};
	$GTOOLS::TAG{'<!-- CHK_ENABLED -->'} = ($gref->{'amz_merchantname'} ne '')?'checked':'';
	$template_file = 'global.shtml';
	if ($gref->{'amz_merchantname'} eq '') {
		$VERB = 'RESTRICT-TO-GLOBAL';
		}
	}

if ($VERB eq 'LOGS') {
	$template_file = 'logs.shtml';
	my $rdbh = &AMZREPRICE::db_ec2rds_connect($USERNAME);;
	my $pstmt = "select * from PRICING_EVENTS order by CREATED_GMT";
	my $sth = $rdbh->prepare($pstmt);
	$sth->execute();
	my $c = '';
	my $r = '';
	while ( my $row = $sth->fetchrow_hashref() ) {
		$r = ($r eq 'r0')?'r1':'r0';
		$c .= "<tr class=\"$r\">".
				"<td nowrap valign=top>".&ZTOOLKIT::pretty_date($row->{'CREATED_GMT'},2	)."</td>".
				"<td nowrap valign=top><b>".$row->{'SKU'}."</b></td>".
				"<td nowrap valign=top>".$row->{'ASIN'}."</td>".
				"<td nowrap valign=top>".$row->{'VERB'}."</td>".
				"<td nowrap valign=top>".$row->{'PRICE_WAS'}."</td>".
				"<td nowrap valign=top>".$row->{'PRICE_IS'}."</td>".
				"<td>".$row->{'NOTE'}."</td>".
				"</tr>";
		}
	if ($c eq '') {
		$c .= "<tr><td><div class='warning'>No actions have been taken yet.</div></td></tr>";
		}
	$GTOOLS::TAG{'<!-- LOGS -->'} = $c;
	
	$sth->finish();
	&AMZREPRICE::db_ec2rds_close();
	}


my @TABS = ();
push @TABS, { name=>'Strategies', selected=>($VERB eq 'STRATEGIES')?1:0, link=>'index.cgi?VERB=STRATEGIES' };
if ($VERB ne 'RESTRICT-TO-GLOBAL') {
	## if they don't have the service enabled, then don't show other tabs.
	push @TABS, { name=>'Add Strategy', selected=>($VERB eq 'ADD')?1:0, link=>'index.cgi?VERB=ADD-STRATEGY' };
	push @TABS, { name=>'Global Config', selected=>($VERB eq 'GLOBAL')?1:0, link=>'index.cgi?VERB=GLOBAL' };
	push @TABS, { name=>'Logs', selected=>($VERB eq 'LOGS')?1:0, link=>'index.cgi?VERB=LOGS' };
	}

&GTOOLS::output(
	header=>1,
	file=>$template_file,
	tabs=>\@TABS
	);