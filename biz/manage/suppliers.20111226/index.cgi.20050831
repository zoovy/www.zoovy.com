#!/usr/bin/perl

use lib "/httpd/modules";
use GTOOLS;
use ZOOVY;
use SUPPLIER;
use ZTOOLKIT;
use PRODUCT::BATCH;

use strict;

my $dbh = &DBINFO::db_zoovy_connect();


my $q = new CGI; use Data::Dumper;
my @BC = ();
push @BC, { 'name'=>'Utilities', 'link'=>'/biz/utilities', 'target'=>'_top'};
push @BC, { 'name'=>'Supply Chain', link=>'/biz/utilities/suppliers', 'target'=>'_top'};
my $title = "Utilities: Supply Chain Management";


#my $params = &ZTOOLKIT::buildparams($ZOOVY::cgiv);
my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate(undef,2,undef);
if ($USERNAME eq '') { exit; }

my $template_file = 'index.shtml';
if ($FLAGS !~ /,SC,/) {  $template_file = 'deny.shtml'; }

my $qtUSERNAME = $dbh->quote($USERNAME);
## NOTE: 
##		ACTION=USETHEFORCE 
##
my $ACTION = $ZOOVY::cgiv->{'ACTION'};
my $CODE = $ZOOVY::cgiv->{'CODE'};
my $qtCODE = $dbh->quote($CODE);
my $info = undef;

$GTOOLS::TAG{'<!-- CODE -->'} = $CODE;
my @TABS = ();
if ($CODE ne '') {
	push @TABS, { 'name'=>'Setup', link=>"?ACTION=EDIT&CODE=$CODE" };
	push @TABS, { 'name'=>'Products', link=>"?ACTION=PRODUCTS&CODE=$CODE" };
	push @TABS, { 'name'=>'Orders', link=>"?ACTION=ORDERS&CODE=$CODE" };
#	push @TABS, { 'name'=>'Inventory', link=>"?ACTION=INVENTORY&CODE=$CODE" };
	}

##
##
##	

if ($ACTION eq 'JEDI-SAVE') {
	$ACTION = '';
	}

if ($ACTION eq 'NEW-SAVE') {
	my $ERROR = '';

	if ($ERROR eq '') {
		my $path = &ZOOVY::resolve_userpath($USERNAME);
		mkdir($path.'/SC',0777);
		if (!-d $path.'/SC') {
			$ERROR = 'Could not create directory for supply chain orders.';
			}
		}
	

	require WHOLESALE;

	my $qtCODE = $dbh->quote($CODE);
	my $qtCNAME = $dbh->quote($ZOOVY::cgiv->{'name'});
	my $qtCPHONE = $dbh->quote($ZOOVY::cgiv->{'phone'});
	my $qtCEMAIL = $dbh->quote($ZOOVY::cgiv->{'email'});
	my $qtMARKUP = $dbh->quote($ZOOVY::cgiv->{'MARKUP'});
	my $MODE = uc($ZOOVY::cgiv->{'mode'});
	my $qtMODE = $dbh->quote($MODE);
	

	if (($ERROR eq '') && ($CODE eq '')) {
		$ERROR = "Supplier ID cannot be blank";
		$GTOOLS::TAG{'<!-- SUPPLIER_ERROR -->'} = &GTOOLS::errmsg($ERROR);
		}

	if (($ERROR eq '') && (SUPPLIER::exists($USERNAME,$CODE))) {
		$ERROR = "Supplier ID [$CODE] already exists";
		$GTOOLS::TAG{'<!-- SUPPLIER_ERROR -->'} = &GTOOLS::errmsg($ERROR);
		}

	if (($ERROR eq '') && (not &WHOLESALE::validate_formula($ZOOVY::cgiv->{'MARKUP'}))) {
		$ERROR = "Markup formula does not appear to be valid.";
		$GTOOLS::TAG{'<!-- MARKUP_ERROR -->'} = &GTOOLS::errmsg($ERROR);
		}

	if (($ERROR eq '') && ($MODE eq 'JEDI')) {
		require SUPPLIER::JEDI;
		($ERROR) = SUPPLIER::JEDI::setup($USERNAME,$ZOOVY::cgiv->{'jedi_user'},$ZOOVY::cgiv->{'jedi_mid'},$ZOOVY::cgiv->{'jedi_email'});

		if ($ERROR ne '') { $GTOOLS::TAG{'<!-- JEDI_ERROR -->'} = &GTOOLS::errmsg($ERROR); }
		else{
			## ADD A JEDI SUPPLIER
			my $qtCODE = $dbh->quote($CODE);

			my $qtJMID = $dbh->quote($ZOOVY::cgiv->{'jedi_mid'});
			my $qtJUSER = $dbh->quote($ZOOVY::cgiv->{'jedi_user'});
			my $qtJEMAIL = $dbh->quote($ZOOVY::cgiv->{'jedi_email'});
		
			my $SRCUSER = $ZOOVY::cgiv->{'jedi_user'};
			my $qtCNAME = $dbh->quote(&ZOOVY::fetchmerchant_attrib($SRCUSER,'zoovy:company_name',''));
			my $qtCPHONE = $dbh->quote(&ZOOVY::fetchmerchant_attrib($SRCUSER,'zoovy:company_phone',''));
			my $qtCEMAIL = $dbh->quote(&ZOOVY::fetchmerchant_attrib($SRCUSER,'zoovy:company_email',''));
	
			my $pstmt = "insert into SUPPLIERS (MID,USERNAME,CODE,MARKUP,COMPANY_NAME,COMPANY_PHONE,COMPANY_EMAIL,MODE) values ";
			$pstmt .= "($MID,$qtUSERNAME,$qtCODE,$qtMARKUP,$qtCNAME,$qtCPHONE,$qtCEMAIL,$qtMODE)";
			print STDERR $pstmt."\n";
			$dbh->do($pstmt);

			$pstmt = "update SUPPLIERS set JEDI_MID=$qtJMID,JEDI_USERNAME=$qtJUSER,JEDI_CUSTOMER=$qtJEMAIL where MID=$MID and CODE=$qtCODE"; 
			$dbh->do($pstmt);
			print STDERR $pstmt."\n";

			## VERIFY THAT THE JEDI_MID IS SET IN THE CUSTOMER RECORD
			($ERROR) = SUPPLIER::JEDI::setup($USERNAME,$ZOOVY::cgiv->{'jedi_user'},$ZOOVY::cgiv->{'jedi_mid'},$ZOOVY::cgiv->{'jedi_email'});
			if ((defined $ERROR) && ($ERROR ne '')) {
				## delete the supplier (since JEDI is not configured!)
				$pstmt = "delete from SUPPLIERS where MID=$MID and CODE=$qtCODE";
				$dbh->do($pstmt);
				}
			}
		}
	elsif(($ERROR eq '') && ($MODE eq 'GENERIC')) {
		## ADD A NON-JEDI SUPPLIER
print STDERR "checking GENERIC mode\n";
		## VALIDATION
		if ($ZOOVY::cgiv->{'name'} eq '') {
			$ERROR = "Company Name is required.";
			$GTOOLS::TAG{'<!-- COMPANY_NAME_ERROR -->'} = &GTOOLS::errmsg($ERROR);
			}
		if (($ERROR eq '') && ($ZOOVY::cgiv->{'account'} eq '')) {
			$ERROR = "Company Account is required.";
			$GTOOLS::TAG{'<!-- COMPANY_ACCOUNT_ERROR -->'} = &GTOOLS::errmsg($ERROR);
			}
		if (($ERROR eq '') && (&ZTOOLKIT::validate_phone($ZOOVY::cgiv->{'phone'}) == 0)) {
			$ERROR = "Company Phone is invalid.";
			$GTOOLS::TAG{'<!-- COMPANY_PHONE_ERROR -->'} = &GTOOLS::errmsg($ERROR);
			}
		if (($ERROR eq '') && (&ZTOOLKIT::validate_email($ZOOVY::cgiv->{'email'}) == 0)) {
			$ERROR = "Company Email is invalid.";
			$GTOOLS::TAG{'<!-- COMPANY_EMAIL_ERROR -->'} = &GTOOLS::errmsg($ERROR);
			}
print STDERR "ERROR: $ERROR\n";
		if($ERROR eq ''){
			my $qtMODE = $dbh->quote('GENERIC');
      	my $qtCNAME = $dbh->quote($ZOOVY::cgiv->{'name'});
			my $qtCACCOUNT = $dbh->quote($ZOOVY::cgiv->{'account'});
      	my $qtCPHONE = $dbh->quote($ZOOVY::cgiv->{'phone'});
      	my $qtCEMAIL = $dbh->quote($ZOOVY::cgiv->{'email'});
      	my $qtWEB = $dbh->quote($ZOOVY::cgiv->{'website'});
	
			my $pstmt = "insert into SUPPLIERS (MID,USERNAME,CODE,MARKUP,COMPANY_NAME,COMPANY_ACCOUNT,COMPANY_PHONE,COMPANY_EMAIL,COMPANY_WEBSITE,MODE) values ";
      	$pstmt .= "($MID,$qtUSERNAME,$qtCODE,$qtMARKUP,$qtCNAME,$qtCACCOUNT,$qtCPHONE,$qtCEMAIL,$qtWEB,$qtMODE)";
      	print STDERR $pstmt."\n";
      	$dbh->do($pstmt);
			}
		}

	if ($ERROR ne '') {	
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = "<font color='red'>$ERROR</font>";
		$ACTION = 'NEW';
		}
	else {	
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Your Supplier has been successfully added.</font>";
		$ACTION = 'EDIT';
		}


	}



######
##
## SANITY: at this point any information which is going to be saved, has been saved!
##				so we'll populate $info
##
######
if ($CODE ne '') {
	my $pstmt = "select * from SUPPLIERS where CODE=$qtCODE and MID=$MID";
	print STDERR $pstmt."\n";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	($info) = $sth->fetchrow_hashref();
	$sth->finish();

	#($info) = SUPPLIER->new($USERNAME,$CODE);
	if ($CODE ne '') {
		push @BC, { name=>"$CODE", link=>"/biz/manage/suppliers/index.cgi?ACTION=EDIT&CODE=$CODE", target=>'_top' };
		}
	}


##
## note: SUBSCRIBE is passed from customer_main.pl to a person subscribing to a feed
##		parameters: INDEX, LOAD
##
if ($ACTION eq 'SUBSCRIBE') {
	my $SUPPLIERMID = int($ZOOVY::cgiv->{'MID'});
	
	my $SAFE = '';
	my $PRETTY = '';
	
	my ($S) = SUPPLIER->new($USERNAME,"#$SUPPLIERMID");
	my $CODE = '';
	if (defined $S) {
		my $PRETTY = '';
		my $INDEX = $ZOOVY::cgiv->{'INDEX'};
		my $LOAD = $ZOOVY::cgiv->{'LOAD'};

		require SUPPLIER::JEDI;
		require NAVCAT;

		my ($ERROR,$PRODUCTSTR,$INFO) = &SUPPLIER::JEDI::load_subscription($USERNAME,$INDEX,$LOAD);
		
		if ($ERROR eq '') {
			$CODE= $S->fetch_property('CODE');
			my $dbh = &DBINFO::db_zoovy_connect();
			my $pstmt = "insert into SUPPLIER_SUBSCRIPTIONS (CODE,SRCMID,SRCUSER,DSTMID,DSTUSER,SAFE,PRETTY,CREATED_GMT,UPDATED_GMT) values (";
			$pstmt .= $dbh->quote($CODE).",";
			$pstmt .= $dbh->quote($S->fetch_property('JEDI_MID')).",".$dbh->quote($S->fetch_property('JEDI_USERNAME')).',';
			$pstmt .= $dbh->quote($MID).','.$dbh->quote($USERNAME).',';
			$pstmt .= $dbh->quote($SAFE).','.$dbh->quote($PRETTY).',';
			$pstmt .= $dbh->quote(time()).',0)';
			print STDERR $pstmt."\n";
			$dbh->do($pstmt);
			&DBINFO::db_zoovy_close();
			}
	
		if ($ERROR eq '') {
			my %M = ();
			$M{'VIRTUAL'} = 1;
			$M{'INDEX'} = $ZOOVY::cgiv->{'INDEX'};
			$M{'LOAD'} = $ZOOVY::cgiv->{'LOAD'};
			my $meta = &NAVCAT::encode_meta(\%M);
			my $CATEGORY = $INFO->{'uuid'};
			$CATEGORY =~ s/[^A-Z0-9a-z\_]//g;    # lets just be safe.
			$CATEGORY = '$'.$CATEGORY;
			
			$PRETTY = $INFO->{'pretty'};
			&NAVCAT::save_info($USERNAME, $CATEGORY, $PRETTY, undef, $PRODUCTSTR, undef, $meta);
			}

		if ($ERROR eq '') {
			$GTOOLS::TAG{'<!-- MESSAGE -->'} = "<font color='blue'>Successfull added $PRETTY from $CODE</font>";
			}
		else {
			$GTOOLS::TAG{'<!-- MESSAGE -->'} = "<font color='red'>ERROR: $ERROR</font>";
			}

		}
	else {
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = "<font color='red'>Supplier no longer defined!</font>";
		}
	$ACTION = '';

	push @BC, { name=>"$CODE", link=>"/biz/manage/suppliers/index.cgi?ACTION=EDIT&CODE=$CODE", target=>'_top' };
	}

##
## note: USETHEFORCE is passed to automatically setup a new JEDI business
##
if (($ACTION eq 'NEW') || ($ACTION eq 'USETHEFORCE')) { 
	$template_file = 'new.shtml'; 
	
	$GTOOLS::TAG{'<!-- CODE -->'} = ($ZOOVY::cgiv->{'CODE'})?$ZOOVY::cgiv->{'CODE'}:'';
	$GTOOLS::TAG{'<!-- MODE_JEDI -->'} = '';
	$GTOOLS::TAG{'<!-- MODE_GENERIC -->'} = '';

	## http://www.zoovy.com/biz/utilities/suppliers/index.cgi?ACTION=USETHEFORCE&USERNAME=ZSMC&MID=16804&LOGIN=brian@zoovy.com
	## IF ACTION eq USETHEFORCE
	if ($ACTION eq 'USETHEFORCE') {
		$GTOOLS::TAG{'<!-- MODE_JEDI -->'} = 'checked';
		$GTOOLS::TAG{'<!-- JEDI_USER -->'} = ($ZOOVY::cgiv->{'USERNAME'})?$ZOOVY::cgiv->{'USERNAME'}:'';
		$GTOOLS::TAG{'<!-- JEDI_MID -->'} = ($ZOOVY::cgiv->{'MID'})?$ZOOVY::cgiv->{'MID'}:'';
		$GTOOLS::TAG{'<!-- JEDI_EMAIL -->'} = ($ZOOVY::cgiv->{'LOGIN'})?$ZOOVY::cgiv->{'LOGIN'}:'';
		}
	else {
		$GTOOLS::TAG{'<!-- JEDI_USER -->'} = ($ZOOVY::cgiv->{'jedi_user'})?$ZOOVY::cgiv->{'jedi_user'}:'';
		$GTOOLS::TAG{'<!-- JEDI_MID -->'} = ($ZOOVY::cgiv->{'jedi_mid'})?$ZOOVY::cgiv->{'jedi_mid'}:'';
		$GTOOLS::TAG{'<!-- JEDI_EMAIL -->'} = ($ZOOVY::cgiv->{'jedi_email'})?$ZOOVY::cgiv->{'jedi_email'}:'';
		}

	if ($ZOOVY::cgiv->{'mode'}) {
		$GTOOLS::TAG{'<!-- MODE_'.($ZOOVY::cgiv->{'mode'}).' -->'} = 'checked';
		}

	$GTOOLS::TAG{'<!-- NAME -->'} = ($ZOOVY::cgiv->{'name'})?$ZOOVY::cgiv->{'name'}:'';
	$GTOOLS::TAG{'<!-- ACCOUNT -->'} = ($ZOOVY::cgiv->{'account'})?$ZOOVY::cgiv->{'account'}:'';
	$GTOOLS::TAG{'<!-- PHONE -->'} = ($ZOOVY::cgiv->{'phone'})?$ZOOVY::cgiv->{'phone'}:'';
	$GTOOLS::TAG{'<!-- EMAIL -->'} = ($ZOOVY::cgiv->{'email'})?$ZOOVY::cgiv->{'email'}:'';
	$GTOOLS::TAG{'<!-- WEBSITE -->'} = ($ZOOVY::cgiv->{'website'})?$ZOOVY::cgiv->{'website'}:'';	
	
	$GTOOLS::TAG{'<!-- MARKUP -->'} = ($ZOOVY::cgiv->{'MARKUP'})?$ZOOVY::cgiv->{'MARKUP'}:'';

	push @BC, { name=>'Add New Supplier' };
	}

##
## this is what gets run when they click the "Update Now" button
##
if ($ACTION eq 'UPDATE-GENERIC-INVENTORY') {
	require SUPPLIER::GENERIC;
	my ($count,$error) = &SUPPLIER::GENERIC::update_inventory($USERNAME,$CODE);
	if ($count==0) {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>ERROR: $error</font>";
		}
	else {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color=\"blue\">Successfully imported $count items.</font>";
		}
	$ACTION = 'GENERIC-INVENTORY';
	}


##
## Saves a CSV import for a GENERIC supplier
##
if ($ACTION eq 'SAVE-GENERIC-IMPORT') {
	my $ERROR = 0;
	my $fh = $q->upload("FILENAME");
	my $BUFFER = "";
	my $filename = $q->param("FILENAME");
	if ($filename =~ /\.xls$/i) { $ERROR = 1; $GTOOLS::TAG{'<!-- RESULT -->'} = "Filename has an .xls extension - should be .csv"; }
	if (!defined($filename)) { $filename = time(); }
	if ($filename =~ /\.zip$/i) { 
		while (<$fh>) { $BUFFER .= $_; }
		require Archive::Zip;
		my $zip = Archive::Zip->new();
		open F, ">/tmp/$USERNAME-csv.zip";
		print F $BUFFER;
		close F;
		$zip->read("/tmp/$USERNAME-csv.zip");
		# $zip->readFromFileHandle($fh);
		my @names = $zip->memberNames();
		foreach my $m (@names) {
			next unless (($m =~ /.txt$/i) || ($m =~ /.csv/i));
			$BUFFER = $zip->contents($m);
			}
		}
	else {
		while (<$fh>) { $BUFFER .= $_; }
		}
	if (length($BUFFER)<10) { $ERROR = 1; $GTOOLS::TAG{'<!-- RESULT -->'} = "File $filename had no contents.\n"; }

	my ($fieldref,$lineref,$optionsref);
	if (not $ERROR) {
		require ZCSV;
		($fieldref,$lineref,$optionsref) = &ZCSV::readHeaders($BUFFER);
		}

	if (not $ERROR) {
		require ZCSV::PRODUCT;
		require IMPORT;
		$IMPORT::SILENT = 1;

		$optionsref->{'SUPPLIER'} = $CODE;
		$optionsref->{'TYPE'} = 'SUPPLIER';
		print &IMPORT::divout("Filter:<br><pre>".Dumper($fieldref,$optionsref)."</pre>"); 
		&ZCSV::logImport($USERNAME,$fieldref,$lineref,$optionsref);
		my ($lines) = &ZCSV::PRODUCT::parseproduct($USERNAME,$fieldref,$lineref,$optionsref);	
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully imported $lines lines</font><br>";
		}
	
	$ACTION = 'GENERIC-IMPORT';
	}

##
##	Displays the generic CSV import screen
##
if ($ACTION eq 'GENERIC-IMPORT') {
	$template_file = 'generic-import.shtml';
	push @BC, { name=>'Import Products' };
	}



##
##
##
if ($ACTION eq 'PRODUCTS') {

	require PRODUCT::BATCH;
	require PRODUCT;
	my $allpids = PRODUCT::BATCH::list_by_attrib($USERNAME,'zoovy:prod_supplier',$CODE);
	my $c = '';
	my $batches = &PRODUCT::batchify($allpids,50);

	my $count = 0;
	foreach my $batch (@{$batches}) {
		my $pidsref = &ZOOVY::fetchproducts_into_hashref($USERNAME,$batch);
		foreach my $pid (keys %{$pidsref}) {
			my $class = ($count++%2)?'table_bg1':'table_bg2';
			$c .= qq~<tr class="$class">~;
			$c .= "<td>$pid</td>";
			foreach my $k ('zoovy:prod_supplierid','zoovy:prod_name','zoovy:base_cost','zoovy:base_price') {
				$c .= "<td>$pidsref->{$pid}->{$k}</td>";
				}
			$c .= "</tr>";
			}
		}

	if ($c eq '') {
		$c .= "<tr><td colspan='5'>No products found - please add some</td></tr>";
		}
	$GTOOLS::TAG{'<!-- PRODUCTS -->'} = $c;

	$template_file = 'products.shtml';
   push @BC, { name=>"Products" };

	}


##
## Orders tab
## 
if ($ACTION eq 'ORDERS') {

	my $c = '';

	## commented out for now
	## was producing an Internal Server Error
	if(0){
	require ORDER::SUPPLIER;
	my $orefs = ORDER::SUPPLIER::list_orders($USERNAME,$CODE);
	my $count = 0;
	foreach my $supoid (keys %{$orefs}) {
		my $class = ($count++%2)?'table_bg1':'table_bg2';
		my ($POOL,$SRCOID,$CTS,$DTS) = split(/\|/,$orefs->{$supoid});

		my $ACTIONS = '';

		$c .= qq~
<tr class="$class">
	<td>$SRCOID</td>
	<td>$supoid</td>
	<td>$POOL</td>
	<td>~.&ZTOOLKIT::pretty_date($CTS).qq~</td>
	<td>~.&ZTOOLKIT::pretty_date($DTS).qq~</td>
	<td>$ACTIONS</td>
</tr>~;
		}
	}

	if ($c eq '') {
		$c = "<tr class='table_bg2'><td colspan='6'><i>No orders found for this supplier</td></tr>";
		}

	$GTOOLS::TAG{'<!-- ORDERS -->'} = $c;
	$template_file = 'orders.shtml';
   push @BC, { name=>"Orders" };
	}

## 
##
##
if ($ACTION eq 'INVENTORY') {
	}



##
##
##
if ($ACTION eq 'SAVE-GENERIC-ADDPRODUCTS') {
	my %hash = ();
	my $SKU = $ZOOVY::cgiv->{'sku'};
	$hash{'zoovy:prod_name'} = $ZOOVY::cgiv->{'prod_name'};
	$hash{'zoovy:base_cost'} = $ZOOVY::cgiv->{'cost'};
	$hash{'zoovy:ship_cost1'} = $ZOOVY::cgiv->{'suppliership'};
	$hash{'zoovy:prod_supplierid'} = $ZOOVY::cgiv->{'suppliersku'};
	$hash{'zoovy:prod_supplier'} = $CODE;
	&ZOOVY::saveproduct_from_hashref($USERNAME,$SKU,\%hash,"/$CODE");
	$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully added product $SKU</font><br><br>";
	$ACTION = 'GENERIC-ADDPRODUCTS';
	}

if ($ACTION eq 'GENERIC-ADDPRODUCTS') {
	$template_file = 'generic-addproducts.shtml';	
	push @BC, { name=>"Add Product" };
	}


##
##
##
if ($ACTION eq 'SAVE-GENERIC-SHIPPING') {

	my ($S) = SUPPLIER->new($USERNAME, $CODE);

	# deal with SHIPPING METHOD checkboxes
	# add up all the values for bitwise comparison
	my $total_shipping_method = ($ZOOVY::cgiv->{'GEN_SHIPMETHODS_1'}?1:0) + ($ZOOVY::cgiv->{'GEN_SHIPMETHODS_2'}?2:0) + ($ZOOVY::cgiv->{'GEN_SHIPMETHODS_32'}?32:0);

	# deal with SHIPPING OPTIONS checkboxes
	# add up all the values for bitwise comparison
	my $total_shipping_options = ($ZOOVY::cgiv->{'GEN_SHIPOPTIONS_1'}?1:0); 

	$S->save_property('USERNAME',$USERNAME);
	$S->save_property('GEN_SHIPMETHODS',$total_shipping_method);
	$S->save_property('GEN_SHIPORIGZIP', $ZOOVY::cgiv->{'GEN_SHIPORIGZIP'});
	$S->save_property('GEN_SHIPORIGSTATE', $ZOOVY::cgiv->{'GEN_SHIPORIGSTATE'});
	$S->save_property('GEN_SHIPPROVIDER', $ZOOVY::cgiv->{'GEN_SHIPPROVIDER'});
	$S->save_property('GEN_SHIPACCOUNT', $ZOOVY::cgiv->{'GEN_SHIPACCOUNT'});
	$S->save_property('GEN_SHIPOPTIONS', $total_shipping_options);
	$S->save_property('GEN_HNDPERORDER', $ZOOVY::cgiv->{'GEN_HNDPERORDER'});
	$S->save_property('GEN_HNDPERITEM', $ZOOVY::cgiv->{'GEN_HNDPERITEM'});
	$S->save_property('GEN_HNDPERUNIITEM', $ZOOVY::cgiv->{'GEN_HNDPERUNIITEM'});
	$S->save();
	
	$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully edited shipping for $CODE</font><br><br>";
	$ACTION = 'GENERIC-SHIPPING';
	}

if ($ACTION eq 'GENERIC-SHIPPING') {

	my ($S) = SUPPLIER->new($USERNAME, $CODE);

	# bitwise compare
	$GTOOLS::TAG{'<!-- GEN_SHIPMETHODS_1 -->'} = ($S->{'INFO'}->{'GEN_SHIPMETHODS'} & 1)?"checked":"";
	$GTOOLS::TAG{'<!-- GEN_SHIPMETHODS_2 -->'} = ($S->{'INFO'}->{'GEN_SHIPMETHODS'} & 2)?"checked":"";
	$GTOOLS::TAG{'<!-- GEN_SHIPMETHODS_32 -->'} = ($S->{'INFO'}->{'GEN_SHIPMETHODS'} & 32)?"checked":"";


	## Configure veribiage for Shipping Meter
	my $params = &ZTOOLKIT::parseparams($S->{'INFO'}->{'GEN_SHIPMETER'});

	if($params->{'type'} eq "UPS"){
		$GTOOLS::TAG{'<!-- GEN_SHIPMETER -->'} = $params->{'type'} ." Shipper #: ". $params->{'shipper_number'}. "<br>License: ". $params->{'license'};
		}	
	elsif($params->{'type'} eq "FEDEX"){
		$GTOOLS::TAG{'<!-- GEN_SHIPMETER -->'} = $params->{'type'} ." Account #: ". $params->{'account_number'}. "<br>Meter: ". $params->{'meter'};
		}	
	else{ $GTOOLS::TAG{'<!-- GEN_SHIPMETER -->'} = "None confirmed at this time..."; }
	##

	$GTOOLS::TAG{'<!-- GEN_SHIPOPTIONS_1 -->'} = ($S->{'INFO'}->{'GEN_SHIPOPTIONS'} & 1)?"checked":"";

	$GTOOLS::TAG{'<!-- GEN_HNDPERORDER -->'} = $S->{'INFO'}->{'GEN_HNDPERORDER'};
	$GTOOLS::TAG{'<!-- GEN_HNDPERITEM -->'} = $S->{'INFO'}->{'GEN_HNDPERITEM'};
	$GTOOLS::TAG{'<!-- GEN_HNDPERUNIITEM -->'} = $S->{'INFO'}->{'GEN_HNDPERUNIITEM'};

	$template_file = 'generic-shipping.shtml';
	push @BC, { name=>"Config Shipping" };
	}


################################################################
## Inventory Handler
##
if ($ACTION eq 'SAVE-GENERIC-INVENTORY') {
	my ($S) = SUPPLIER->new($USERNAME,$CODE);
	   $S->save_property('USERNAME',$USERNAME);
   $S->save_property('GEN_INVURL',$ZOOVY::cgiv->{'GEN_INVURL'});
   $S->save_property('GEN_INVTYPE',$ZOOVY::cgiv->{'GEN_INVTYPE'});
   $S->save_property('GEN_INVSKU',$ZOOVY::cgiv->{'GEN_INVSKU'});
   $S->save_property('GEN_INVSTOCK',$ZOOVY::cgiv->{'GEN_INVSTOCK'});
   $S->save_property('GEN_INVSHIP',$ZOOVY::cgiv->{'GEN_INVSHIP'});
   $S->save_property('GEN_INVAVAIL',$ZOOVY::cgiv->{'GEN_INVAVAIL'});
   $S->save_property('GEN_INVCOST',$ZOOVY::cgiv->{'GEN_INVCOST'});
   $S->save();

   $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully edited shipping for $CODE</font><br><br>";
   $ACTION = 'GENERIC-INVENTORY';

	}

##
##
##
if ($ACTION eq 'GENERIC-INVENTORY') {

	my ($S) = SUPPLIER->new($USERNAME, $CODE);

	if($S->{'INFO'}->{'GEN_INVTYPE'} eq 'CSV'){ $GTOOLS::TAG{'<!-- INV_TYPE_CSV -->'} = 'checked'; }
   else{ $GTOOLS::TAG{'<!-- INV_TYPE_CSV -->'} = ''; }
   if($S->{'INFO'}->{'GEN_INVTYPE'} eq 'TAB'){ $GTOOLS::TAG{'<!-- INV_TYPE_TAB -->'} = 'checked'; }
   else{ $GTOOLS::TAG{'<!-- INV_TYPE_TAB -->'} = ''; }

   $GTOOLS::TAG{'<!-- GEN_INVURL -->'} = $S->{'INFO'}->{'GEN_INVURL'};
   $GTOOLS::TAG{'<!-- GEN_INVSKU -->'} = $S->{'INFO'}->{'GEN_INVSKU'};
   $GTOOLS::TAG{'<!-- GEN_INVSTOCK -->'} = $S->{'INFO'}->{'GEN_INVSTOCK'};
   $GTOOLS::TAG{'<!-- GEN_INVSHIP -->'} = $S->{'INFO'}->{'GEN_INVSHIP'};
   $GTOOLS::TAG{'<!-- GEN_INVAVAIL -->'} = $S->{'INFO'}->{'GEN_INVAVAIL'};
   $GTOOLS::TAG{'<!-- GEN_INVCOST -->'} = $S->{'INFO'}->{'GEN_INVCOST'};

   $template_file = 'generic-inventory.shtml';
   push @BC, { name=>"Config Inventory" };

	}

################################################################
## ORDER SETUP Handler
##
## GEN_ORDERPREF
##    - choose whether Zoovy to handle reordering (2)
##    - or not (1)
##    - defaults to 0
## GEN_ORDERTYPE
##    - email (1)
##    - fax (2)
## 	- defaults to 0
##
if ($ACTION eq 'SAVE-GENERIC-ORDERING') {

   my ($S) = SUPPLIER->new($USERNAME,$CODE);
   $S->save_property('USERNAME',$USERNAME);
   $S->save_property('GEN_ORDERPREF',$ZOOVY::cgiv->{'GEN_ORDERPREF'});

   ## VALIDATION
   ## if Drop ship is choosen
   if ($ZOOVY::cgiv->{'GEN_ORDERPREF'} == 2){
      ## neither email or fax have been choosen
      if ($ZOOVY::cgiv->{'GEN_ORDERTYPE'} == 0){
         $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please choose a Transmission format (email or fax).</font><br><br>";
         }
      ## email has been choosen, but an invalid email has been supplied
      elsif (($ZOOVY::cgiv->{'GEN_ORDERTYPE'} == 1) && &ZTOOLKIT::validate_email($ZOOVY::cgiv->{'GEN_ORDEREMAIL'}) == 0) {
         $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please provide a valid Supplier email address.</font><br><br>";
         }
      ## fax has been choosen, but an invalid fax has been supplied
      elsif (($ZOOVY::cgiv->{'GEN_ORDERTYPE'} == 2) && &ZTOOLKIT::validate_phone($ZOOVY::cgiv->{'GEN_ORDERFAX'}) == 0) {
         $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please provide a valid Supplier fax number.</font><br><br>";
         }

      ## check if that subject and body exist
      if (!$ZOOVY::cgiv->{'GEN_ORDERSUBJECT'} || !$ZOOVY::cgiv->{'GEN_ORDERBODY'}){
         $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please make sure you have filled out an Order subject and body.</font><br><br>";
         }
      }
   ##


   ## no errors found
   if (!$GTOOLS::TAG{'<!-- RESULT -->'} ){

      $S->save_property('GEN_ORDERTYPE',$ZOOVY::cgiv->{'GEN_ORDERTYPE'});
      $S->save_property('GEN_ORDERSUBJECT',$ZOOVY::cgiv->{'GEN_ORDERSUBJECT'});
      $S->save_property('GEN_ORDERBODY',$ZOOVY::cgiv->{'GEN_ORDERBODY'});
      $S->save_property('GEN_ORDEREMAIL',$ZOOVY::cgiv->{'GEN_ORDEREMAIL'});
      $S->save_property('GEN_ORDEREMAIL_SRC', $ZOOVY::cgiv->{'GEN_ORDEREMAIL_SRC'});
      $S->save_property('GEN_ORDERFAX',$ZOOVY::cgiv->{'GEN_ORDERFAX'});
      $S->save_property('GEN_ORDERATTACH',$ZOOVY::cgiv->{'GEN_ORDERATTACH'});

      $S->save();
      $GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully edited order setup for $CODE</font><br><br>";
      }

   $ACTION = 'GENERIC-ORDERING';
   }

##
## 
##
if ($ACTION eq 'GENERIC-ORDERING') {

   my ($S) = SUPPLIER->new($USERNAME, $CODE);

   ## see if the merchant has chosen to have ZOOVY deliver orders
   if($S->{'INFO'}->{'GEN_ORDERPREF'} == 1 || $ZOOVY::cgiv->{'GEN_ORDERPREF'} == 1){
      $GTOOLS::TAG{'<!-- GEN_ORDERPREF_1 -->'} = 'checked';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERPREF_1 -->'} = ''; }
   if($S->{'INFO'}->{'GEN_ORDERPREF'} == 2 || $ZOOVY::cgiv->{'GEN_ORDERPREF'} == 2){
      $GTOOLS::TAG{'<!-- GEN_ORDERPREF_2 -->'} = 'checked';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERPREF_2 -->'} = ''; }

   ## see if the merchant has chosen to deliver order via email and/or fax
   if($S->{'INFO'}->{'GEN_ORDERTYPE'} == 1 || $ZOOVY::cgiv->{'GEN_ORDERTYPE'} == 1){
      $GTOOLS::TAG{'<!-- GEN_ORDERTYPE_1 -->'} = 'checked';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERTYPE_1 -->'} = ''; }
   if($S->{'INFO'}->{'GEN_ORDERTYPE'} == 2 || $ZOOVY::cgiv->{'GEN_ORDERTYPE'} == 2){
      $GTOOLS::TAG{'<!-- GEN_ORDERTYPE_2 -->'} = 'checked';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERTYPE_2 -->'} = ''; }

   ## selected format for the Order Attachment
   if($S->{'INFO'}->{'GEN_ORDERATTACH'} == 1 || $ZOOVY::cgiv->{'GEN_ORDERATTACH'}==1){
      $GTOOLS::TAG{'<!-- GEN_ORDERATTACH_1 -->'} = 'selected';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERATTACH_1 -->'} = ''; }
   if($S->{'INFO'}->{'GEN_ORDERATTACH'} == 2 || $ZOOVY::cgiv->{'GEN_ORDERATTACH'}==2){
      $GTOOLS::TAG{'<!-- GEN_ORDERATTACH_2 -->'} = 'selected';
      }
   else{ $GTOOLS::TAG{'<!-- GEN_ORDERATTACH_2 -->'} = ''; }

	## confirmation required
   if($S->{'INFO'}->{'GEN_ORDERCONF'} == 1 || $ZOOVY::cgiv->{'GEN_ORDERCONF'} == 1){ 
		$GTOOLS::TAG{'<!-- GEN_ORDERCONF -->'} = "checked";
		}
	else{$GTOOLS::TAG{'<!-- GEN_ORDERCONF -->'} = ''; }

	## other params
   $GTOOLS::TAG{'<!-- GEN_ORDEREMAIL -->'} = ($S->{'INFO'}->{'GEN_ORDEREMAIL'}?$S->{'INFO'}->{'GEN_ORDEREMAIL'}:$ZOOVY::cgiv->{'GEN_ORDEREMAIL'});
   $GTOOLS::TAG{'<!-- GEN_ORDERFAX -->'} = ($S->{'INFO'}->{'GEN_ORDERFAX'}?$S->{'INFO'}->{'GEN_ORDERFAX'}:$ZOOVY::cgiv->{'GEN_ORDERFAX'});
   $GTOOLS::TAG{'<!-- GEN_ORDERSUBJECT -->'} = ($S->{'INFO'}->{'GEN_ORDERSUBJECT'}?$S->{'INFO'}->{'GEN_ORDERSUBJECT'}:$ZOOVY::cgiv->{'GEN_ORDERSUBJECT'});
   $GTOOLS::TAG{'<!-- GEN_ORDERBODY -->'} = ($S->{'INFO'}->{'GEN_ORDERBODY'}?$S->{'INFO'}->{'GEN_ORDERBODY'}:$ZOOVY::cgiv->{'GEN_ORDERBODY'});

   $GTOOLS::TAG{'<!-- CONFIRMATION_PAGE -->'} = "http://".lc($USERNAME).".zoovy.com/confirm.cgis"; 

   use AUTOEMAIL;
   $GTOOLS::TAG{'<!-- GEN_ORDEREMAIL_SRC -->'} = &AUTOEMAIL::find_email($USERNAME);

	$template_file = 'generic-ordering.shtml';
	push @BC, { name=>"Config Ordering" };
	}


##
##
## 
if ($ACTION eq 'SAVE-GENERIC-EDIT') {

print STDERR "$ACTION\n";

	require WHOLESALE;
	if (&ZTOOLKIT::validate_email($ZOOVY::cgiv->{'COMPANY_EMAIL'}) == 0) {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please supply a valid Company email address.</font><br><br>";
		}
	elsif ($ZOOVY::cgiv->{'COMPANY_ACCOUNT'} eq '') {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please supply a valid Company account.</font><br><br>";
		}
	elsif (&ZTOOLKIT::validate_phone($ZOOVY::cgiv->{'COMPANY_PHONE'}) == 0) {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please supply a valid Company phone.</font><br><br>";
		}
	elsif ($ZOOVY::cgiv->{'MARKUP'} eq '' || &WHOLESALE::validate_formula($ZOOVY::cgiv->{'MARKUP'}) == 0) {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please supply a valid Default Markup.</font><br><br>";
		}
	elsif ($ZOOVY::cgiv->{'COMPANY_NAME'} eq '') {
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='red'>Please supply a Company Name.</font><br><br>";
		}

	else {
		my ($S) = SUPPLIER->new($USERNAME, $CODE);
	
		$S->save_property('MARKUP', $ZOOVY::cgiv->{'MARKUP'});
		$S->save_property('COMPANY_NAME',$ZOOVY::cgiv->{'COMPANY_NAME'});
		$S->save_property('COMPANY_ACCOUNT',$ZOOVY::cgiv->{'COMPANY_ACCOUNT'});
		$S->save_property('COMPANY_PHONE',$ZOOVY::cgiv->{'COMPANY_PHONE'});
		$S->save_property('COMPANY_EMAIL',$ZOOVY::cgiv->{'COMPANY_EMAIL'});
		$S->save_property('COMPANY_WEBSITE',$ZOOVY::cgiv->{'COMPANY_WEBSITE'});

		$S->save();
		$GTOOLS::TAG{'<!-- RESULT -->'} = "<font color='blue'>Successfully edited Company Information for $CODE</font><br><br>";
		}

   $ACTION = 'EDIT';
   }

##
## 
##
if (($ACTION eq 'EDIT') || ($ACTION eq 'JEDI-EDIT') || ($ACTION eq 'GENERIC-EDIT')) {
	$GTOOLS::TAG{'<!-- CODE -->'} = $CODE;
	$GTOOLS::TAG{'<!-- MARKUP -->'} = ($info->{'MARKUP'})?$info->{'MARKUP'}:$ZOOVY::cgiv->{'MARKUP'};
	$GTOOLS::TAG{'<!-- MODE -->'} = $info->{'MODE'};
	$GTOOLS::TAG{'<!-- COMPANY_PHONE -->'} = ($info->{'COMPANY_PHONE'})?$info->{'COMPANY_PHONE'}:$ZOOVY::cgiv->{'COMPANY_PHONE'};
	$GTOOLS::TAG{'<!-- COMPANY_EMAIL -->'} = ($info->{'COMPANY_EMAIL'})?$info->{'COMPANY_EMAIL'}:$ZOOVY::cgiv->{'COMPANY_EMAIL'};
	$GTOOLS::TAG{'<!-- COMPANY_NAME -->'} = ($info->{'COMPANY_NAME'})?$info->{'COMPANY_NAME'}:$ZOOVY::cgiv->{'COMPANY_NAME'};
	$GTOOLS::TAG{'<!-- COMPANY_ACCOUNT -->'} = ($info->{'COMPANY_ACCOUNT'})?$info->{'COMPANY_ACCOUNT'}:$ZOOVY::cgiv->{'COMPANY_ACCOUNT'};
	$GTOOLS::TAG{'<!-- COMPANY_WEBSITE -->'} = ($info->{'COMPANY_WEBSITE'})?$info->{'COMPANY_WEBSITE'}:$ZOOVY::cgiv->{'COMPANY_WEBSITE'};

	if ($info->{'MODE'} eq 'GENERIC') {
		$template_file = 'generic-edit.shtml';
		push @BC, { name=>"Setup" };
		}
	elsif ($info->{'MODE'} eq 'JEDI') {

		my $prodsref = &PRODUCT::BATCH::list_by_attrib($USERNAME,'zoovy:prod_supplier',$CODE);
		my $c = '';
		foreach my $k (@{$prodsref}) {
			$c .= "<tr><td>$k</td></tr>";
			}
		$GTOOLS::TAG{'<!-- PRODUCTS -->'} = $c;
		
		$GTOOLS::TAG{'<!-- JEDI_USERNAME -->'} = $info->{'JEDI_USERNAME'};
		$GTOOLS::TAG{'<!-- JEDI_CUSTOMER -->'} = $info->{'JEDI_CUSTOMER'};
		$template_file = 'jedi-edit.shtml';
		push @BC, { name=>"Setup" };
		}
	else {
		$template_file = 'corrupt-edit.shtml';
		}
	
	}

	

##
##
##
if ($ACTION eq 'REMOVE') {
	$template_file = 'remove-confirm.shtml';
	push @BC, { name=>"Remove" };
	}

if ($ACTION eq 'REMOVE-CONFIRM') {
	my $qtCODE = $dbh->quote($CODE);
	my $pstmt = "delete from SUPPLIERS where MID=$MID and CODE=$qtCODE";
	print STDERR $pstmt."\n";
	$dbh->do($pstmt);
	$ACTION = '';
	}

##
## 
##
if ($ACTION eq '') {
	my $c = '';
	
	my $pstmt = "select CODE,COMPANY_NAME,MODE from SUPPLIERS where MID=$MID";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my $count = 0;
	while ( my ($code,$name,$mode) = $sth->fetchrow() ) {
		$count++;
		if ($mode eq '') {  $mode = '**INVALID**';  }
		$c .= "<tr class=\"table_bg".(($count%2)+1)."\"><td>[<a href=\"index.cgi?ACTION=EDIT&CODE=$code\">Manage</a>]</td><td nowrap>$code</td><td nowrap>$name</td><td nowrap>$mode</td></tr>";
		}
	$sth->finish();
	
	if ($c eq '') {
		$GTOOLS::TAG{'<!-- SUPPLIERS -->'} = '<tr class="table_bg1"><td colspan="5"><i>No suppliers currently exist.</i></td>'; 
		}
	else {
		$GTOOLS::TAG{'<!-- SUPPLIERS -->'} = "$c";
		}
	push @BC, { name=>"Suppliers" };
	}


&GTOOLS::output(
	'file'=>$template_file,
	'title'=>$title,
	'header'=>1,
	'help'=>'detail/utilities-suppliers.php',
	'bc'=>\@BC,
	'tabs'=>\@TABS,
	);

&DBINFO::db_zoovy_close();
