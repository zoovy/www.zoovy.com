#!/usr/bin/perl -w
use strict;

use POSIX qw (strftime);
use Date::Parse;

use lib "/httpd/modules";
require GTOOLS;
require ZOOVY;
require DBINFO;
require ZTOOLKIT;
require ZTOOLKIT::SECUREKEY;
require ZWEBSITE;
require TRIAL;
require TODO;

&ZOOVY::init();
&GTOOLS::init();

my ($USERNAME,$FLAGS,$MID,$LUSER) = &ZOOVY::authenticate("/biz",6);
if (not defined $FLAGS) { $FLAGS = ''; }
if ($USERNAME eq '') { exit; }

$GTOOLS::TAG{'<!-- MERCHANT -->'} = $USERNAME;
$GTOOLS::TAG{'<!-- USERNAME -->'} = $LUSER;

my $host = &ZOOVY::servername();

my $ACTION = defined($ZOOVY::cgiv->{'ACTION'}) ? $ZOOVY::cgiv->{'ACTION'} : '';
if ($ACTION eq 'FEATURESET') {
	my $LEVEL = defined($ZOOVY::cgiv->{'LEVEL'}) ? $ZOOVY::cgiv->{'LEVEL'} : '';
	require ZWEBSITE;
	&ZWEBSITE::save_website_attrib($USERNAME,'usermode',$LEVEL);
	}

my $TITLE = ''; my $template_file = ''; my $HEAD = '';

if (($FLAGS eq '') || ($FLAGS =~ /TRIAL/) || ($FLAGS !~ /BASIC/)) {
	require ZACCOUNT;
	$FLAGS = &ZACCOUNT::BUILD_FLAG_CACHE($USERNAME);
	}


my @BC = ();
my @TABS = ();
if (index($FLAGS,',LOCKOUT,')>=0) {
	$template_file = 'index-lockout.shtml'; $TITLE = 'Account Locked';
	}
elsif (index($FLAGS,',DISABLE,')>=0) {
	$template_file = 'index-disable.shtml'; $TITLE = 'Disable';
	}
elsif ($FLAGS !~ /TRIAL/ && $FLAGS !~ /BASIC/) {
	$template_file = 'index-noaccess.shtml'; $TITLE = 'Trial Expired';
	} 
elsif (($FLAGS =~ /TRIAL/i) || (0)) {
	##
	##  TRIAL SECTION
	##
	$FLAGS = ",$FLAGS,";
	$template_file = 'index-trial.shtml'; $TITLE = 'Trial Homepage'; 
	push @BC, { name=>'Trial Homepage', };

	push @TABS, { 'name'=>'Introduction', 'link'=>'index.cgi', 'target'=>'_top' };
	# push @TABS, { 'name'=>'Pricing', 'link'=>'https://www.zoovy.com/biz/configurator/index.cgi', 'target'=>'_top' };

	# create persistence
	&DBINFO::db_zoovy_connect();
	my ($LENGTH, $TODAY) = TRIAL::day_of_trial($USERNAME);
	$GTOOLS::TAG{"<!-- TODAY -->"} = $TODAY;
	$GTOOLS::TAG{"<!-- LENGTH -->"} = $LENGTH;
	$GTOOLS::TAG{"<!-- REMAINING -->"} = $LENGTH - $TODAY;
	if (($GTOOLS::TAG{'<!-- REMAINING -->'} > 15) || (index($FLAGS,',RENEW,')>=0)) {
		$GTOOLS::TAG{"<!-- HIDE15_START -->"} = '<!-- ';
		$GTOOLS::TAG{"<!-- HIDE15_END -->"} = ' --> ';
		}

	my $c = '';
	my $todo = TODO->new($USERNAME);
	$todo->verify();
	my $htag = '';
	foreach my $task (@{$todo->list()}) {
		$htag = '';
		if ($task->{'completed'}>0) { $htag = '<strike><font color="444444">'; }
		$c .= "<tr>";
		if ($task->{'completed'}==0) { $c .= '<td><img src="/biz/images/todo.gif"></td>'; } else { $c .= "<td></td>"; }
		$c .= "<td class='menuitem'><a target=\"_top\" href=\"$task->{'link'}\" class=\"text\">$htag$task->{'name'}</a></td>";
		$c .= "</tr>";
		}
	$GTOOLS::TAG{'<!-- TODOLIST -->'} = $c;

	my (@TIPS);
	push @TIPS, "With Zoovy you can use promotions such as discounts and free shipping to increase sales, to configure a promotion visit the SETUP area.";
	push @TIPS, "Use Zoovy's Marketing Channels feature to launch auctions on Ebay and Yahoo.";
	push @TIPS, "With Zoovy you can use Product Options to create a single product with different sizes, colors, and more.";
	push @TIPS, "If you wish you can change your username when you sign up for an account.";
	push @TIPS, "Zoovy's Rules Based Shipping let you make special handling rules for special item combinations in an customers shopping cart.";
	push @TIPS, "The Zoovy FastTrack service is an affordable way to get your website started ASAP.";
	push @TIPS, "Zoovy's can synchronize with popular account packages such as Quickbooks.";
	push @TIPS, "Make sure you download and try Zoovy's powerful order manager.";
	push @TIPS, "Zoovy supports several different types of customer management for your store, visit the Website Properties in the setup are for more information.";
	push @TIPS, "With the Zoovy Order Manager you can easily send targeted newletters for example only email customers who have purchased in the last 3 months";
	push @TIPS, "Zoovy Developer makes it easy to integrate Zoovy into any third party website or technology you might need.";
	push @TIPS, "Tired of shipping? Zoovy has partnered with several fulfillment vendors who can ship your products for you. Email support\@zoovy.com for more details.";
	push @TIPS, "Make sure you download the Windows clients at <a href=\"http://www.zoovy.com/biz/downloads\">http://www.zoovy.com/biz/downloads</a>!";
	push @TIPS, "You can manage your Zoovy store directly from the web, or using Zoovy's Windows software.\n";
	push @TIPS, "Your Zoovy store can let you offer promotions, visit Setup and then click \"Promotions\" for more information\n";
	push @TIPS, "Zoovy provides detailed sales, and traffic reports. Just click the Manage tab along the top of the screen to access them.\n";
	push @TIPS, "Using Zoovy's Channels you can effectively market your products and services to a variety of different portals.\n";

	#$GTOOLS::TAG{'<!-- TIP -->'} = 'Don\'t run with sharp objects.';
	srand(time());
	$GTOOLS::TAG{'<!-- TIP -->'} = $TIPS[(rand()*100%scalar(@TIPS))];

	my $GOTO = $ZOOVY::cgiv->{'GOTO'};
	my $SET = $ZOOVY::cgiv->{'SET'};
	my $BACK = $ZOOVY::cgiv->{'BACK'};
	$GTOOLS::TAG{"<!-- BACK -->"} = $BACK;

	if ($GOTO) {
		&TRIAL::setstatus($USERNAME,$SET,'1');
		print "Location: $GOTO\n\n";
		exit;
		}

	##
	## GEneric main menu
	$template_file = "index-trial.shtml";

	if ($FLAGS =~ /,PKG=APPAREL,/i) {
		$template_file = 'trial-pkg-APPAREL.shtml';
		push @BC, { name=>'Apparel Edition', };
		}
	elsif ($FLAGS =~ /,PKG=MEDIA,/i) {
		$template_file = 'trial-pkg-MEDIA.shtml';
		push @BC, { name=>'Media Edition', };
		}
	elsif ($FLAGS =~ /,PKG=STORE,/i) {
		$template_file = 'trial-pkg-STORE.shtml';
		push @BC, { name=>'Storefront Edition', };
		}
	else {
		$template_file = 'trial-pkg-EBAY.shtml';
		push @BC, { name=>'eBay Edition', };
		}

	my %KEY = ();
	my $dbh = &DBINFO::db_zoovy_connect();
	my $pstmt = "select SALESPERSON from ZUSERS where USERNAME=".$dbh->quote($USERNAME);
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my ($OWNER) = $sth->fetchrow();
	$sth->finish();
	$GTOOLS::TAG{'<!-- OWNER -->'} = ucfirst($OWNER);
	&DBINFO::db_zoovy_close();

	} 
else {
	##
	## Main User Login
	##
	$template_file = 'index-main.shtml'; $TITLE = "Logged in to Zoovy connected to $host.zoovy.com!";
	push @BC, { name=>'Home', };
	if ($LUSER eq '') {

		my ($helplink,$helphtml) = GTOOLS::help_link('Manage User Logins', 50292);
		$GTOOLS::TAG{'<!-- MASTER_LOGIN -->'} = qq~
<tr><td colspan='3'><center><table border=0 cellpadding=3 width=95% class="table_stroke"><tr><td>
<span class="alert">MASTER ACCOUNT LOGIN: </span>
You are currently logged into the master account which has administrative privileges. 
You should go to Setup / User Manager and create unique logins for each person who has access to this account.<br>
If you are the only person who uses this account, then you may safely ignore this message.<br>
<br>
<font size=1><a target="_webdoc" href="$helplink"><i>What is this, and why did this change?</i></a></font>
</font>
</td></tr></table>
</center>
</td></tr>
		~;
		}




	
	my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
	$year+=2000; $mon+=1;

	my %TOPICS = (
		'enhance'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/enhancements.gif',
		'feature'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/new_feature.gif',
		'general'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/general.gif',
		'outage'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/outage.gif',
		'aol'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/aol.gif',
		'zwm'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/zwm.gif',
		'crm'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/crm.gif',
		'ebay'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/ebay_manager.gif',
		'ebaystore'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/ebaystores.gif',
		'overstock'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/overstock.gif',
		'froogle'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/froogle.gif',
		'newsletter'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/newsletter.gif',
		'sc'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/supplychain.gif',
		'pricegrab'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/pricegrabber.gif',
		'dealtime'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/dealtime.gif',	
		'nextag'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/nextag.gif',	
		'image'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/image.gif',	
		'design'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/design.gif',	
		'html'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/html.gif',	
		'google'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/zoovy/logos/google.gif',	
		'fedex'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/zoovy/logos/fedex.gif',	
		'ups'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/zoovy/logos/ups.gif',	
		'proshop'=>'http://static.zoovy.com/img/proshop/W64-H64-Bffffff/newsicons/proshop.gif',	
	);	
	
	my $dbh = &DBINFO::db_zoovy_connect();
	my $qtRESELLER = $dbh->quote($ZOOVY::RESELLER);
	my $pstmt = "select * from RECENT_NEWS where EXPIRES>now() and CREATED<now() order by ID desc";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my $c = '';
	while ( my $hashref = $sth->fetchrow_hashref() ) {
		my $created = strftime("%D<br>",localtime(&ZTOOLKIT::mysql_to_unixtime($hashref->{'CREATED'})));
		my $URL = $TOPICS{$hashref->{'TOPIC'}};
		if ($URL eq '') { $URL = $TOPICS{'general'}; }
		$c .= qq~
		<tr>
		<td bgcolor='FFFFFF' valign='top'>
			<img src="$URL" width=64 height=64><br>
			<font face='verdana, helvetica, arial' size='1'>$created</font>	
		</td>
		<td bgcolor='FFFFFF' valign='top'><font face='verdana, helvetica, arial' size='2'>
		<b>$hashref->{'TITLE'}</b>
		<br>$hashref->{'MESSAGE'}<br>
		</font></td>
		</tr>
		~;
		}
	$sth->finish();

	$GTOOLS::TAG{"<!-- RECENT_NEWS -->"} = $c;
	$c = '';

	open F, ">>/tmp/login.log";
	print F "$mon/$mday/$year - $hour:$min:$sec ".$ENV{"REMOTE_ADDR"}." -> ".$USERNAME."\n";
	close F;

	my $MIDNIGHT_TS = Date::Parse::str2time(strftime("%Y-%m-%d 00:00:00", localtime(time())));

	require ORDER::STATS;
	my ($count,$sum) = &ORDER::STATS::quick_stats($USERNAME,$MID,$MIDNIGHT_TS);
	$sum = sprintf("%.2f",$sum);
	$GTOOLS::TAG{'<!-- RECENT_ORDERS -->'} = qq~
		<tr><td>Total Orders</td><td>$count</td></tr>
		<tr><td>Gross Sales</td><td>\$$sum</td></tr>
		~;
	
	require STATS;
	$GTOOLS::TAG{'<!-- RECENT_VISITORS -->'} = "<tr><td>Page Views:</td><td>".&STATS::quick_stats($USERNAME,$MID,$MIDNIGHT_TS)."</td></tr>";

	my $todo = TODO->new($USERNAME);
	$todo->verify();
	$c = '';	
	foreach my $task (@{$todo->list()}) {
		next if ($task->{'completed'});
		$c .= "<tr><td>";
		if ($task->{'link'} ne '') { $c .= "<a target=\"_top\" href=\"$task->{'link'}\">"; }
		$c .= $task->{'name'};
		if ($task->{'link'} ne '') { $c .= "</a>"; }
		$c .= "</td></tr>";
		}
	if ($c eq '') { $c .= "<tr><td><i>Empty</i></td></tr>"; }
	$GTOOLS::TAG{'<!-- TODOLIST -->'} = $c;

	$GTOOLS::TAG{'<!-- TESTCODE -->'} = &ZTOOLKIT::SECUREKEY::gen_key($USERNAME,'XX');
	&DBINFO::db_zoovy_close();

	$HEAD = qq~<link rel="alternate" title="Zoovy News RSS" href="http://support.zoovy.com/news.cgi/$USERNAME.rss" type="application/rss+xml">~;

	} 

&GTOOLS::output(
	header=>1,
	bc=>\@BC,
	tabs=>\@TABS,
	head=>$HEAD,
	title=>$TITLE,
	help=>"#50727",
	file=>$template_file,
	);

exit();
