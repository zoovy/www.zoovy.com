#!/usr/bin/perl

use lib "/httpd/modules";

##
## parameters:
##
##		attrib=zoovy:property -- set an attrib
##
##

use CGI;
require GTOOLS;
require ZTOOLKIT;
require ZOOVY;
require MEDIA;

my $q = new CGI;

my $s = {};
if (not defined $q->param('s')) {
	exit;
	}

print STDERR "S: ".$q->param('s')."\n";

$s = &ZTOOLKIT::fast_deserialize($q->param('s'),1);
my $USERNAME = $s->{'USERNAME'};
foreach my $p ($q->param()) { 
	next if ($p eq 'USERNAME');
	next if ($p eq 's');
	next if ($p eq 'upfile');
	$s->{$p} = $q->param($p); 
	}


## figure out the correct cancellation links
my $JS = 'top.close();';
if ($s->{'mode'} eq 'flow') {
	if ($s->{'PROD'} ne '') {
		## we're editing a product
		$JS = "parent.window.location='/biz/product/flow/preview.cgi?PROD=$s->{'PROD'}&FL=$s->{'FL'}&EL=$s->{'EL'}&FS=$s->{'FS'}&PG=".CGI->escape($s->{'PG'})."';\n\n";
		}
	else {
		## we're editing a webpage.
		$JS = "parent.window.location='/biz/setup/builder/preview.cgi?PROD=$s->{'PROD'}&FL=$s->{'FL'}&EL=$s->{'EL'}&FS=$s->{'FS'}&PG=".CGI->escape($s->{'PG'})."';\n\n";
		}
	}
$GTOOLS::TAG{'<!-- CANCELLINK -->'} = $JS;


## Upload command.
if ($s->{'ACTION'} eq 'UPLOAD') {
	my $fh = $q->param('upfile');
	my $BUFFER = '';
	my $filename = $fh;
	print STDERR "FILENAME: $filename\n";
	if (not defined $fh) {
		## Crap, not defined!
		}
	elsif ($filename =~ m/^http[s]?:\/\//i) {
		require ZURL;
		$BUFFER = &ZURL::snatch_url($filename.'');
		}
	elsif (defined $fh) {
		while (<$fh>) { $BUFFER .= $_; }
		}

	## convert S:\path\to\file.jpg to just file.jpg
	if (index($filename,'\\')>=0) { $filename = substr($filename,rindex($filename,'\\')+1); }
	## convert dir/file.jpg to just file.jpg
	if (index($filename,'/')>=0) { $filename = substr($filename,rindex($filename,'/')+1); }
	$filename =~ s/-/_/gs;

	##
	## Sanity: at this point the image is uploaded!

	if ($BUFFER ne '') {
		if (($s->{'PWD'} eq '') || ($s->{'PWD'} eq '/')) {
			## auto-select directoyr
			}
		else {
			## save into a specific directory
			$filename = "$s->{'PWD'}/$filename";
			}
		# $f = "$PWD/$f";
		my ($iref) = &MEDIA::store($USERNAME,$filename,$BUFFER);
		# my ($CODE,$NAME) = &IMGLIB::create_collection($USERNAME,$f,$e,\$BUFFER); 
		if (defined $iref) {
			$s->{'IMG'} = &MEDIA::iref_to_imgname($USERNAME,$iref);
			}
		if ($resultref->{'err'}>0) {
			$GTOOLS::TAG{'<!-- MESSAGE -->'} = &GTOOLS::errmsg("ERROR: $resultref->{'err'} $resultref->{'errmsg'}");
			}
		}
	}


my $img = $s->{'IMG'};
$GTOOLS::TAG{'<!-- PWD -->'} = $s->{'PWD'};
if ($s->{'IMG'} ne '') {
	$GTOOLS::TAG{'<!-- IMG -->'} = $s->{'IMG'};
	$GTOOLS::TAG{'<!-- PRETTY_IMGNAME -->'} = $s->{'IMG'};
	require MEDIA;
	my $iref = &MEDIA::getinfo($USERNAME,$s->{'IMG'});
	if (defined $iref) {
		$GTOOLS::TAG{'<!-- IMGSIZE -->'} = sprintf("%.2f",$iref->{'MasterSize'}/1000).'k';
		}
	}
else {
	$GTOOLS::TAG{'<!-- IMG -->'} = '';
	$GTOOLS::TAG{'<!-- PRETTY_IMG -->'} = '* Not Set *';
	$GTOOLS::TAG{'<!-- IMGSIZE -->'} = '0k';
	}


delete $s->{'ACTION'};
$GTOOLS::TAG{'<!-- SERIAL -->'} = &ZOOVY::incode(&ZTOOLKIT::fast_serialize($s,1));
$GTOOLS::TAG{'<!-- IMGURL -->'} = ($img)?&GTOOLS::imageurl($USERNAME,$img,110,110,'ffffff'):'/images/image_not_selected.gif';


&GTOOLS::output( file=>'popup-top.shtml', header=>1 );
