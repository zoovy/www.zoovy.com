#!/usr/bin/perl

use lib "/httpd/modules";
use ZOOVY;
use GTOOLS;
use ZACCOUNT;
use DBINFO;
use strict;
use FUSEMAIL;

&ZOOVY::init();
&GTOOLS::init();
my $dbh = &DBINFO::db_zoovy_connect();
my ($MERCHANT,$FLAGS,$MID,$LUSER) = &ZOOVY::authenticate('/biz',2,'_ADMIN');
$FLAGS = ",$FLAGS,";
if ($MERCHANT eq '') { exit; }
$GTOOLS::TAG{'<!-- MERCHANT -->'} = $MERCHANT;
my $ACTION = $ZOOVY::cgiv->{'ACTION'};

if ($FLAGS =~ /,BASIC,/) {
	if ($FLAGS !~ /,ZM,/) {
		## triple check we don't have a ,ZM, flag now.
		$FLAGS .= ",".&ZACCOUNT::BUILD_FLAG_CACHE($MERCHANT);
		}
 	}
print STDERR "FLAGS: $FLAGS\n";

my $template_file = 'index.shtml';
my @ERRORS = ();

if ($ACTION eq 'NUKE') {
	$template_file = 'nukewarn.shtml';
	$GTOOLS::TAG{'<!-- UID -->'} = $ZOOVY::cgiv->{'UID'};
	$GTOOLS::TAG{'<!-- LUSER -->'} = $ZOOVY::cgiv->{'LUSER'};
	}

if ($ACTION eq 'NUKECONFIRM') {	
	my $UID = int($ZOOVY::cgiv->{'UID'});
	my $pstmt = "select LUSER from ZUSER_LOGIN where MID=$MID and UID=$UID limit 0,1";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my ($LUSER) = $sth->fetchrow();
	$sth->finish();

	if ($LUSER ne 'admin') {
		&FUSEMAIL::account_terminate($MERCHANT,$LUSER);
		}

	$pstmt = "delete from ZUSER_LOGIN where MID=$MID and UID=$UID limit 1";
	print STDERR $pstmt."\n";
	$dbh->do($pstmt);
	$ACTION = '';
	}

my $UREF = {};
if ($ACTION eq 'SAVE') {
	my $LUSER = lc($ZOOVY::cgiv->{'username'});
	if ($LUSER eq '') { push @ERRORS, 'Username is blank!'; }
	if ($LUSER =~ /^support/) { push @ERRORS, 'Usernames containing the word "support" are not valid, please choose a different name.'; }
	if ($LUSER =~ /^admin$/) { push @ERRORS, 'Username "admin" is not valid, please choose a different name.'; }
	if ($LUSER =~ /^zoovy/) { push @ERRORS, 'Usernames containing the word "zoovy" are not valid, please choose a different name.'; }
	if ($LUSER =~ /[^\w]/) { push @ERRORS, 'Username contains invalid characters (allowed: A-Z 0-9)'; }
	$UREF->{'LUSER'} = $LUSER;

	my $PASSWORD = $ZOOVY::cgiv->{'password'};
	$UREF->{'PASSWORD'} = $PASSWORD;

	my $qtPHONE = $dbh->quote($ZOOVY::cgiv->{'phone'});
	$UREF->{'PHONE'} = $ZOOVY::cgiv->{'phone'};
	my $qtTITLE = $dbh->quote($ZOOVY::cgiv->{'title'});
	$UREF->{'JOBTITLE'} = $ZOOVY::cgiv->{'title'};
	my $qtFULLNAME = $dbh->quote($ZOOVY::cgiv->{'fullname'});
	$UREF->{'FULLNAME'} = $ZOOVY::cgiv->{'fullname'};
	my $qtEMAIL = $dbh->quote($ZOOVY::cgiv->{'email'});
	$UREF->{'EMAIL'} = $ZOOVY::cgiv->{'email'};

	$UREF->{'IS_ADMIN'} = "N"; if ($ZOOVY::cgiv->{'IS_ADMIN'}) { $UREF->{'IS_ADMIN'} = "Y"; }
	$UREF->{'ALLOW_FORUMS'} = "N"; if ($ZOOVY::cgiv->{'ALLOW_FORUMS'}) { $UREF->{'ALLOW_FORUMS'} = "Y"; }
	$UREF->{'IS_CUSTOMERSERVICE'} = "N"; if ($ZOOVY::cgiv->{'IS_CUSTOMERSERVICE'}) { $UREF->{'IS_CUSTOMERSERVICE'} = "Y"; }
	$UREF->{'IS_BILLING'} = "N"; if ($ZOOVY::cgiv->{'IS_BILLING'}) { $UREF->{'IS_BILLING'} = "Y"; }

	my $expires = 0;
	$UREF->{'EXPIRES_GMT'} = 0;
	if ($ZOOVY::cgiv->{'expires'} ne '') {
		require Date::Parse;
		$expires = Date::Parse::str2time($ZOOVY::cgiv->{'expires'});
		if ($expires eq '') { push @ERRORS, "Expires data was not valid try MM/DD/YY format"; }
		$UREF->{'EXPIRES_GMT'} = $expires;
		}
	
	my $i = 0;
	$UREF->{'FLAG_SETUP'} = 0; $i = 1; while ($i<16384) { if ($ZOOVY::cgiv->{'setup_'.$i}) { $UREF->{'FLAG_SETUP'} += $i; } $i *= 2; }
	$UREF->{'FLAG_PRODUCTS'} = 0; $i = 1; while ($i<16384) { if ($ZOOVY::cgiv->{'product_'.$i}) { $UREF->{'FLAG_PRODUCTS'} += $i; } $i *= 2; }
	$UREF->{'FLAG_ORDERS'} = 0; $i = 1; while ($i<16384) { if ($ZOOVY::cgiv->{'order_'.$i}) { $UREF->{'FLAG_ORDERS'} += $i } $i *= 2; }
	$UREF->{'FLAG_MANAGE'} = 0; $i = 1; while ($i<16384) { if ($ZOOVY::cgiv->{'manage_'.$i}) { $UREF->{'FLAG_MANAGE'} += $i; } $i *= 2; }
	$UREF->{'FLAG_ZOM'} = 0; $i = 1; while ($i<16384) { if ($ZOOVY::cgiv->{'zom_'.$i}) { $UREF->{'FLAG_ZOM'} += $i; } $i *= 2; }

	$UREF->{'HAS_EMAIL'} = 'N';
	if ($FLAGS =~ /,ZM,/) {
		if ($ZOOVY::cgiv->{'ZOOVYMAIL'}) { 
			$UREF->{'HAS_EMAIL'}='Y'; 
			}
		}

	if (scalar(@ERRORS)==0) {
		my $pstmt = '';
		if ((not defined $ZOOVY::cgiv->{'UID'}) || ($ZOOVY::cgiv->{'UID'} eq '') || ($ZOOVY::cgiv->{'UID'} eq '0')) {
			$UREF->{'CREATED_GMT'} = $^T;
			$UREF->{'MID'} = $MID;
			$UREF->{'MERCHANT'} = $MERCHANT;
			$UREF->{'LUSER'} = $LUSER;

			$pstmt = &DBINFO::insert($dbh,'ZUSER_LOGIN',$UREF,debug=>2);
			}
		else {
			$pstmt = "update ZUSER_LOGIN set FULLNAME=$qtFULLNAME,JOBTITLE=$qtTITLE,EMAIL=$qtEMAIL,PHONE=$qtPHONE,";
			$pstmt .= "IS_CUSTOMERSERVICE='$UREF->{'IS_CUSTOMERSERVICE'}',IS_ADMIN='$UREF->{'IS_ADMIN'}',";
			$pstmt .= "EXPIRES_GMT=$UREF->{'EXPIRES_GMT'},";
			if ($PASSWORD ne '') { $pstmt .= "PASSWORD=".$dbh->quote($UREF->{'PASSWORD'}).","; }
			$pstmt .= "FLAG_SETUP=$UREF->{'FLAG_SETUP'},";
			$pstmt .= "FLAG_PRODUCTS=$UREF->{'FLAG_PRODUCTS'},";
			$pstmt .= "FLAG_ORDERS=$UREF->{'FLAG_ORDERS'},";
			$pstmt .= "FLAG_MANAGE=$UREF->{'FLAG_MANAGE'},";
			$pstmt .= "FLAG_ZOM=$UREF->{'FLAG_ZOM'},";
			
			$pstmt .= "ALLOW_FORUMS='$UREF->{'ALLOW_FORUMS'}',";
			$pstmt .= "HAS_EMAIL='$UREF->{'HAS_EMAIL'}'";
			$pstmt .= " where MID=$MID and UID=".$dbh->quote(int($ZOOVY::cgiv->{'UID'}));
			}
		print STDERR $pstmt."\n";
		$dbh->do($pstmt);

		## note: we need to provision the fusemail account *AFTER* we add the ZUSER_LOGIN
		if ($UREF->{'HAS_EMAIL'} eq 'Y') {
			my $pass = &FUSEMAIL::getpassword("$UREF->{'LUSER'}\@$MERCHANT.zoovy.com");
			if ($pass eq '') { 
				&FUSEMAIL::account_order($MERCHANT,$LUSER);
				}
			}


		$ACTION = '';
		}
	else {
		$ACTION = 'ADD';
		$GTOOLS::TAG{'<!-- ERRORS -->'} = "<font color='red'>The following errors were encountered:<br>".join('<li>',@ERRORS)."</font><br>";
		}
	}


if ($ACTION eq 'ADD' || $ACTION eq 'EDIT') {

	$GTOOLS::TAG{'<!-- LUSER_EDIT -->'} = qq~<input type="textbox" name="username" maxlength="10" size="10" value="">~;
	if ($ACTION eq 'EDIT') {		
		my $pstmt = "select * from ZUSER_LOGIN where MID=$MID and UID=".int($ZOOVY::cgiv->{'UID'});
		my $sth = $dbh->prepare($pstmt);
		$sth->execute();
		($UREF) = $sth->fetchrow_hashref();
		$sth->finish();
		$GTOOLS::TAG{'<!-- LUSER_EDIT -->'} = qq~<input type="hidden" name="username" value="$UREF->{'LUSER'}">$UREF->{'LUSER'}~;
		}

	if ($FLAGS =~ /,ZM,/) {
		if ($ACTION eq 'ADD') {
			$GTOOLS::TAG{'<!-- ZOOVYMAIL -->'} = qq~<tr><td colspan=2><input type="checkbox" checked name="ZOOVYMAIL"> Create individual ZoovyMail Inbox for this User (Recommended)<br></td></tr>~;
			}
		if ($ACTION eq 'EDIT') {
			my $pass = &FUSEMAIL::getpassword("$UREF->{'LUSER'}\@$MERCHANT.zoovy.com");
			print STDERR "trying to edit ZoovyMail for: ".$UREF->{'LUSER'}." with password: ".$pass."\n";
			if ($pass ne '') {
				$GTOOLS::TAG{'<!-- ZOOVYMAIL -->'} = qq~<tr><td colspan=2><input type="hidden" name="ZOOVYMAIL" value="on"> ZoovyMail Login: $UREF->{'LUSER'}\@$MERCHANT.zoovy.com Pass: $pass<br></td></tr>~;
				}
			else {
				$GTOOLS::TAG{'<!-- ZOOVYMAIL -->'} = qq~<tr><td colspan=2><input type="checkbox" name="ZOOVYMAIL"> Create individual ZoovyMail Inbox for this User<br></td></tr>~;
				}
			}
		}

	$GTOOLS::TAG{'<!-- UID -->'} = $UREF->{'UID'};
	$GTOOLS::TAG{'<!-- LUSER -->'} = $UREF->{'LUSER'};
	$GTOOLS::TAG{'<!-- PASSWORD -->'} = $UREF->{'PASSWORD'};
	$GTOOLS::TAG{'<!-- PHONE -->'} = $UREF->{'PHONE'};
	$GTOOLS::TAG{'<!-- TITLE -->'} = $UREF->{'JOBTITLE'};
	$GTOOLS::TAG{'<!-- FULLNAME -->'} = $UREF->{'FULLNAME'};
	$GTOOLS::TAG{'<!-- EMAIL -->'} = $UREF->{'EMAIL'};
	$GTOOLS::TAG{'<!-- EXPIRES -->'} = '';
	if ($UREF->{'EXPIRES_GMT'}>0) {
		my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime($UREF->{'EXPIRES_GMT'});
		$year = $year % 100; $mon += 1;
		$GTOOLS::TAG{'<!-- EXPIRES -->'} = sprintf("%02d/%02d/%02d",$mon,$mday,$year);
		}
	$GTOOLS::TAG{'<!-- CHK_IS_ADMIN -->'} = ($UREF->{'IS_ADMIN'} eq 'Y')?'checked':'';
	$GTOOLS::TAG{'<!-- CHK_ALLOW_FORUMS -->'} = ($UREF->{'ALLOW_FORUMS'} eq 'Y')?'checked':'';
	$GTOOLS::TAG{'<!-- CHK_IS_CUSTOMERSERVICE -->'} = ($UREF->{'IS_CUSTOMERSERVICE'} eq 'Y')?'checked':'';
	$GTOOLS::TAG{'<!-- CHK_IS_BILLING -->'} = ($UREF->{'IS_BILLING'} eq 'Y')?'checked':'';

	my $i = 1; 
	while ($i<16384) { 
		$GTOOLS::TAG{'<!-- CHK_SETUP_'.$i.' -->'} = (($UREF->{'FLAG_SETUP'} & $i)==$i)?'checked':'';
		$GTOOLS::TAG{'<!-- CHK_PRODUCT_'.$i.' -->'} = (($UREF->{'FLAG_PRODUCTS'} & $i)==$i)?'checked':'';
		$GTOOLS::TAG{'<!-- CHK_ORDER_'.$i.' -->'} = (($UREF->{'FLAG_ORDERS'} & $i)==$i)?'checked':'';
		$GTOOLS::TAG{'<!-- CHK_MANAGE_'.$i.' -->'} = (($UREF->{'FLAG_MANAGE'} & $i)==$i)?'checked':'';
		$GTOOLS::TAG{'<!-- CHK_ZOM_'.$i.' -->'} = (($UREF->{'FLAG_ZOM'} & $i)==$i)?'checked':'';
		$i *= 2;
		}

	if ($ACTION eq 'EDIT') {
		$GTOOLS::TAG{'<!-- REMOVE_BUTTON -->'} = qq~<td><input type="button" class="button" value=" Remove " onClick="document.location='index.cgi?ACTION=NUKE&LUSER=$UREF->{'LUSER'}&UID=$UREF->{'UID'}';"></td>~;		
		}
	
	$template_file = 'useredit.shtml';
	}


if ($ACTION eq '') {
	my $pstmt = "select * from ZUSER_LOGIN where MID=$MID";
	print STDERR $pstmt."\n";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my $c = '';
	while ( my $hashref = $sth->fetchrow_hashref() ) {
		$c .= "<tr>";	
		$c .= qq~<td><input type="button" class="button" value=" Edit " onClick="document.location='index.cgi?ACTION=EDIT&UID=$hashref->{'UID'}';"></td>~;
		$c .= "<td>$hashref->{'MERCHANT'}*$hashref->{'LUSER'}</td>";
		$c .= "<td>$hashref->{'FULLNAME'} / $hashref->{'JOBTITLE'}</td>";
		$c .= "<td>$hashref->{'HAS_EMAIL'}</td>";
		$c .= "</tr>";
		}
	if ($c eq '') { $c = "<tr><td><i>No users currently exist</i></td></tr>"; }
	else { 
		$c = qq~
	<tr class="zoovytableheader">
		<td><b>Edit</b></td>
		<td><b>Login</b></td>
		<td><b>Name/Title</b></td>
		<td><b>Email</b></td>
	</tr>~.$c; }
	$GTOOLS::TAG{'<!-- CURRENT_USERS -->'} = $c;
	}

if ($FLAGS !~ /,BASIC,/) {
	$template_file = 'deny.shtml';
	}

&GTOOLS::output(
	title=>'Setup: User Manager',
	file=>$template_file,
	header=>1,
	help=>'#50292',
	bc=>[
		{ name=>'Setup', link=>'/biz/setup', target=>'_top' },
		{ name=>'User Manager' },	
		],
	);
&DBINFO::db_zoovy_close();
