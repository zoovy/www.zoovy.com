#!/usr/bin/perl


use strict;

use Data::Dumper;
use lib "/httpd/modules";
use GTOOLS;
use LUSER;
use LUSER::FILES;
use TODO;

my ($LU) = LUSER->authenticate();
if (not defined $LU) { warn "Auth"; exit; }

#use Data::Dumper;
#print STDERR Dumper($LU);

my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
if ($MID<=0) { warn "No auth"; exit; }

my $c = '';
my ($lf) = LUSER::FILES->new($USERNAME);

my $VERB = $ZOOVY::cgiv->{'VERB'};
my @FILES = ();
foreach my $k (keys %{$ZOOVY::cgiv}) {
	next unless ($k =~ /^FILE:(.*?)$/);
	push @FILES, $1;
	}	

if ($VERB eq 'EXPIRE') {
	foreach my $fileid (@FILES) {
		$lf->expire($fileid);
		}
	}

if ($VERB eq 'PRESERVE') {
	foreach my $fileid (@FILES) {
		$lf->preserve($fileid);
		}
	}

my ($results) = $lf->list();

#mysql> desc PRIVATE_FILES;
#+-----------+-----------------------------------------+------+-----+---------+----------------+
#| Field     | Type                                    | Null | Key | Default | Extra          |
#+-----------+-----------------------------------------+------+-----+---------+----------------+
#| ID        | int(10) unsigned                        | NO   | PRI | NULL    | auto_increment |
#| USERNAME  | varchar(20)                             | NO   |     | NULL    |                |
#| MID       | int(10) unsigned                        | NO   | MUL | 0       |                |
#| CREATEDBY | varchar(10)                             | NO   |     | NULL    |                |
#| CREATED   | datetime                                | YES  |     | NULL    |                |
#| EXPIRES   | datetime                                | YES  |     | NULL    |                |
#| TITLE     | varchar(50)                             | NO   |     | NULL    |                |
#| FILENAME  | varchar(50)                             | NO   |     | NULL    |                |
#| FILETYPE  | enum('TICKET','REPORT','DEBUG','OTHER') | YES  |     | OTHER   |                |
#| META      | tinytext                                | NO   |     | NULL    |                |
#+-----------+-----------------------------------------+------+-----+---------+----------------+
#10 rows in set (0.01 sec)

my @results = @{$results};
if ($ZOOVY::cgiv->{'SORTBY'}) {
	## 
	
	}


foreach my $fref (@results) {
	$c .= "<tr>";

	$c .= qq~<td valign=top><input type='checkbox' name="FILE:$fref->{'ID'}"></td>~;
	$c .= "<td valign=top>";	
	if ($fref->{'FILETYPE'} eq 'REPORT') {
		$c .= "<a href=\"/biz/reports/view.cgi?GUID=$fref->{'GUID'}\">View</a>";
		}
	elsif ($fref->{'FILETYPE'} eq 'SYNDICATION') {
		$c .= "<a href=\"/biz/syndication/view.cgi?GUID=$fref->{'GUID'}\">View</a>";
		}
	else {
		$c .= "$fref->{'FILETYPE'}";
		}
	$c .= "</td>";


	$c .= "<td nowrap valign=top>".&ZTOOLKIT::pretty_date($fref->{'CREATED_GMT'},4)."</td>";
	# FILENAME
	$c .= "<td valign=top>";
		$c .= $fref->{'TITLE'};
		$c .= "<div><font class='hint'>".$fref->{'%META'}->{'subtitle'}."</font></div>";
	$c .= "</td>";
	$c .= "<td valign=top>".$fref->{'FILETYPE'}."</td>";
	$c .= "<td valign=top>".$fref->{'SIZE'}."</td>";
	$c .= "<td valign=top>".$fref->{'EXPIRES'}."</td>";
	$c .= "<td valign=top>".$fref->{'CREATEDBY'}."</td>";
	$c .= "</tr>";
	}

if ($c eq '') {
	$c .= "<tr><td colspan=5><i>No private files found</i></td></tr>";
	}
$GTOOLS::TAG{'<!-- FILES -->'} = $c;

&GTOOLS::output(file=>'index.shtml',header=>1);