#!/usr/bin/perl

use lib "/httpd/modules";
require GTOOLS;
use CGI;
require ZWEBSITE;
require ZSHIP;
require ZSHIP::GLOBAL;
use Data::Dumper;
require LUSER;
my ($LU) = LUSER->authenticate(flags=>'_S&8');
if (not defined $LU) { exit; }

my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
if ($MID<=0) { exit; }


my @BC = ();
push @BC, { name=>'Setup',link=>'http://www.zoovy.com/biz/setup','target'=>'_top', };
push @BC, { name=>'Shipping',link=>'http://www.zoovy.com/biz/setup/shipping','target'=>'_top', };
push @BC, { name=>'Fixed Shipping' };

$q = new CGI;
$ACTION = $q->param('ACTION');
%webdb = &ZWEBSITE::fetch_website_db($USERNAME,$PRT);

if ($ACTION eq 'SAVE') {

 	$shipname = $q->param('SINGLE_NAME'); $shipname =~ s/ /_/g;	$shipname =~ s/\W+//g; $shipname =~ s/_/ /g; 
	$shipname = substr($shipname,0,20); if ($shipname eq '') { $shipname = 'Single Fixed Shipping'; }
	$shipname = $q->param('SINGLE_NAME');
 	$FIXEDSTR = $q->param('SINGLE_BEHAVIOR').'|'.$q->param('SINGLE_CALC').'|'.$shipname;
	$webdb{'fixed_ship_single'} = $FIXEDSTR;

 	$shipname = $q->param('MULTI_NAME'); $shipname =~ s/ /_/g;	$shipname =~ s/\W+//g; $shipname =~ s/_/ /g; 
	$shipname = substr($shipname,0,20); if ($shipname eq '') { $shipname = 'Multi Fixed Shipping'; }
	$FIXEDSTR = $q->param('MULTI_BEHAVIOR').'|'.$q->param('MULTI_CALC').'|'.$shipname;
	$webdb{'fixed_ship_multi'} = $FIXEDSTR;

 	$shipname = $q->param('COMBO_NAME'); $shipname =~ s/ /_/g;	$shipname =~ s/\W+//g; $shipname =~ s/_/ /g; 
	$shipname = substr($shipname,0,20); if ($shipname eq '') { $shipname = 'Combo Fixed Shipping'; }
	$FIXEDSTR = $q->param('COMBO_BEHAVIOR').'|'.$q->param('COMBO_CALC').'|'.$shipname;
	$webdb{'fixed_ship_combo'} = $FIXEDSTR;

 	$shipname = $q->param('STORE_NAME'); $shipname =~ s/ /_/g;	$shipname =~ s/\W+//g; $shipname =~ s/_/ /g; 
	$shipname = substr($shipname,0,20); if ($shipname eq '') { $shipname = 'Store Fixed Shipping'; }
	$FIXEDSTR = $q->param('STORE_BEHAVIOR').'|'.$q->param('STORE_CALC').'|'.$shipname;	
	$webdb{'fixed_ship_store'} = $FIXEDSTR;

	$webdb{'ship_fixed'} = 0;
	if ($q->param('SINGLE_BEHAVIOR')) { $webdb{'ship_fixed'} += 1; }
	if ($q->param('MULTI_BEHAVIOR')) { $webdb{'ship_fixed'} += 2; }
	if ($q->param('COMBO_BEHAVIOR')) { $webdb{'ship_fixed'} += 4; }
	if ($q->param('STORE_BEHAVIOR')) { $webdb{'ship_fixed'} += 8; }

	$LU->log("SETUP.SHIPPING.LEGACYFIXED","Saved legacy fixed price Settings","SAVE");
	&ZWEBSITE::save_website_dbref($USERNAME,\%webdb,$PRT);

	$GTOOLS::TAG{'<!-- MESSAGE -->'} = '<font color="red">Saved Fixed Shipping Settings</font>';
	$ACTION = '';
	}

if ($ACTION eq '') {
	if ($webdb{'ship_fixed'} == 1) {
		$GTOOLS::TAG{'<!-- SHIP_FIXED_CHECKED -->'} = ' CHECKED '; 
		} else {
		$GTOOLS::TAG{'<!-- SHIP_FIXED_CHECKED -->'} = ''; 
		}

	@types = ('single','multi','combo','store');
	foreach $type (@types) {
		if (!defined($webdb{'fixed_ship_'.$type})) { $webdb{'fixed_ship_'.$type} = '0|0|'.ucfirst($type).' Fixed Shipping'; }
		my ($behavior,$calc,$name) = split(/\|/,$webdb{'fixed_ship_'.$type});
		print STDERR "behavior=$behavior calc=$calc name=$name\n";
		if ($behavior eq '') { $behavior = 0; }
		if ($calc eq '') { $calc = 0; }
		$GTOOLS::TAG{'<!-- '.uc($type).'_CALC_0 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_CALC_1 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_CALC_2 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_CALC_3 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_CALC_'.$calc.' -->'} = ' CHECKED ';
		
		$GTOOLS::TAG{'<!-- '.uc($type).'_BEHAVIOR_0 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_BEHAVIOR_1 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_BEHAVIOR_2 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_BEHAVIOR_3 -->'} = '';
		$GTOOLS::TAG{'<!-- '.uc($type).'_BEHAVIOR_'.$behavior.' -->'} = ' CHECKED ';		
		
		if ( (!defined($name)) || ($name eq '')) { $name = ucfirst($type).' Fixed Shipping'; }
		$GTOOLS::TAG{'<!-- '.uc($type).'_NAME -->'} = $name;
		}

	
	print STDERR Dumper(\%GTOOLS::TAG);
	

	$template_file = 'legacyfixed.shtml';
	}

print "Content-type: text/html\n";
print "Pragma: no-cache\n"; # HTTP 1.0 non-caching specification
print "Cache-Control: no-cache\n"; # HTTP 1.1 non-caching specification
print "Expires: 0\n"; # HTTP 1.0 way of saying "expire now"

print "\n";
$GTOOLS::TAG{'<!-- HELPLINK -->'} = &GTOOLS::help_link('New Users Read This','#50817');
&GTOOLS::output(title=>'Fixed Shipping (LEGACY)',help=>'#50817',file=>$template_file,header=>0,bc=>\@BC);
