#!/usr/bin/perl

use strict;
use Text::Wrap;
$Text::Wrap::columns = 80;

use lib "/httpd/modules";
require DBINFO;
require LUSER;
require GTOOLS;
require CUSTOMER::TICKET;
require CUSTOMER;
require ORDER;
require ZTOOLKIT;

my $dbh = &DBINFO::db_zoovy_connect();
my $odbh = &DBINFO::db_orders_connect();

#my ($LU) = LUSER->authenticate();
#if (not defined $LU) { exit; }
#my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
#if ($MID<=0) { exit; }
my ($USERNAME,$FLAGS,$MID,$LUSERNAME,$RESELLER) = ZOOVY::authenticate("/biz/manage",2,'_M&8');
my ($LU) = LUSER->new($USERNAME,$LUSERNAME);

my $tabs = 1;		## should we display or hide tabs..

my @BC = ( { name=>"Tickets", link=>"/biz/crm" } );
my @TABS = ();

my $template_file = '';
my $VERB = uc($ZOOVY::cgiv->{'VERB'});
my $TKTCODE = $ZOOVY::cgiv->{'TKTCODE'};
my $CID = 0;

if ($FLAGS !~ /,CRM,/) {
	$VERB = 'DENIED';
	$template_file = 'denied.shtml';
	}


my @ERRORS = ();

#mysql> desc CHECKOUTS;
#+----------------+-------------------------------+------+-----+---------+----------------+
#| Field          | Type                          | Null | Key | Default | Extra          |
#+----------------+-------------------------------+------+-----+---------+----------------+
#| ID             | int(11)                       | NO   | PRI | NULL    | auto_increment |
#| MID            | int(10) unsigned              | NO   | MUL | 0       |                |
#| USERNAME       | varchar(20)                   | NO   |     | NULL    |                |
#| SDOMAIN        | varchar(50)                   | NO   |     | NULL    |                |
#| ASSIST         | enum('NONE','CALL','CHAT','') | NO   |     | NULL    |                |
#| CARTID         | varchar(36)                   | NO   |     | NULL    |                |
#| CID            | int(10) unsigned              | NO   |     | 0       |                |
#| CREATED_GMT    | int(10) unsigned              | NO   |     | 0       |                |
#| HANDLED_GMT    | int(10) unsigned              | NO   |     | 0       |                |
#| CLOSED_GMT     | int(10) unsigned              | NO   |     | 0       |                |
#| ASSISTID       | varchar(5)                    | NO   |     | NULL    |                |
#| CHECKOUT_STAGE | varchar(8)                    | NO   |     | NULL    |                |
#+----------------+-------------------------------+------+-----+---------+----------------+
#12 rows in set (0.02 sec)
if ($VERB eq 'CHECKOUTASSIST') {
	$template_file = 'checkoutassist.shtml';

	my $c = '';
	my $pstmt = "select * from CHECKOUTS where MID=$MID /* $USERNAME */";
	my $sth = $odbh->prepare($pstmt);
	$sth->execute();
	while ( my $ref = $sth->fetchrow_hashref() ) {
		$c .= "<tr><td>$ref->{'ASSIST'}</td><td>$ref->{'ASSISTID'}</td><td>$ref->{'CREATED_GMT'}</td></tr>";
		}
	$sth->finish();	
	$GTOOLS::TAG{'<!-- CHECKOUTS -->'} = $c;
	}




if ($VERB eq 'UNIVERSAL-LOOKUP') {
	## this gets only one value: lookup so we use pattern matching to try and figure out what the heck
	##		we're looking for

	my $lookup = $ZOOVY::cgiv->{'lookup'};
	$lookup = uc($lookup);
	$lookup =~ s/^[\s]+//gs;	# strip leading whitespace
	$lookup =~ s/[\s]+$//gs;	# strip trailing whitespace

	if ($lookup =~ /^[\d]{4,4}\-[\d]{2,2}\-[\d]+$/) {
		## this is an order #
		$VERB = 'EXEC-SEARCH'; $ZOOVY::cgiv->{'orderid'} = $lookup;
		}
	elsif ($lookup =~ /\@/) {
		## this is an email 
		$VERB = 'EXEC-SEARCH'; $ZOOVY::cgiv->{'email'} = $lookup;
		}
	elsif ($lookup =~ /^[\d]{3,3}-[\d]{3,3}-[\d]{1,7}$/) {
		## this is an email 
		$VERB = 'EXEC-SEARCH'; $ZOOVY::cgiv->{'phone'} = $lookup;
		}
	else {
		$VERB = 'EXEC-SEARCH'; $ZOOVY::cgiv->{'ticket'} = $lookup;
		}

	}

if ($VERB eq 'EXEC-SEARCH') {
	$VERB = '';

	# if (($VERB eq '') && (length($lookup)==6) && ($lookup =~ /^[A-Z0-9]+$/)) {
	if (($VERB eq '') && ($ZOOVY::cgiv->{'ticket'} ne '')) {
		my $lookup = $ZOOVY::cgiv->{'ticket'};
		## it's a 6 digit ticket code
		print STDERR "LOOKUP: $lookup\n";
		my ($T) = CUSTOMER::TICKET->new($USERNAME,"+$lookup");
		if (defined $T) { 
			$VERB = 'TICKET-VIEW';  $TKTCODE = $lookup; 
			}
		}
		
	 if (($VERB eq '') && ($ZOOVY::cgiv->{'orderid'} ne '')) {
		my $lookup = $ZOOVY::cgiv->{'orderid'};
		if ($lookup eq '') { $lookup = '*'; }
		my ($o) = ORDER->new($USERNAME,$lookup);
      if ((defined $o) && (ref($o) eq 'ORDER')) {
			($CID) = &CUSTOMER::searchfor_cid($USERNAME,0,'EMAIL',$o->get_attrib('bill_email'));
			if ($CID>0) {
				$VERB = 'TICKETS-SHOWCID-ALL';
				}
         }
		}

	# if (($VERB eq '') && ($lookup =~ /^[\d]{3,3}\-[\d]{3,3}-[\d]{4,4}$/)) {
	if (($VERB eq '') && ($ZOOVY::cgiv->{'phone'} ne '')) {
		my $lookup = $ZOOVY::cgiv->{'phone'};
		## PHONE NUMBER: ###-###-####
		($CID) = &CUSTOMER::searchfor_cid($USERNAME,0,'PHONE',$lookup);
		if ($CID>0) {
			$VERB = 'TICKETS-SHOWCID-ALL';
			}
		}

	# if (($VERB eq '') && (&ZTOOLKIT::validate_email($lookup))) {
	if (($VERB eq '') && ($ZOOVY::cgiv->{'email'} ne '')) {
		my $lookup = $ZOOVY::cgiv->{'email'};
		## EMAIL user@domain.com
		($CID) = &CUSTOMER::searchfor_cid($USERNAME,0,'EMAIL',$lookup);
		if ($CID>0) {
			$VERB = 'TICKETS-SHOWCID-ALL';
			}
		}


	if ($VERB eq '') {
		$GTOOLS::TAG{'<!-- ERRORS -->'} = "Could not find ticket, or no results found"; 
		$VERB = 'SEARCH';
		}

	}


##
##
##
if ($VERB eq 'SEARCH') {

	$GTOOLS::TAG{'<!-- TICKET -->'} = ($ZOOVY::cgiv->{'TICKET'})?&ZOOVY::incode($ZOOVY::cgiv->{'TICKET'}):'';
	$GTOOLS::TAG{'<!-- ORDERID -->'} = ($ZOOVY::cgiv->{'ORDERID'})?&ZOOVY::incode($ZOOVY::cgiv->{'ORDERID'}):'';
	$GTOOLS::TAG{'<!-- EMAIL -->'} = ($ZOOVY::cgiv->{'EMAIL'})?&ZOOVY::incode($ZOOVY::cgiv->{'ORDERID'}):'';
	$GTOOLS::TAG{'<!-- PHONE -->'} = ($ZOOVY::cgiv->{'PHONE'})?&ZOOVY::incode($ZOOVY::cgiv->{'ORDERID'}):'';
	# $GTOOLS::TAG{'<!-- CUSTOMER -->'} = ($ZOOVY::cgiv->{'CUSTOMER'})?&ZOOVY::incode($ZOOVY::cgiv->{'ORDERID'}):'';

	$template_file = 'search.shtml';
	}





if ($VERB eq 'CREATE-SAVE') {
	my $CID = 0;
	my $orderid = $ZOOVY::cgiv->{'orderid'};
	my $email = $ZOOVY::cgiv->{'email'};
	my $phone = $ZOOVY::cgiv->{'phone'};

	if (($CID<=0) && ($orderid ne '')) {
		my ($o) = ORDER->new($USERNAME,$orderid);
		if (not defined $o) {
			$orderid = '';
			}
		else {
			$email = $o->get_attrib('bill_email');
			$phone = $o->get_attrib('bill_phone');
			}
		}

	if (($CID<=0) && (&ZTOOLKIT::validate_email($email))) {
		## Lookup by email
		($CID) = &CUSTOMER::resolve_customer_id($USERNAME,0,$email);
		}

	if (($CID<=0) && ($phone ne '')) {
		## Lookup by phone
		($CID) = &CUSTOMER::searchfor_cid($USERNAME,0,'PHONE',$phone);
		}

	if (($CID<=0) && ($ZOOVY::cgiv->{'create'})) {
		if (&ZTOOLKIT::validate_email($email)) {
			my ($c) = CUSTOMER->new($USERNAME,PRT=>0,CREATE=>1,EMAIL=>$email);
			$c->save();
			$CID = $c->cid();
			}
		}

	if (($CID>0) || ($orderid ne '')) {
		## created a ticket.
		my ($t) = CUSTOMER::TICKET->new($USERNAME,0,ORDERID=>$orderid,CID=>$CID,
					SUBJECT=>$ZOOVY::cgiv->{'subject'},
					NOTE=>$ZOOVY::cgiv->{'body'},
					CLASS=>$ZOOVY::cgiv->{'class'},
					);
		if (defined $t) {
			$VERB = 'TICKET-VIEW';
			$TKTCODE = $t->tktcode();
			}
		else {
			$GTOOLS::TAG{'<!-- ERRORS -->'} = "INTERNAL ERROR OCCURRED ATTEMPTING TO CREATE TICKET";
			$VERB = 'CREATE';
			}
		}
	else {
		## FAILED
		$GTOOLS::TAG{'<!-- ERRORS -->'} = "Could not lookup EMAIL, PHONE, or ORDERID";
		$VERB = 'CREATE';
		}
	}


if ($VERB eq 'CREATE') {
	$GTOOLS::TAG{'<!-- ORDERID -->'} = &ZOOVY::incode($ZOOVY::cgiv->{'orderid'});
	$GTOOLS::TAG{'<!-- EMAIL -->'} = &ZOOVY::incode($ZOOVY::cgiv->{'email'});
	$GTOOLS::TAG{'<!-- PHONE -->'} = &ZOOVY::incode($ZOOVY::cgiv->{'phone'});
	$GTOOLS::TAG{'<!-- SUBJECT -->'} = &ZOOVY::incode($ZOOVY::cgiv->{'subject'});
	$GTOOLS::TAG{'<!-- BODY -->'} = &ZOOVY::incode($ZOOVY::cgiv->{'body'});
	$GTOOLS::TAG{'<!-- CHK_CLASS_PRESALE -->'} = ($ZOOVY::cgiv->{'class'} eq 'PRESALE')?'selected':'';
	$GTOOLS::TAG{'<!-- CHK_CLASS_POSTSALE -->'} = ($ZOOVY::cgiv->{'class'} eq 'POSTSALE')?'selected':'';
	$GTOOLS::TAG{'<!-- CHK_CLASS_RETURN -->'} = ($ZOOVY::cgiv->{'class'} eq 'RETURN')?'selected':'';
	$GTOOLS::TAG{'<!-- CHK_CLASS_EXCHANGE -->'} = ($ZOOVY::cgiv->{'class'} eq 'EXCHANGE')?'selected':'';
	$template_file = 'create.shtml';
	}





if (($VERB eq 'TICKET-ASK') || ($VERB eq 'TICKET-UPDATE') || ($VERB eq 'TICKET-CLOSE')) {
	my ($T) = CUSTOMER::TICKET->new($USERNAME,"+$TKTCODE");
	if ($ZOOVY::cgiv->{'note'} ne '') {
		$T->addMsg($LUSERNAME,$ZOOVY::cgiv->{'note'},($ZOOVY::cgiv->{'flag_private'})?1:0);
		}

	my %vars = ();
	$vars{'escalate'} = ($ZOOVY::cgiv->{'flag_escalate'})?1:0;
	$vars{'class'} = $ZOOVY::cgiv->{'class'};

	if (($vars{'class'} eq 'PRESALE') || ($vars{'class'} eq 'POSTSALE')) {
		$T->cdSet("tags",$ZOOVY::cgiv->{'CD*tags'});
		}
	elsif (($vars{'class'} eq 'EXCHANGE') || ($vars{'class'} eq 'RETURN')) {
		$T->cdSet("rtnauth",(defined $ZOOVY::cgiv->{'CD*rtnauth'})?1:0);
		$T->cdSet("rtncredit",$ZOOVY::cgiv->{'CD*rtncredit'});
		$T->cdSet("rtnvia",$ZOOVY::cgiv->{'CD*rtnvia'});
		}

	if ($VERB eq 'TICKET-ASK') {
		## ASK CUSTOMER A QUESTION
		$VERB = 'TICKET-VIEW';
		$T->changeState('WAIT',%vars);
		$LU->log('TICKET.ASK',"Set Ticket: ".$T->tktcode()." to waiting","SAVE");
		}

	##
	##
	##
	if ($VERB eq 'TICKET-UPDATE') {
		## UPDATE A TICKET
		$T->changeState('ACTIVE',%vars);
		$LU->log('TICKET.UPDATE',"Updated Ticket: ".$T->tktcode(),"SAVE");
		$VERB = 'TICKET-VIEW';
		}

	if ($VERB eq 'TICKET-CLOSE') {
		## CLOSE A TICKET
		$T->changeState('CLOSE',%vars);
		$LU->log('TICKET.CLOSE',"Closed Ticket: ".$T->tktcode(),"SAVE");
		$VERB = '';
		}

	}


if ($VERB eq 'TICKET-UNLOCK') {
	## A STUB FUNCTION USED WHEN RETURNING TO MAIN MENU
	$VERB = '';
	}




##
##
##
if ($VERB eq 'TICKET-VIEW') {	

	$GTOOLS::TAG{'<!-- TKTCODE -->'} = $TKTCODE;
	my ($T) = CUSTOMER::TICKET->new($USERNAME,"+$TKTCODE");

	if (not defined $T) {
		warn "Could not load TKTCODE $TKTCODE";
		$VERB = '';
		}
	else {
		
		my ($ts,$user) = $T->getLock();
		my $tsdiff = time()-$ts;
		if ( $tsdiff < 15*60 ) {
			push @ERRORS, "WARN: Warning user \"$user\" accessed the ticket ".&ZTOOLKIT::pretty_time_since(1,$tsdiff)." ago, they may still be editing.";
			}
		else {
			$T->setLock($LUSERNAME);
			}


		$GTOOLS::TAG{'<!-- STATUS -->'} = $T->{'STATUS'};
		$GTOOLS::TAG{'<!-- ORDER -->'} = '';
		$GTOOLS::TAG{'<!-- SINCE -->'} = '';

		my $inforef = $T->buildInfo();

		if ($inforef->{'orderid'} ne '') {
			my $orderid = $inforef->{'orderid'};
			$GTOOLS::TAG{'<!-- ORDERID -->'} = "<a href=\"/biz/orders/view.cgi?order=$orderid\">$orderid</a>";
			}		
		else {
			$GTOOLS::TAG{'<!-- ORDERID -->'} = "<i>Not Set</i>";
			}

		$GTOOLS::TAG{'<!-- EMAIL -->'} = $inforef->{'email'};
		$GTOOLS::TAG{'<!-- PHONE -->'} = $inforef->{'phone'};

		$GTOOLS::TAG{'<!-- TKT_OPEN -->'} = ($inforef->{'TKT_open'}>0)?"<a href=\"index.cgi?VERB=TICKETS-SHOWCID-OPEN&CID=$inforef->{'cid'}\">$inforef->{'TKT_open'}</a>":'0';
		$GTOOLS::TAG{'<!-- TKT_TOTAL -->'} = ($inforef->{'TKT_total'}>0)?"<a href=\"index.cgi?VERB=TICKETS-SHOWCID-ALL&CID=$inforef->{'cid'}\">$inforef->{'TKT_total'}</a>":'0';
		$GTOOLS::TAG{'<!-- TKT_WAIT -->'} = ($inforef->{'TKT_wait'}>0)?"<a href=\"index.cgi?VERB=TICKETS-SHOWCID-WAIT&CID=$inforef->{'cid'}\">$inforef->{'TKT_wait'}</a>":'0';

		$GTOOLS::TAG{'<!-- FULLNAME -->'} = ($inforef->{'fullname'} ne '')?$inforef->{'fullname'}:'<i>Not Set</i>';
		if ($inforef->{'cid'}>0) {
			$GTOOLS::TAG{'<!-- FULLNAME -->'} .= " <a target=\"customer_edit\" href=\"/biz/utilities/customer/index.cgi?ACTION=SEARCH&scope=CID&searchfor=$inforef->{'cid'}\">[EDIT]</a>";
			}
		$GTOOLS::TAG{'<!-- ORDER_COUNT -->'} = $inforef->{'order_count'};
		$GTOOLS::TAG{'<!-- CUSTOMER_SINCE -->'} = $inforef->{'customer_since'};

		$GTOOLS::TAG{'<!-- SUBJECT -->'} = &ZOOVY::incode($T->{'SUBJECT'});

  		my $note = Text::Wrap::wrap("","",$T->{'NOTE'});
     	$note = &ZOOVY::incode($note);
		$GTOOLS::TAG{'<!-- BODY -->'} = "<pre>".$note."</pre>";


		$GTOOLS::TAG{'<!-- CHK_CLASS_PRESALE -->'} = ($T->{'CLASS'} eq 'PRESALE')?'selected':'';
		$GTOOLS::TAG{'<!-- CHK_CLASS_POSTSALE -->'} = ($T->{'CLASS'} eq 'POSTSALE')?'selected':'';
		$GTOOLS::TAG{'<!-- CHK_CLASS_RETURN -->'} = ($T->{'CLASS'} eq 'RETURN')?'selected':'';
		$GTOOLS::TAG{'<!-- CHK_CLASS_EXCHANGE -->'} = ($T->{'CLASS'} eq 'EXCHANGE')?'selected':'';


		my $c = '';
		if (($T->{'CLASS'} eq 'PRESALE') || ($T->{'CLASS'} eq 'POSTSALE')) {
			my $tags = &ZOOVY::incode($T->cdGet('tags'));
			$c .= qq~
<table>
<tr>
	<td>Tags:</td>
	<td><input size="100" type="textbox" value="$tags" name="CD*tags"></td>
</tr>
</table>
<div class="hint"><i>Tags are user defined words for grouping related tickets. 
We anticipate making this data accessible via reports in future releases.</i></div>
~;
			}
		elsif (($T->{'CLASS'} eq 'RETURN') || ($T->{'CLASS'} eq 'EXCHANGE')) {
			my $rtnauth = ($T->cdGet("rtnauth")?'checked':'');
			my $rtncredit = &ZOOVY::incode($T->cdGet("rtncredit"));
			my $rtnvia = &ZOOVY::incode($T->cdGet("rtnvia"));

			$c .= qq~
<table>
<tr>
	<td><input type="checkbox" $rtnauth name="CD*rtnauth"> Return Authorized.</td>
</tr>
<tr>
	<td>Authorized Credit Amount: <input type="textbox" name="CD*rtncredit" value="$rtncredit"></td>
</tr>
<tr>
	<td>Credit Issued via: <input type="textbox" name="CD*rtnvia" value="$rtnvia"></td>
</tr>
</table>
~;
			
			}
		$GTOOLS::TAG{'<!-- CLASS_INFO -->'} = $c;

		$c = '';
		my $msgsref = $T->getMsgs();
		if ((defined $msgsref) && (ref($msgsref) eq 'ARRAY')) {
			foreach my $msg (reverse @{$msgsref}) {

      		my $note = Text::Wrap::wrap("","",$msg->{'NOTE'});
         	$note = &ZOOVY::incode($note);

				my $author = $msg->{'AUTHOR'};
				if ($author eq '') { $author = 'CUSTOMER'; }
				$author = &ZOOVY::incode($author);

				my $bgcolor = '#99FF99';
				if ($msg->{'PRIVATE'}) { $bgcolor = '#9999FF';  $author .= " (PRIVATE) "; }

				$c .= qq~
<tr bgcolor="$bgcolor">
	<td>
		<table border=0 cellspacing=0 cellpadding=0 width=100%>
			<tr>
				<td aligh='left'><b>$author</b></td>
				<td align='right'><b>~.&ZTOOLKIT::pretty_date($msg->{'CREATED_GMT'},1).qq~</b>
				</td>
			</tr>
		</table>
	</td>
</tr>~;
				$c .= "<tr><td><pre>$note</pre></td></tr>";
				}
			}
		
		if ($c eq '') {
			$c = qq~<tr><td><i>No updates have been made to this ticket.</i></td></tr>~;
			}
		else {
			}
		$GTOOLS::TAG{'<!-- TICKET_HISTORY -->'} = $c;	


		push @BC, { name=>"Ticket ".$T->tktcode(), link=>"/biz/crm/index.cgi?VERB=TICKET-VIEW&TKTCODE=".$T->tktcode(), };

		$template_file = 'ticket-view.shtml';
		}
	}



##############################################################################################
##
## 
## TICKET LISTING CODE (displays a list of crm in various status, also used for search)
##
##
if (($VERB eq '') || ($VERB =~ /TICKETS\-/)) {
	$template_file = 'index.shtml';

	if ($VERB eq '') { $VERB = 'TICKETS-OPEN'; }	

	my $ticketsref = undef;
	if ($VERB eq 'TICKETS-OPEN') {
		## Shows all open tickets
		$ticketsref = &CUSTOMER::TICKET::getTickets($USERNAME,STATUS=>'OPEN',CID=>$CID);	
		push @BC, { name=>"All Open Tickets" };
		$GTOOLS::TAG{'<!-- HEADER -->'} = "Open Tickets:";
		$tabs++;
		}
	elsif ($VERB eq 'TICKETS-WAITING') {
		$ticketsref = &CUSTOMER::TICKET::getTickets($USERNAME,STATUS=>'WAIT');
		$GTOOLS::TAG{'<!-- HEADER -->'} = "Waiting Tickets";
		push @BC, { name=>"All Waiting Tickets" };
		$tabs++;
		}
	elsif ($VERB eq 'TICKETS-SHOWCID-ALL') {
		$ticketsref = &CUSTOMER::TICKET::getTickets($USERNAME,CID=>$CID);
		$GTOOLS::TAG{'<!-- HEADER -->'} = "Search Results CID=$CID: (ALL)";
		push @BC, { name=>"Show All " };
		if ($CID>0) { push @BC, { name=>"CID: $CID" }; }
		}
	elsif ($VERB eq 'TICKETS-SHOWCID-OPEN') {
		$ticketsref = &CUSTOMER::TICKET::getTickets($USERNAME,CID=>$CID,STATUS=>'OPEN');
		$GTOOLS::TAG{'<!-- HEADER -->'} = "Search Results CID=$CID: (OPEN)";
		push @BC, { name=>"Show Open" };
		if ($CID>0) { push @BC, { name=>"CID: $CID" }; }
		}
	elsif ($VERB eq 'TICKETS-SHOWCID-WAIT') {
		$ticketsref = &CUSTOMER::TICKET::getTickets($USERNAME,CID=>$CID,STATUS=>'WAIT');
		$GTOOLS::TAG{'<!-- HEADER -->'} = "Search Results CID=$CID: (WAITING)";
		push @BC, { name=>"Show Waiting" };
		if ($CID>0) { push @BC, { name=>"CID: $CID" };  }
		}




	if (defined $ticketsref) {
		my $c = '';
		my $r = '';
		foreach my $tkt (@{$ticketsref}) {
			$r = ($r eq 'r0')?'r1':'r0'; 
			if ($tkt->{'ESCALATED'}) { $r = 'rs'; }

			if ($tkt->{'SUBJECT'} eq '') { $tkt->{'SUBJECT'} = 'No subject given.'; }
			if ($tkt->{'CLASS'} eq '') { $tkt->{'CLASS'} = '?'; }
			elsif ($tkt->{'CLASS'} eq 'EXCHANGE') { $tkt->{'CLASS'} = 'EXCHG'; }

			$tkt->{'SUBJECT'} = &ZOOVY::incode($tkt->{'SUBJECT'});
			$c .= qq~<tr class=\"$r\">~;
			$c .= qq~<td><div class='small'><a href=\"index.cgi?VERB=TICKET-VIEW&TKTCODE=$tkt->{'TKTCODE'}\">$tkt->{'TKTCODE'}</a></td>~;

			$c .= qq~<td><div class='small'>$tkt->{'STATUS'} - $tkt->{'CLASS'}</td>~;
			$c .= qq~<td><div class='small'>$tkt->{'SUBJECT'}</td>~;
			$c .= qq~<td><div class='small'>~.&ZTOOLKIT::pretty_date($tkt->{'CREATED_GMT'}).qq~</td>~;

#			if ($VERB ne '') {
#				$c .= "<td>".$tkt->{'STATUS'}."</td>";
#				}

			$c .= qq~</tr>~;
			}

		if ($c eq '') {

			if ($VERB eq '') {
				$c = qq~<tr><td colspan=5><img align="left" src='images/smiley.jpg'><font color='blue'><h2>Yippie! There are no more active calls or tickets!</h2><br><br><center><input class="button" type="button" value=" Refresh " onClick="document.location='/biz/crm/index.cgi?ts=~.time().qq~';"></center></td></tr>~;
				}
			else {
				$c = qq~<tr><td colspan=5><i>No results found</i></td></tr>~;
				}

			}
		$GTOOLS::TAG{'<!-- TICKETS -->'} = $c;
		}

	}



if ($tabs) {
	#	require Net::POP3;
	#	require FUSEMAIL;
	#
	#	## GO GO GADGET IMAP
	#	my ($pop) = Net::POP3->new("pop3.fusemail.net", Timeout => 15);
	#
	#	my $username = "admin\@username.zoovy.com";
	#	my ($password) = &FUSEMAIL::getpassword($username);
	#
	#	if ($pop->login($username, $password) > 0) {
	#		my $msgnums = $pop->list; # hashref of msgnum => size
	#		foreach my $msgnum (keys %$msgnums) {
	#			my $msg = $pop->get($msgnum);
	#			print @$msg;
	#			# $pop->delete($msgnum);
	#			}
	#		}
	##	$pop->quit;
	#
	#	## STOP GADGET IMAP STOP!
	push @TABS, { name=>"Create", link=>"index.cgi?VERB=CREATE", selected=>($VERB eq 'CREATE')?1:0, };
	push @TABS, { name=>"Open", link=>"index.cgi?VERB=TICKETS-OPEN", selected=>($VERB eq 'TICKETS-OPEN')?1:0, };
	push @TABS, { name=>"Waiting", link=>"index.cgi?VERB=TICKETS-WAITING", selected=>($VERB eq 'TICKETS-WAITING')?1:0, };
#		push @TABS, { name=>"Checkout Assist", link=>"index.cgi?VERB=CHECKOUTASSIST", selected=>($VERB eq 'CHECKOUTASSIST')?1:0, };
#		push @TABS, { name=>"Today", link=>"index.cgi?VERB=TICKETS-WAITING", selected=>($VERB eq 'TICKETS-WAITING')?1:0, };
#		push @TABS, { name=>"This Week", link=>"index.cgi?VERB=TICKETS-WAITING", selected=>($VERB eq 'TICKETS-WAITING')?1:0, };
#		push @TABS, { name=>"This Month", link=>"index.cgi?VERB=TICKETS-WAITING", selected=>($VERB eq 'TICKETS-WAITING')?1:0, };
	push @TABS, { name=>"Search", link=>"index.cgi?VERB=SEARCH", selected=>($VERB eq 'SEARCH')?1:0, };
	$VERB = '';
	}

##
## generic message/warn/error handler
##
if ((scalar @ERRORS)>0) {
	my $txt = '';
	foreach my $e (@ERRORS) {
		if ($e =~ /^WARN\:[\s]*(.*?)$/) { $txt .= qq~<div class="yellow_bg">WARNING: $1</div>~; }
		if ($e =~ /^ERR\:[\s]*(.*?)$/) { $txt .= qq~<div class="alert">ERROR: $1</div>~; }
		if ($e =~ /^MSG\:[\s]*(.*?)$/) { $txt .= qq~<div class="captainibs">$1</div>~; }
		}
	$GTOOLS::TAG{'<!-- ERRORS -->'} = "<table width=600><tr><td>$txt</td></tr></table>";
	}


&GTOOLS::output(tabs=>\@TABS,bc=>\@BC,file=>$template_file,header=>1);

&DBINFO::db_zoovy_close();
&DBINFO::db_orders_close();
