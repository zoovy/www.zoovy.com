#!/usr/bin/perl

use lib "/httpd/modules";
require GTOOLS;
require ZOOVY;
require ORDER;
use CGI;
use strict;

&DBINFO::db_zoovy_connect();
my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate("/biz/setup",2,'_O&2');
if ($USERNAME eq '') { exit; }

my $q = new CGI;
print $q->header();

my $ID = $q->param('ID');
my $CMD = $q->param('CMD');
$GTOOLS::TAG{"<!-- ID -->"} = $ID;

if ($ID eq '') { 
	$CMD = 'ERROR'; 
	print "Content-type: text/plain\n\n";
	print "Did not receive order id in CGI params - please contact Zoovy technical support\n\n";
	}

my ($o,$error) = ORDER->new($USERNAME,$ID);

if ($CMD eq 'SAVE') {
	my $counter = 0;
	my $tracking = $o->tracking();
	my $changed=0;
	for ($counter=scalar(@{$tracking})-1;$counter>=0;--$counter) {
		my $trkref = $tracking->[$counter];
		next if (not defined $trkref);
		if (defined $q->param('delete-'.($trkref->{'track'}))) {
			delete $tracking->[$counter];
			$changed++;
			}
		}

	my $method = $q->param('method');
	my $value = $q->param('value');
	my $actualwt = $q->param('actualwt');
	my $notes = $q->param('notes');
	my $cost = $q->param('cost');
	$value =~ s/[^\w-]+//g;
	if ($value ne '') {
		$o->set_tracking($method,$value,$notes,$cost,$actualwt);
		$changed++;
		}

	if ($changed) {
		$o->save();
		}
	$GTOOLS::TAG{"<!-- MESSAGE -->"} = "<br>Order Tracking ID's have been added/updated!<br>\n";
	}

my $template_file = "track.shtml";

my $c = '';
foreach my $trkref (@{$o->tracking()}) {
	my ($method, $value) = ($trkref->{'carrier'},$trkref->{'track'});
	my $notes = $trkref->{'notes'};
	my $cost = $trkref->{'cost'};
	my $actualwt = $trkref->{'actualwt'};

	next if ($value eq '');

	$c .= "<tr>";
	$c .= "<td>&nbsp;</td>";
	$c .= "<td><input type=\"checkbox\" name=\"delete-$value\"></td>";

	$c .= "<td>$trkref->{'carrier'}</td>";
	$c .= "<td>$trkref->{'track'}</td>";

	if ($trkref->{'carrier'} eq 'UPS') {
		$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://wwwapps.ups.com/WebTracking/processInputRequest?HTMLVersion=5.0&loc=en_US&Requester=UPSHome&tracknum=$value&AgreeToTermsAndConditions=yes\">visit UPS.com</a>";
		}
	elsif ($trkref->{'carrier'} eq 'USPS') {
		## updated 11/01/2006
		#$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.usps.com/shipping/trackandconfirm.htm?CUT_AND_PASTE=$value\">visit USPS.com</a>";
		# Apparently usps can have numbers now too! 2/15/07 $value =~ s/[^\d]+//g;
		$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://trkcnfrm1.smi.usps.com/PTSInternetWeb/InterLabelInquiry.do?CAMEFROM=OK&origTrackNum=$value\">visit USPS.com</a>";
		}
	elsif (($trkref->{'carrier'} eq 'FEDX') || ($trkref->{'carrier'} eq 'FDXG') || ($trkref->{'carrier'} eq 'FDXE') || ($trkref->{'carrier'} eq 'FDX')) {
		## updated 08/04/2005, added &tracknumbers=
		#$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.fedex.com/cgi-bin/tracking?last_action=track&ascend_header=1&action=track&language=english&mps=y&ssc=n&ssd=&dsc=n&dsd=&msc=n&msd=&track_type=&cntry_code=us&generic_tracknumber_list=$value%2C&tracknumber_list=&track_number_0=$value&tracknumbers=$value\">visit FedEx.com</a>";

		## updated 10/10/2006
		$c .= "<td bgcolor='FFFFFF'><a target=\"track\" href=\"http://www.fedex.com/Tracking?ascend_header=1&clienttype=dotcom&cntry_code=us&language=english&tracknumbers=$value\">visit FedEx.com</a>";

		## updated 3/1/02
		##http://www.fedex.com/us/tracking/?action=track&language=english&ascend_header=1&cntry_code=1&tracknumbers=$value
		}
	else {
		$c .= "<td bgcolor='FFFFFF'>n/a</td>";
		}
	
	$c .= "</tr>";
	if ($actualwt || $cost || $notes) {
		$c .= "<tr><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>";
		if ($cost) { $c .= "Shipping Cost: ".sprintf("%.2f",$cost)."<br>"; }
		if ($actualwt) { $c .= "Actual Weight: ".$actualwt."<br>"; }
		if ($notes) { $c .= "Shipping Notes: ".$notes."<br>"; }
		$c .= "</td></tr>";
		}

	}

if ($c eq '') {
	$c = "<tr bgcolor='white'><td></td><td colspan='3'><i>Sorry, no tracking information is available.</td></tr>";
	}

$GTOOLS::TAG{"<!-- CONTENTS -->"} = $c;

&GTOOLS::print_form("",$template_file);

&DBINFO::db_zoovy_close();
