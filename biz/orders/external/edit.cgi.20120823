#!/usr/bin/perl

use lib "/httpd/modules";
use GTOOLS;
use EXTERNAL;
use ZOOVY;

$q = new CGI;

my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate("/biz/setup",2,'_O&4');
if ($USERNAME eq '') { exit; }


$ID = $q->param('ID');
$CMD = $q->param('CMD');
$GTOOLS::TAG{"<!-- ID -->"} = $ID;

# populates the info hash with the record we need
my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};

if ($CMD eq "SAVE") {

	$info{'BUYER_EMAIL'} = $q->param('BUYER_EMAIL');
	$info{'ZOOVY_ORDERID'} = $q->param('ORDER_ID');
	$info{'STAGE'} = $q->param('STAGE');
	$info{'QTY'} = $q->param('PRODUCT_QUANTITY')+0;
	if ($info{'QTY'}<=0) { $info{'QTY'} = "1"; }

	$info{'PRICE'} = $q->param('PRODUCT_PRICE');
	$info{'PRICE'} =~ s/[^0-9^\.]//g;
	$info{'PROD_NAME'} = $q->param('PRODUCT_NAME');
	$info{'SKU'} = $q->param('PRODUCT');
   
	if (&EXTERNAL::save($USERNAME,$ID,\%info))	{
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} 
	else {
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	# reload the hash(es)
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
	}



if ($CMD eq 'COPYPOG') {

	my $incvars = &ZOOVY::attrib_handler_ref($info{'DATA'});
	my $prodvars = &ZOOVY::fetchproduct_as_hash($USERNAME,$info{'PRODUCT'});
	foreach my $k (keys %{$prodvars}) {
		next unless ($k =~ /^$USERNAME\:pog/);
		$incvars->{$k} = $prodvars->{$k};
		}
	$info{'DATA'} = &ZOOVY::attrib_to_str_ref($incvars);		
	if (&EXTERNAL::saveexternal_full(\%info))	{
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} else {
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
	}



if ($CMD eq "RAWSAVE") {
	$vars = &ZOOVY::attrib_handler_ref($info{'DATA'});

	foreach $k ($q->param()) {
		next unless ($k =~ /^\$\$/);
		$vars->{substr($k,2)} = $q->param($k);
		}

	$info{'DATA'} = &ZOOVY::attrib_to_str_ref($vars);

	if (&EXTERNAL::saveexternal_full(\%info))
		{
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} else {
		$GTOOLS::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	# reload the hash(es)
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
}




if ($CMD eq 'RAWEDIT') {
	use Data::Dumper;
	$vars = &ZOOVY::attrib_handler_ref($info{'DATA'});
	$c = '';
	foreach $k (sort keys %{$vars}) {
		$c .= "<tr><td>$k:<br><input type=\"textbox\" name=\"\$\$$k\" value=\"".&ZOOVY::incode($vars->{$k})."\">\n</td></tr>\n";
		}
	$GTOOLS::TAG{'<!-- KEYS -->'} = $c;
	$GTOOLS::TAG{'<!-- OUTPUT -->'} = "<pre>".Dumper($vars)."</pre>";

	$template_file = 'rawedit.shtml';
	}


if ($CMD eq "DELETE-CONFIRM")
{
	$ID = $q->param('ID');
	&EXTERNAL::nuke_external_item($USERNAME,$ID);
	print "Location: main.cgi\n\n";
}

if ($CMD eq "DELETE")
{
   $GTOOLS::TAG{"<!-- ID -->"} = $info{'ID'};
	$GTOOLS::TAG{"<!-- MESSAGE -->"} = "<font face='verdana, arial, helvetica'><font color='red'>Warning: You are about to delete an External Sale from the system.</font><br>";
	$GTOOLS::TAG{"<!-- MESSAGE -->"} .= "<br><br>This will completely remove this item from the system.<br>";
	$GTOOLS::TAG{"<!-- MESSAGE -->"} .= "If you want to prevent a person from purchasing this item, simply ";
	$GTOOLS::TAG{"<!-- MESSAGE -->"} .= "set the item's stage to REVOKED. <br>Proceeding item will result in all tracking ";
	$GTOOLS::TAG{"<!-- MESSAGE -->"} .= "information being lost.<br><br></font>";


	$GTOOLS::TAG{"<!-- CMD -->"} = "DELETE-CONFIRM";
	$GTOOLS::TAG{"<!-- CANCEL -->"} = "edit.cgi?ID=".$info{'ID'};
	$template_file = "edit-confirm.shtml";
}




if ($CMD eq "" || $CMD eq "EDIT")
{
if (!defined(%info))
	{
 	# Eerror 
	} else {

	my %data = ();

	$GTOOLS::TAG{"<!-- ID -->"} = &ZOOVY::incode($info{'ID'});
	$GTOOLS::TAG{"<!-- CHANNEL -->"} = &ZOOVY::incode($info{'CHANNEL'});
	$GTOOLS::TAG{"<!-- MKT -->"} = &ZOOVY::incode($info{'MKT'});
	$GTOOLS::TAG{"<!-- PRT -->"} = &ZOOVY::incode($info{'PRT'});
	$GTOOLS::TAG{"<!-- SKU -->"} = &ZOOVY::incode($info{'SKU'});
	$GTOOLS::TAG{"<!-- ORDER_ID -->"} = &ZOOVY::incode($info{'ORDER_ID'});
	$GTOOLS::TAG{"<!-- CREATED -->"} = &ZTOOLKIT::pretty_date($info{'CREATED_GMT'});
	$GTOOLS::TAG{"<!-- BUYER_EMAIL -->"} = &ZOOVY::incode($info{'BUYER_EMAIL'},1);
	$GTOOLS::TAG{"<!-- CLAIM_URL -->"} = "http://www.".&EXTERNAL::resolve_checkoutdomain($USERNAME,prt=>$info{'PRT'})."/claim/".$info{'ID'};

## LASTCONTACT
	if ($info{'LASTCONTACT'}) { $GTOOLS::TAG{"<!-- LASTCONTACT -->"} = &ZOOVY::incode($info{'EXPIRES'}); } else { $GTOOLS::TAG{"<!-- LASTCONTACT -->"} = "Never"; }

## STAGE
	$c = "";
	# if its active then add that to the list.
	if ($info{'STAGE'} eq "A") { $c = "<option SELECTED value='A'>Active (*)</option>"; } else { $c = "<option value='A'>Active</option>"; }
	# if the STAGE is either Informed or Visited then emulate Active
	if ($info{'STAGE'} eq "I") { $c = "<option SELECTED value='I'>Active - Informed (*)</option>"; }
	if ($info{'STAGE'} eq "V") { $c = "<option SELECTED value='V'>Active - Visited (*)</option>"; }
	
	# always add Hold to the list (COMPLETED will remove On Hold)
	if ($info{'STAGE'} eq "H") { $c .= "<option SELECTED value='H'>On Hold (*)</option>"; } else { $c .= "<option value='H'>On Hold</option>"; }
	if ($info{'STAGE'} eq "P") { $c .= "<option SELECTED value='P'>Waiting for Server (*)</option>"; } else { $c .= "<option value='P'>Waiting for Server</option>"; }

	# if we are completed then that should REALLY be the only option
	if ($info{'STAGE'} eq "C") { $c = "<option SELECTED value='C'>Completed (*)</option>"; }
	# if the stage is not set then lets assume its an error??
	if ($info{'STAGE'} ne "A" &&
 		$info{'STAGE'} ne "I" &&
 		$info{'STAGE'} ne "V" &&
 		$info{'STAGE'} ne "H" &&
 		$info{'STAGE'} ne "P" &&
 		$info{'STAGE'} ne "C") { $c .= "<option value='E'>Error (*)</option>"; } 
	$GTOOLS::TAG{"<!-- STAGE -->"} = $c;

	$GTOOLS::TAG{"<!-- PRODUCT_NAME -->"} = $info{'PROD_NAME'};
	$GTOOLS::TAG{"<!-- PRODUCT_PRICE -->"} = $info{'PRICE'};

## TAXABLE
	$GTOOLS::TAG{"<!-- PRODUCT_QUANTITY -->"} = $info{'QTY'};
	$GTOOLS::TAG{'<!-- SEARCH -->'} = $data{'zoovy:search'};

	if ($data{$USERNAME.":pogs"})
		{
		$c = "<font face='verdana, arial'>The following Product Options will be presented:</font><br>";
		@pogs = split(',',$data{$USERNAME.":pogs"});
	
		$c .= "<table>";
		foreach $pog (@pogs)
			{
			$pogpretty = $pog;
			$pogpretty =~ s/_/ /g;
			$c .= "<tr><td class='A'>$pogpretty:</td>";
			$c .= "<td class='A'><select>".ZSKU::pog_to_html($data{$USERNAME.":pog_".lc($pog)})."</select></td></tr>";
			}
		$c .= "</table>";
		$GTOOLS::TAG{"<!-- POG_DISPLAY -->"} = $c;	
		}
	$template_file = "edit.shtml";
	}
}

&GTOOLS::output(file=>$template_file,header=>1);
