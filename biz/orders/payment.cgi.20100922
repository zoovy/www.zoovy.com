#!/usr/bin/perl -w

no warnings 'once'; # Keep perl -w from whining about variables used only once

use lib "/httpd/modules";
require GTOOLS;
require ZOOVY;
require ZPAY;
require ZWEBSITE;
require ZTOOLKIT;
use strict;

&DBINFO::db_zoovy_connect();


require LUSER;
my ($LU) = LUSER->authenticate(flags=>'_O&8');
if (not defined $LU) { exit; }

my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
if ($MID<=0) { exit; }


my $ID = $ZOOVY::cgiv->{'ID'};
my $CMD = $ZOOVY::cgiv->{'CMD'};

if ($ID eq '') { print "Content-type: text/plain\n\nSorry you must pass an order id to use this program.\n"; exit; }
$GTOOLS::TAG{'<!-- TS -->'} = time();
$GTOOLS::TAG{'<!-- ID -->'} = $ID;


# this sometimes had the wrong values.
my ($o) = ORDER->new($USERNAME,$ID);

if ($CMD eq 'CAPTURE') {
	my ($result,$msg) = $o->payment('CAPTURE');
	$GTOOLS::TAG{'<!-- MESSAGE -->'} = $msg;
	}

if ($CMD eq 'CHECKFORUPDATES') {
	## THIS DOES NOTHING, BUT THE USER CAN PRESS IT WHILE WE'RE WAITING FOR GOOGLE TO ASYNC NOTIFY US
	}


if ($CMD eq 'VOID') {
	my ($result,$msg) = $o->payment('VOID');
	$GTOOLS::TAG{'<!-- MESSAGE -->'} = $msg;
	}

if ($CMD eq 'CREDIT') {
	my $amount = $ZOOVY::cgiv->{'CREDITAMOUNT'};
   $amount =~ s/[^\d\.]+//gs;
   $amount+=0;
   $amount = sprintf("%.2f",$amount);
	my ($result,$msg) = $o->payment('CREDIT',amount=>$amount);
	$GTOOLS::TAG{'<!-- MESSAGE -->'} = $msg;
	}


if ($CMD eq 'PROCESSECHECK') {
	my ($result, $msg) = gateway_charge($o);
	$GTOOLS::TAG{'<!-- MESSAGE -->'} = " [$result] $msg ";
	}


if ($CMD eq 'GOOGLECANCEL') {
	## GOOGLE CANCEL
	require ZPAY::GOOGLE;
	($o) = &ZPAY::GOOGLE::cancelOrder($o);	
	}
elsif ($CMD eq 'GOOGLEREFUND') {
	## GOOGLE REFUND
	require ZPAY::GOOGLE;
	($o) = &ZPAY::GOOGLE::refundOrder($o);
	($o) = &ZPAY::GOOGLE::cancelOrder($o);	
	}
elsif ($CMD eq 'BUYSAFECANCEL') {
	## BUYSAFE CANCEL
	require BUYSAFE;
	&BUYSAFE::SetShoppingCancelOrder($o);
	}


if ($CMD =~ /PAYPALEC\-(.*?)$/) {
	## PAYPAL EXPRESS CHECKOUT
	require ZPAY::PAYPALVT;
	if ($CMD eq 'PAYPALEC-VOID') {
		my ($result) = &ZPAY::PAYPALVT::DoVoid($o);
		if ($result eq '') { $result = 'Success'; }
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = "VOID DoExpressCheckoutPayment: [$result] ";
		$o->event('DoExpressCheckoutPayment: VOID',undef,2,$LU->login());
		$o->save();
		}

	if ($CMD eq 'PAYPALEC-CAPTURE') {
		my ($result) = &ZPAY::PAYPALVT::DoCapture($o);
		if ($result eq '') { $result = 'Success'; }
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = "CAPTURE DoExpressCheckoutPayment: [$result] ";
		$o->event("DoExpressCheckoutPayment: CAPTURE ($result)",undef,2,$LU->login());
		$o->save();
		}
	}

if ($CMD eq 'PROCESSCREDIT') {
	my ($result,$msg) = $o->pay_init('CREDIT',0);
	$o->save();
	$GTOOLS::TAG{'<!-- MESSAGE -->'} = " [$result] $msg ";
	}

if ($CMD eq "CHANGE_PAYMENT") {
	$ZOOVY::cgiv->{'SELECTED_TYPE'} =~ s/\W+//g;
	$o->set_attrib('payment_method',$ZOOVY::cgiv->{'SELECTED_TYPE'});
	$o->set_payment_status($ZOOVY::cgiv->{'PAYMENT_STATUS'},"payment.cgi#1|$LUSERNAME");
	$o->save();
	}

## when is it okay to display/update CVV #?
##		2xx - denied (for reprocessing)
##		100 - manually created order/pending
my $ps = $o->get_attrib('payment_status');
my $cvvok = 0;
if ((substr($ps,0,1) eq '2') || ($ps eq '100')) { 
	$cvvok = 1; 
	}


if ($CMD eq "UPDATE") {

	if ($o->get_attrib('payment_method') eq 'PO') {
		$o->set_attrib('po_number',$ZOOVY::cgiv->{'PO_NUMBER'});
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = 'Saved PO Number';
		}

	if ($o->get_attrib('payment_method') eq 'CREDIT') {
		my $get_tax_id = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_tax_id');
		if ((not defined $get_tax_id) || ($get_tax_id eq '')) { $get_tax_id = 0; }

		if ($get_tax_id) { $o->set_attrib('tax_id',$ZOOVY::cgiv->{'tax_id'}); }
		elsif (defined($o->get_attrib('tax_id'))) { $o->unset_attrib('tax_id'); }
		
		my $get_drivers_license_number = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_number');
		if ((not defined $get_drivers_license_number) || ($get_drivers_license_number eq '')) { $get_drivers_license_number = 0; }
		if ($get_drivers_license_number) { $o->set_attrib('drivers_license_number',$ZOOVY::cgiv->{'drivers_license_number'}); }
		elsif (defined($o->get_attrib('drivers_license_number'))) { $o->unset_attrib('drivers_license_number'); }

		my $get_drivers_license_state = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_state');
		if ((not defined $get_drivers_license_state) || ($get_drivers_license_state eq '')) { $get_drivers_license_state = 0; }
		if ($get_drivers_license_state) { $o->set_attrib('drivers_license_state',$ZOOVY::cgiv->{'drivers_license_state'}); }
		elsif (defined($o->get_attrib('drivers_license_state'))) { $o->unset_attrib('drivers_license_state'); }

		my $get_drivers_license_dob = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_dob');
		if ((not defined $get_drivers_license_dob) || ($get_drivers_license_dob eq '')) { $get_drivers_license_dob = 0; }
		if ($get_drivers_license_dob) { $o->set_attrib('drivers_license_dob',$ZOOVY::cgiv->{'drivers_license_dob'}); }
		elsif (defined($o->get_attrib('drivers_license_dob'))) { $o->unset_attrib('drivers_license_dob'); }

		my $get_business_account = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_business_account');
		if ((not defined $get_business_account) || ($get_business_account eq '')) { $get_business_account = 0; }
		if ($get_business_account) { $o->set_attrib('business_account',$ZOOVY::cgiv->{'business_account'}); }
		elsif (defined($o->get_attrib('business_account'))) { $o->unset_attrib('business_account'); }

		$o->set_attrib('card_number',$ZOOVY::cgiv->{'card_number'});
		$o->set_attrib('card_exp_month',$ZOOVY::cgiv->{'card_exp_month'});
		$o->set_attrib('card_exp_year',$ZOOVY::cgiv->{'card_exp_year'});
		if (defined $ZOOVY::cgiv->{'cvvcid_number'}) { 
			$o->set_attrib('cvvcid_number',$ZOOVY::cgiv->{'cvvcid_number'}); 
			}

		$o->event('Updated credit card information',undef,2,$LU->login());
		if ($ZOOVY::cgiv->{'delete_payment_status'}) { 
			$o->event('Reset Payment Status to allow card to be re-authorized',undef,2,$LU->login()); 
			## payment_reset is a counter to track how many times the payment is reset
			$o->set_attrib('payment_reset',(defined $o->get_attrib('payment_reset'))?(int($o->get_attrib('payment_reset'))+1):1);
			$o->set_payment_status('100',"payment.cgi#a|$LUSERNAME");
			}
#		if ($ZOOVY::cgiv->{'delete_payment_cc_status'}) { 
#			$o->('Nuked payment information for order was ['.$o->get_attrib('payment_cc_results').']');
#			$o->set_attrib('payment_cc_status','');
#			$o->set_attrib('payment_cc_results','');
#			$o->set_payment_status('100','payment.cgi#b');
#			}
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = 'Saved Credit Settings'; 
		}

	if ($o->get_attrib('payment_method') eq 'ECHECK') {
		my $get_tax_id = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_tax_id');
		if ((not defined $get_tax_id) || ($get_tax_id eq '')) { $get_tax_id = 0; }
		if ($get_tax_id) { $o->set_attrib('tax_id',$ZOOVY::cgiv->{'tax_id'}); }
		elsif (defined $o->get_attrib('tax_id')) { $o->unset_attrib('tax_id'); }

		my $get_drivers_license_number = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_number');
		if ((not defined $get_drivers_license_number) || ($get_drivers_license_number eq '')) { $get_drivers_license_number = 0; }
		if ($get_drivers_license_number) { $o->set_attrib('drivers_license_number',$ZOOVY::cgiv->{'drivers_license_number'}); }
		elsif (defined $o->get_attrib('drivers_license_number')) { $o->unset_attrib('drivers_license_number'); }

		my $get_drivers_license_state = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_state');
		if ((not defined $get_drivers_license_state) || ($get_drivers_license_state eq '')) { $get_drivers_license_state = 0; }
		if ($get_drivers_license_state) { $o->set_attrib('drivers_license_state',$ZOOVY::cgiv->{'drivers_license_state'}); }
		elsif (defined $o->get_attrib('drivers_license_state')) { $o->unset_attrib('drivers_license_state'); }

		my $get_drivers_license_dob = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_dob');
		if ((not defined $get_drivers_license_dob) || ($get_drivers_license_dob eq '')) { $get_drivers_license_dob = 0; }
		if ($get_drivers_license_dob) { $o->set_attrib('drivers_license_dob',$ZOOVY::cgiv->{'drivers_license_dob'}); }
		elsif (defined $o->get_attrib('drivers_license_dob')) { $o->unset_attrib('drivers_license_dob'); }

		my $get_business_account = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_business_account');
		if ((not defined $get_business_account) || ($get_business_account eq '')) { $get_business_account = 0; }
		if ($get_business_account) { $o->set_attrib('business_account',$ZOOVY::cgiv->{'business_account'}); }
		elsif (defined $o->get_attrib('business_account')) { $o->unset_attrib('business_account'); }

		my $get_bank_state = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_bank_state');
		if ((not defined $get_bank_state) || ($get_bank_state eq '')) { $get_bank_state = 0; }
		if ($get_bank_state) { $o->set_attrib('echeck_bank_state',$ZOOVY::cgiv->{'echeck_bank_state'}); }
		elsif (defined $o->get_attrib('echeck_bank_state')) { $o->unset_attrib('echeck_bank_state'); }

		$o->set_attrib('echeck_acct_name',$ZOOVY::cgiv->{'echeck_acct_name'});
		$o->set_attrib('echeck_bank_name',$ZOOVY::cgiv->{'echeck_bank_name'});
		$o->set_attrib('echeck_aba_number',$ZOOVY::cgiv->{'echeck_aba_number'});
		$o->set_attrib('echeck_acct_number',$ZOOVY::cgiv->{'echeck_acct_number'});
		$o->set_attrib('echeck_check_number',$ZOOVY::cgiv->{'echeck_check_number'});

		$o->event('Updated eCheck properties',undef,2,$LU->login()); 
		if ($ZOOVY::cgiv->{'delete_payment_status'}) { 
			$o->event('Reset Payment Status to allow e-check to be re-authorized',undef,2,$LU->login()); 
			$o->set_payment_status('100',"payment.cgi#c|$LUSERNAME");
			}

#		if ($ZOOVY::cgiv->{'delete_payment_echeck_status'}) { 
#			$o->('Nuked payment information for order was ['.$o->get_attrib('payment_cc_results').']');
#			$o->set_attrib('payment_echeck_status','');
#			$o->set_attrib('payment_echeck_results','');
#			$o->set_payment_status('100','payment.cgi#d');
#			}
		$GTOOLS::TAG{'<!-- MESSAGE -->'} = 'Saved Credit Settings'; 
		}
	$o->save();
	}



my $c = '';
foreach my $pref (@{$o->payments()}) {
	$c .= "<tr>";
	$c .= sprintf("<td nowrap valign=top>%s</td>",$pref->{'tender'});
	$c .= sprintf("<td nowrap valign=top>%s</td>",&ZTOOLKIT::pretty_date($pref->{'ts'}));
	$c .= sprintf("<td nowrap valign=top>%s</td>",$pref->{'note'});
	$c .= sprintf("<td nowrap valign=top>\$%.2f</td>",$pref->{'amt'});
	$c .= sprintf("<td valign=top>(%s) %s</td>",$pref->{'ps'},$ZPAY::PAYMENT_STATUS{$pref->{'ps'}});
	$c .= "</tr>";
#	$c .= "<tr><td>".Dumper($pref)."</td></tr>";
	}
if ($c eq '') {
	$c .= "<tr><td colspan=5><i>No Payments have been recorded.</i></td></tr>";
	}
$GTOOLS::TAG{'<!-- PAYMENTS -->'} = $c;


##
##
##
$c = "";
my $ar = ZPAY::payment_methods($USERNAME,prt=>$o->prt(),admin=>1);
## NOTE: at some point we'll want to remove 'PAYPAL' legacy from this list using admin=>1
##			but we'd need to build in support for getting a paypal authroization for an ORDER (not a cart)
##			which is really more appropriate for a quote, not an order.
#my $ar = ZPAY::payment_methods($USERNAME,prt=>$o->prt(),admin=>1);
#use Data::Dumper;
#$GTOOLS::TAG{'<!-- DEBUG -->'} = '<pre>'.Dumper($ar).'</pre>'; 
my $FOUND = 0;
foreach my $pmref (@{$ar}) {
	my ($selected) = (uc($o->get_attrib('payment_method')) eq $pmref->{'id'})?'selected':'';
	if ($selected ne '') { $FOUND++; }
	
	# $c .= "<option>$pmref->{'id'}</option>";
	$c .= "<option $selected value='$pmref->{'id'}'>$pmref->{'id'}: $pmref->{'pretty'}</option>";
	}
# if we made a match on accepted payment the ASSUME its a valid payment type
# otherwise, don't and show this payment type as a custom.
if (!$FOUND) {
	$c .= "<option value='".$o->get_attrib('payment_method')."' selected>".$o->get_attrib('payment_method')."</option>";
	}
$GTOOLS::TAG{"<!-- ACCEPTED_METHOD -->"} = $c;

my $PAYMENTSTATUS = '';
for (my $x=0;$x<4;$x++) { $GTOOLS::TAG{"<!-- STATUS_".$x." -->"} = ''; }

$c = '';
my $GENERALCODE = undef;
if (length($o->get_attrib('payment_status'))==3) {
	$PAYMENTSTATUS = $o->get_attrib('payment_status');
	$GENERALCODE = substr($o->get_attrib('payment_status'),0,1);
	}
else {
	$GENERALCODE = $o->get_attrib('payment_status');
	$PAYMENTSTATUS = sprintf("%d00",$GENERALCODE);
	}

$GTOOLS::TAG{'<!-- PAYMENT_STATUS -->'} = $PAYMENTSTATUS;

if ($GENERALCODE eq "0") { $c .= "PAYMENT_STATUS: paid in full<br>"; $GTOOLS::TAG{'<!-- STATUS_0 -->'} = 'CHECKED'; }
elsif ($GENERALCODE eq "1") { $c .= "PAYMENT_STATUS: pending<br>";  $GTOOLS::TAG{'<!-- STATUS_1 -->'} = 'CHECKED'; }
elsif ($GENERALCODE eq "2") { $c .= "PAYMENT_STATUS: denied<br>"; $GTOOLS::TAG{'<!-- STATUS_2 -->'} = 'CHECKED'; }
elsif ($GENERALCODE eq "3") { $c .= "PAYMENT_STATUS: order cancelled<br>";  $GTOOLS::TAG{'<!-- STATUS_3 -->'} = 'CHECKED'; }
else { $c .= "PAYMENT_STATUS: [".$GENERALCODE."] unknown.\n"; }

$GTOOLS::TAG{'<!-- PAYMENT_STATUS_DETAIL -->'} = $ZPAY::PAYMENT_STATUS{$PAYMENTSTATUS};
$GTOOLS::TAG{'<!-- IP_ADDRESS -->'} = $o->get_attrib('ip_address');
$GTOOLS::TAG{'<!-- EREFID -->'} = $o->get_attrib('erefid');
  
# $c .= "PAYMENT STATUS: ".$GENERALCODE."<br>";
# $GENERALCODE
# 0 paid in full
# 1 pending
# 2 denied
# 3 order cancelled

$c .= "PAYMENT METHOD: ".$o->get_attrib('payment_method')."<br>";
# $ORDER{"payment_method"}
# PAYPAL, CREDIT, COD, CHKOD, CASH, CHECK

if ($o->get_attrib('payment_method') eq "PO") {
	$c .= "PO Number: <input type='textbox' name='PO_NUMBER' value=\"".$o->get_attrib('po_number')."\"><br>";
	}
  

if ($o->get_attrib('payment_method') eq 'PAYPALEC') {
	if ($PAYMENTSTATUS == '089') {
		# $GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PAYPALEC-VOID&ID=$ID&time=<!-- TS -->';\" value=\"Void Transaction\"></td>";		
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td valign='top'>Credit Amount: \$</td><td><input size=5 type='textbox' name='CREDITAMOUNT' value='".sprintf("%.2f",$o->get_attrib('order_total'))."'>";
		$GTOOLS::TAG{'<!-- BUTTONS -->'} .= "<input type=\"button\" onClick=\"document.location='payment.cgi?CMD=CREDIT&ID=$ID&CREDITAMOUNT='+document.updateFrm.CREDITAMOUNT.value+'&time=<!-- TS -->';\" value=\" Process Credit \"><br></td></tr><tr>";	
		}
	elsif (($PAYMENTSTATUS == 189) || ($PAYMENTSTATUS == 289)) {
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PAYPALEC-CAPTURE&ID=$ID&time=<!-- TS -->';\" value=\"Capture Funds\"></td>";
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PAYPALEC-VOID&ID=$ID&time=<!-- TS -->';\" value=\"Void Transaction\"></td>";
		}
	}




if ($o->get_attrib('payment_method') eq 'GOOGLE') {
	$c .= "GOOGLE ORDERID: ".$o->get_attrib('google_orderid')."<br>";

	if (($PAYMENTSTATUS eq '011') || ($PAYMENTSTATUS eq '411')) {
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=GOOGLEREFUND&ID=$ID&time=<!-- TS -->';\" value=\"Refund Funds\"></td>";
		}
	elsif (($PAYMENTSTATUS eq '199') || ($PAYMENTSTATUS eq '111')) {
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=GOOGLECANCEL&ID=$ID&time=<!-- TS -->';\" value=\"Cancel Order\"></td>";
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=CAPTURE&ID=$ID&time=<!-- TS -->';\" value=\"Capture Funds\"></td>";
		}
	elsif ($PAYMENTSTATUS eq '511') {
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=CHECKFORUPDATES&ID=$ID&time=<!-- TS -->';\" value=\"Check for Updates\"></td>";
		}
	}


#if (int($o->get_attrib('buysafe_notified_gmt'))>0) {
#	$GTOOLS::TAG{'<!-- BUTTONS -->'} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=BUYSAFECANCEL&ID=$ID&time=<!-- TS -->';\" value=\"Cancel BuySafe Bond\"></td>";
#	}

if ($o->get_attrib('payment_method') eq "CREDIT") {
	$c .= "PAYMENT_CC_RESULTS: ".$o->get_attrib('payment_cc_results')."<br>";
	$c .= "PAYMENT_CC_PROCESSOR: ".$o->get_attrib('payment_cc_processor')."<br>";
		
	my $get_tax_id = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_tax_id');
	if ((not defined $get_tax_id) || ($get_tax_id eq '')) { $get_tax_id = 0; }
	my $get_drivers_license_number = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_number');
	if ((not defined $get_drivers_license_number) || ($get_drivers_license_number eq '')) { $get_drivers_license_number = 0; }
	my $get_drivers_license_state = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_state');
	if ((not defined $get_drivers_license_state) || ($get_drivers_license_state eq '')) { $get_drivers_license_state = 0; }
	my $get_drivers_license_dob = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_drivers_license_dob');
	if ((not defined $get_drivers_license_dob) || ($get_drivers_license_dob eq '')) { $get_drivers_license_dob = 0; }
	my $get_business_account = &ZWEBSITE::fetch_website_attrib($USERNAME,'cc_request_business_account');
	if ((not defined $get_business_account) || ($get_business_account eq '')) { $get_business_account = 0; }
	
	$c .= "<table width='618'>";
	$c .= "<tr><td><input type='checkbox' name='delete_payment_status'></td><td>Reset order to allow re-processing?</td></tr>";
	$c .= "<tr><td>Card Number:</td><td><input type='textbox' name='card_number' value='".$o->get_attrib('card_number')."'></td></tr>";
	$c .= "<tr><td>Expires:</td><td><input maxlength='2' size ='2' type='textbox' name='card_exp_month' value='".$o->get_attrib('card_exp_month')."'> / ";
	$c .= "<input maxlength='2' type='textbox' size='2' name='card_exp_year' value='".$o->get_attrib('card_exp_year')."'></td></tr>";
	if ($cvvok) { 
		$c .= "<tr><td>CCVCID:</td><td><input type='textbox' size='4' name='cvvcid_number' value='".$o->get_attrib('cvvcid_number')."'><br></td></tr>"; 
		$c .= "<tr><td colspan='2'><i>You may enter/correct the CVV # for orders which are manually created or which have a denied payment status. Per Visa/MC regulations CVV #'s may not be stored and may only be used for immediate processing - please check with your merchant account provider.</td></tr>";
		}

	my ($helplink,$helphtml) = GTOOLS::help_link('Credit Card Processing Webdoc',50304);
	$c .= "<tr><td>$helphtml</td></tr>";
	if ($get_business_account) {
		if ((not defined $o->get_attrib('business_account')) || ($o->get_attrib('business_account') eq '')) {
			$o->set_attrib('business_account',$o->get_attrib('billing_company')?1:0);
			}
		my $options = '<option value="0" selected>Personal</option><option value="1">Business</option>';
		if ($o->get_attrib('business_account')) {
			$options = '<option value="0">Personal</option><option value="1" selected>Business</option>';
			}
		$c .= qq~<tr><td align='right'>Account Type:</td><td><select name="business_account">$options</select></td></tr>~;
		}
	if ($get_tax_id) {
		$c .= qq~<tr><td align='right'>SSN / Tax ID:</td><td><input type='textbox' name='tax_id' value="".$o->get_attrib('tax_id').""></td></tr>~;
		}
	if ($get_drivers_license_number) {
		$c .= qq~<tr><td align='right'>Driver's License Number:</td><td><input type='textbox' name='drivers_license_number' value="".$o->get_attrib('drivers_license_number').""></td></tr>~;
		}
	if ($get_drivers_license_state) {
		$c .= qq~<tr><td align='right'>Driver's License State:</td><td><input type='textbox' name='drivers_license_state' value="".$o->get_attrib('drivers_license_state').""></td></tr>~;
		}
	if ($get_drivers_license_dob) {
		$c .= qq~<tr><td align='right'>Driver's License DOB:</td><td><input type='textbox' name='drivers_license_dob' value="".$o->get_attrib('drivers_license_dob').""></td></tr>~;
		}
	$c .= "</table>";
	
	if ($PAYMENTSTATUS ne '') {
		if ($PAYMENTSTATUS < 100) {
			$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td valign='top'>Credit Amount: \$</td><td><input size=5 type='textbox' name='CREDITAMOUNT' value='".sprintf("%.2f",$o->get_attrib('order_total'))."'>";
			$GTOOLS::TAG{'<!-- BUTTONS -->'} .= "<input type=\"button\" onClick=\"document.location='payment.cgi?CMD=CREDIT&ID=$ID&CREDITAMOUNT='+document.updateFrm.CREDITAMOUNT.value+'&time=<!-- TS -->';\" value=\" Process Credit \"><br><font size='2'><i>Warning: some gateways will perform a FULL credit, regardless of the amount you enter. New users should verify that their gateway can perform partial credits.</font></td></tr><tr>";	
			}

		if ($PAYMENTSTATUS == 100) {
			$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PROCESSCREDIT&ID=$ID&time=<!-- TS -->';\" value=\"Process Again\"></td>";	
			}

		if ($PAYMENTSTATUS == 109) { ## 109 is new status for NOAUTH_DELAY for cc_instant_capture.  See payment setup screens for more info
			$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PROCESSCREDIT&ID=$ID&time=<!-- TS -->';\" value=\"Charge Credit Card\"></td>";	
			}

		if (($PAYMENTSTATUS == 199) || ($PAYMENTSTATUS == 189) || ($PAYMENTSTATUS == 299) || ($PAYMENTSTATUS == 499)) {
			$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=CAPTURE&ID=$ID&time=<!-- TS -->';\" value=\"Capture Funds\"></td>";
			$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=VOID&ID=$ID&time=<!-- TS -->';\" value=\"Void Transaction\"></td>";
			}

		}
	}

if ($o->get_attrib('payment_method') eq "ECHECK") {
	my $get_name     = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_acct_name');
	if ((not defined $get_name) || ($get_name eq '')) { $get_name = 0; }
	my $get_checknum = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_check_number');
	if ((not defined $get_checknum) || ($get_checknum eq '')) { $get_checknum = 0; }
	my $get_tax_id = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_tax_id');
	if ((not defined $get_tax_id) || ($get_tax_id eq '')) { $get_tax_id = 0; }
	my $get_drivers_license_number = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_number');
	if ((not defined $get_drivers_license_number) || ($get_drivers_license_number eq '')) { $get_drivers_license_number = 0; }
	my $get_drivers_license_state = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_state');
	if ((not defined $get_drivers_license_state) || ($get_drivers_license_state eq '')) { $get_drivers_license_state = 0; }
	my $get_drivers_license_dob = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_drivers_license_dob');
	if ((not defined $get_drivers_license_dob) || ($get_drivers_license_dob eq '')) { $get_drivers_license_dob = 0; }
	my $get_business_account = &ZWEBSITE::fetch_website_attrib($USERNAME,'echeck_request_business_account');
	if ((not defined $get_business_account) || ($get_business_account eq '')) { $get_business_account = 0; }
	
	$c .= "<table align='center'>";
	$c .= "<tr><td colspan='2' align='left'><input type='checkbox' name='delete_payment_status'> Reset order to allow re-processing?</td></tr>";
	$c .= "<tr><td colspan='2' align='left'><input type='checkbox' name='delete_payment_echeck_status'> Remove eCheck status messages</td></tr>";
	
	if ($get_name) {
		$c .= "<tr><td align='right'>Name on Account:</td><td><input type='textbox' name='echeck_acct_name' value=\"".$o->get_attrib('echeck_acct_name')."\"></td></tr>";
		}

	$c .= "<tr><td align='right'>Bank Name:</td><td><input maxlength='50' size ='30' type='textbox' name='echeck_bank_name' value=\"".$o->get_attrib('echeck_bank_name')."\"></td></tr>";
	$c .= "<tr><td align='right'>ABA / Routing Number:</td><td><img src=\"/biz/orders/images/mirc1.gif\" border=\"0\" width=\"14\" height=\"14\"><input maxlength='9' size ='9' type='textbox' name='echeck_aba_number' value=\"".$o->get_attrib('echeck_aba_number')."\"><img src=\"/biz/orders/images/mirc1.gif\" border=\"0\" width=\"14\" height=\"14\"></td></tr>";
	$c .= "<tr><td align='right'>Account Number:</td><td><input maxlength='20' size ='20' type='textbox' name='echeck_acct_number' value=\"".$o->get_attrib('echeck_acct_number')."\"><img src=\"/biz/orders/images/mirc2.gif\" border=\"0\" width=\"14\" height=\"14\"></td></tr>";
	if ($get_checknum) {
		$c .= "<tr><td align='right'>Check Number:</td><td><input type='textbox' name='echeck_check_number' value=\"".$o->get_attrib('echeck_check_number')."\"></td></tr>";
		}
	if ($get_business_account) {
		if ((not defined $o->get_attrib('business_account')) || ($o->get_attrib('business_account') eq '')) {
			$o->set_attrib('business_account',$o->get_attrib('billing_company')?1:0);
			}
		my $options = '<option value="0" selected>Personal</option><option value="1">Business</option>';
		if ($o->get_attrib('business_account')) {
			$options = '<option value="0">Personal</option><option value="1" selected>Business</option>';
			}
		$c .= qq~<tr><td align='right'>Account Type:</td><td><select name="business_account">$options</select></td></tr>~;
		}
	if ($get_tax_id) {
		$c .= "<tr><td align='right'>SSN / Tax ID:</td><td><input type='textbox' name='tax_id' value=\"".$o->get_attrib('tax_id')."\"></td></tr>";
		}
	if ($get_drivers_license_number) {
		$c .= "<tr><td align='right'>Driver's License Number:</td><td><input type='textbox' name='drivers_license_number' value=\"".$o->get_attrib('drivers_license_number')."\"></td></tr>";
		}
	if ($get_drivers_license_state) {
		$c .= "<tr><td align='right'>Driver's License State:</td><td><input type='textbox' name='drivers_license_state' value=\"".$o->get_attrib('drivers_license_state')."\"></td></tr>";
		}
	if ($get_drivers_license_dob) {
		$c .= "<tr><td align='right'>Driver's License DOB:</td><td><input type='textbox' name='drivers_license_dob' value=\"".$o->get_attrib('drivers_license_dob')."\"></td></tr>";
		}
	$c .= "</table>";
	if ((length($PAYMENTSTATUS) == 3) && ($PAYMENTSTATUS >= 100)) {
		$GTOOLS::TAG{"<!-- BUTTONS -->"} .= "<td><input type=\"button\" onClick=\"document.location='payment.cgi?CMD=PROCESSECHECK&ID=$ID&time=<!-- TS -->';\" value=\"Process Again\"></td>";	
		}
	}
$GTOOLS::TAG{"<!-- CONTENTS -->"} = $c;

### EVENTS
$c = '';
my ($ts,$k);
## step 1: create a hash of key=uuid value=ts
my %SORT = ();
my %EVENTS = ();
foreach my $e (@{$o->{'events'}}) {
	if (defined $e->{'contents'}) { $e->{'content'} = $e->{'contents'}; }
	$SORT{$e->{'uuid'}} = $e->{'ts'};
	$EVENTS{$e->{'uuid'}} = $e;
	}

foreach my $uuid (&ZTOOLKIT::value_sort(\%SORT,'numerically')) {
	my $e = $EVENTS{$uuid};
	my $bgcolor = 'FFFFFF';
	if ($e->{'etype'} & 32) { $bgcolor = '33FFFF'; } # marketplace
#	elsif ($e->{'etype'} & 16) { $bgcolor = 'FF33FF'; } # supply chain/shipping
	elsif ($e->{'etype'} & 8) { $bgcolor = 'FFCCCC'; } # error
#	elsif ($e->{'etype'} & 4) { $bgcolor = 'CCCCFF'; } # status
#	elsif ($e->{'etype'} & 2) { $bgcolor = 'EEEEFE'; } # payment
	elsif ($e->{'etype'} & 256) { $bgcolor = 'CCCCCC'; } # payment

	$c .= qq~
<tr bgcolor='$bgcolor'>
	<td valign=top>$e->{'luser'}</td>
	<td valign=top>~.&ZTOOLKIT::pretty_date($e->{'ts'},2).qq~</td>
	<td valign=top>$e->{'content'}</td>
</tr>~;
	}

if ($c eq '') {
	$c .= "<tr><td colspan=4><i>No events have been recorded! [This is probably an error]</i></td></tr>\n";
	}
$GTOOLS::TAG{'<!-- EVENTS -->'} = qq~
<table border=1>
<tr>
	<td>user</td>
	<td>date</td>
	<td>message</td>
</tr>
$c
</table>
~;


$GTOOLS::TAG{'<!-- PRT -->'} = $o->prt();



#### FEES
$c = '';
my $TOTAL = 0;


use Data::Dumper; print STDERR Dumper($o->fees(1));

foreach my $fee (@{$o->fees(1)}) {
	print STDERR Dumper($fee);
	$c .= "<tr><td>$fee->{'code'}</td><td>$fee->{'name'}</td><td>\$".sprintf("%.2f",$fee->{'amount'})."</td></tr>";
	$TOTAL += $fee->{'amount'};
	}

if ($c eq '') 
	{ $c .= "<tr><td><i>No fees have been recorded for this order.</i></td></tr>"; }
else 
	{ $c .= "<tr><td></td><td><b>TOTAL</b></td><td><b>\$".sprintf("%.2f",$TOTAL)."</b></td></tr>\n";  }
$GTOOLS::TAG{'<!-- FEES -->'} = $c;


&GTOOLS::output(title=>"",file=>'payment.shtml',header=>1);

&DBINFO::db_zoovy_close();

exit;

