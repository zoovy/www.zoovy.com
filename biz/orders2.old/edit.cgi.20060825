#!/usr/bin/perl

use lib "/httpd/modules";
use GT;
use EXTERNAL;
use ZOOVY;
use ZSKU;

$q = new CGI;

my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate("/biz/setup",2,'_O&4');
if ($USERNAME eq '') { exit; }


$ID = $q->param('ID');
$CMD = $q->param('CMD');
$GT::TAG{"<!-- ID -->"} = $ID;

# populates the info hash with the record we need
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};

if ($CMD eq "SAVE")
{

	$info{'CUSTOMER'} = $q->param('CUSTOMER');
	$info{'ORDER_ID'} = $q->param('ORDER_ID');
	$info{'STAGE'} = $q->param('STAGE');
	$info{'STATUS'} = $q->param('STATUS');
	my %data = ();
	&ZOOVY::attrib_handler_ref($info{'DATA'},\%data);
	$data{'zoovy:prod_name'} = $q->param('PRODUCT_NAME');
	$data{'zoovy:base_price'} = $q->param('PRODUCT_PRICE')+0;
	$data{'zoovy:taxable'} = $q->param('PRODUCT_TAXABLE');
	$data{'zoovy:quantity'} = $q->param('PRODUCT_QUANTITY')+0;
	if ($data{'zoovy:quantity'}<=0) { $data{'zoovy:quantity'} = "1"; }
	$data{'zoovy:base_weight'} = $q->param('PRODUCT_WEIGHT')+0;
	if ($data{'zoovy:base_weight'}<=0) { $data{'zoovy:base_weight'} = "0"; }

# test pogs:
#$data{$USERNAME.':pogs'} = 'Deluxe_Polo_Shirt_Color,Deluxe_Polo_Shirt_Sizes,Thread_Color';
#$data{$USERNAME.':pog_Deluxe_Polo_Shirt_Color'} = '<option value="NA1" price="" weight="">Navy_Natura</option><option value="BL0" price="" weight="">Black_Natural_Pebble</option><option value="GR0" price="" weight="">Green_Natural_Pebble</option><option value="NA0" price="" weight="">Natural_Pebble_Black</option>';
#$data{$USERNAME.':pog_Deluxe_Polo_Shirt_Sizes'} = '<option value="1" price="0" weight="0">Small</option><option value="2" price="" weight="">Medium</option><option value="4" price="" weight="">X_Large</option><option value="5" price="+3" weight="+3">2X_Large</option>';
#$data{$USERNAME.':pog_Thread_Color'} = '<option value="4" price="" weight="">Red</option><option value="B" price="" weight="">Pink</option>';

	$info{'DATA'} = &ZOOVY::attrib_to_str_ref(\%data);
	$info{'PRICE'} = $q->param('PRODUCT_PRICE');
	$info{'PRICE'} =~ s/[^0-9^\.]//g;
	$info{'PROD_NAME'} = $q->param('PRODUCT_NAME');
	$info{'PRODUCT'} = $q->param('PRODUCT');
   
#	foreach $k (keys %data) { print STDERR $k." ->".$data{$k}."\n"; }

	if (&EXTERNAL::saveexternal_full(\%info))
		{
		$GT::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} else {
		$GT::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	# reload the hash(es)
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
}



if ($CMD eq 'COPYPOG') {

	my $incvars = &ZOOVY::attrib_handler_ref($info{'DATA'});
	my $prodvars = &ZOOVY::fetchproduct_as_hash($USERNAME,$info{'PRODUCT'});
	foreach my $k (keys %{$prodvars}) {
		next unless ($k =~ /^$USERNAME\:pog/);
		$incvars->{$k} = $prodvars->{$k};
		}
	$info{'DATA'} = &ZOOVY::attrib_to_str_ref($incvars);		
	if (&EXTERNAL::saveexternal_full(\%info))
		{
		$GT::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} else {
		$GT::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
	}



if ($CMD eq "RAWSAVE")
{

	$vars = &ZOOVY::attrib_handler_ref($info{'DATA'});

	foreach $k ($q->param()) {
		next unless ($k =~ /^\$\$/);
		$vars->{substr($k,2)} = $q->param($k);
		}

	$info{'DATA'} = &ZOOVY::attrib_to_str_ref($vars);

	if (&EXTERNAL::saveexternal_full(\%info))
		{
		$GT::TAG{"<!-- MESSAGE -->"} = "Saved Changes!<br>";
		} else {
		$GT::TAG{"<!-- MESSAGE -->"} = "Changes could not be saved!<br>";
		}
	# reload the hash(es)
	my %info = %{&EXTERNAL::fetchexternal_full($USERNAME,$ID)};
	$CMD = "";
}




if ($CMD eq 'RAWEDIT') {
	use Data::Dumper;
	$vars = &ZOOVY::attrib_handler_ref($info{'DATA'});
	$c = '';
	foreach $k (sort keys %{$vars}) {
		$c .= "<tr><td>$k:<br><input type=\"textbox\" name=\"\$\$$k\" value=\"".&ZOOVY::incode($vars->{$k})."\">\n</td></tr>\n";
		}
	$GT::TAG{'<!-- KEYS -->'} = $c;
	$GT::TAG{'<!-- OUTPUT -->'} = "<pre>".Dumper($vars)."</pre>";

	$template_file = 'rawedit.shtml';
	}


if ($CMD eq "DELETE-CONFIRM")
{
	$ID = $q->param('ID');
	&EXTERNAL::nuke_external_item($USERNAME,$ID);
	print "Location: main.cgi\n\n";
}

if ($CMD eq "DELETE")
{
   $GT::TAG{"<!-- ID -->"} = $info{'ID'};
	$GT::TAG{"<!-- MESSAGE -->"} = "<font face='verdana, arial, helvetica'><font color='red'>Warning: You are about to delete an External Sale from the system.</font><br>";
	$GT::TAG{"<!-- MESSAGE -->"} .= "<br><br>This will completely remove this item from the system.<br>";
	$GT::TAG{"<!-- MESSAGE -->"} .= "If you want to prevent a person from purchasing this item, simply ";
	$GT::TAG{"<!-- MESSAGE -->"} .= "set the item's stage to REVOKED. <br>Proceeding item will result in all tracking ";
	$GT::TAG{"<!-- MESSAGE -->"} .= "information being lost.<br><br></font>";


	$GT::TAG{"<!-- CMD -->"} = "DELETE-CONFIRM";
	$GT::TAG{"<!-- CANCEL -->"} = "edit.cgi?ID=".$info{'ID'};
	$template_file = "edit-confirm.shtml";
}




if ($CMD eq "" || $CMD eq "EDIT")
{
if (!defined(%info))
	{
 	# Eerror 
	} else {

	my %data = ();
	&ZOOVY::attrib_handler_ref($info{'DATA'},\%data);

	$GT::TAG{"<!-- ID -->"} = &ZOOVY::incode($info{'ID'});
	$GT::TAG{"<!-- CHANNEL -->"} = &ZOOVY::incode($info{'CHANNEL'});
	$GT::TAG{"<!-- PORTAL -->"} = &ZOOVY::incode($info{'PORTAL'});
	$GT::TAG{"<!-- PRODUCT -->"} = &ZOOVY::incode($info{'PRODUCT'});
	$GT::TAG{"<!-- ORDER_ID -->"} = &ZOOVY::incode($info{'ORDER_ID'});
	$GT::TAG{"<!-- CREATED -->"} = &ZOOVY::incode($info{'CREATED'});
	$GT::TAG{"<!-- CUSTOMER -->"} = &ZOOVY::incode($info{'CUSTOMER'});
	$GT::TAG{"<!-- CLAIM_URL -->"} = &EXTERNAL::create_claim_url($USERNAME,$info{'ID'});

## LASTCONTACT
	if ($info{'LASTCONTACT'}) { $GT::TAG{"<!-- LASTCONTACT -->"} = &ZOOVY::incode($info{'EXPIRES'}); } else { $GT::TAG{"<!-- LASTCONTACT -->"} = "Never"; }

## STAGE
	$c = "";
	# if its active then add that to the list.
	if ($info{'STAGE'} eq "A") { $c = "<option SELECTED value='A'>Active (*)</option>"; } else { $c = "<option value='A'>Active</option>"; }
	# if the STAGE is either Informed or Visited then emulate Active
	if ($info{'STAGE'} eq "I") { $c = "<option SELECTED value='I'>Active - Informed (*)</option>"; }
	if ($info{'STAGE'} eq "V") { $c = "<option SELECTED value='V'>Active - Visited (*)</option>"; }
	
	# always add Hold to the list (COMPLETED will remove On Hold)
	if ($info{'STAGE'} eq "H") { $c .= "<option SELECTED value='H'>On Hold (*)</option>"; } else { $c .= "<option value='H'>On Hold</option>"; }
	if ($info{'STAGE'} eq "P") { $c .= "<option SELECTED value='P'>Waiting for Server (*)</option>"; } else { $c .= "<option value='P'>Waiting for Server</option>"; }

	# if we are completed then that should REALLY be the only option
	if ($info{'STAGE'} eq "C") { $c = "<option SELECTED value='C'>Completed (*)</option>"; }
	# if the stage is not set then lets assume its an error??
	if ($info{'STAGE'} ne "A" &&
 		$info{'STAGE'} ne "I" &&
 		$info{'STAGE'} ne "V" &&
 		$info{'STAGE'} ne "H" &&
 		$info{'STAGE'} ne "P" &&
 		$info{'STAGE'} ne "C") { $c .= "<option value='E'>Error (*)</option>"; } 
	$GT::TAG{"<!-- STAGE -->"} = $c;

## STATUS
	$c = "";
	if ($info{'STATUS'} eq "G") { $c .= "<option SELECTED value='G'>Good (*)</option>"; } else { $c .= "<option value='G'>Good</option>"; }
	if ($info{'STATUS'} eq "N") { $c .= "<option SELECTED value='N'>Neutral (*)</option>"; } else { $c .= "<option value='N'>Neutral</option>"; }
	if ($info{'STATUS'} eq "B") { $c .= "<option SELECTED value='B'>Bad (*)</option>"; } else { $c .= "<option value='B'>Bad</option>"; }
	if ($info{'STATUS'} ne "G" &&
		 $info{'STATUS'} ne "N" &&
		 $info{'STATUS'} ne "B") { $c .= "<option SELECTED value='U'>Unknown (*)</option>"; } else { $c .= "<option value='U'>Unknown</option>"; }
	$GT::TAG{"<!-- STATUS -->"} = $c;


	$GT::TAG{"<!-- PRODUCT_NAME -->"} = &ZOOVY::incode($data{'zoovy:prod_name'});
	$GT::TAG{"<!-- PRODUCT_PRICE -->"} = &ZOOVY::incode($data{'zoovy:base_price'});

## TAXABLE
	if ($data{'zoovy:taxable'} eq "1" ||
		uc($data{'zoovy:taxable'}) eq "Y") { $c = "<option value='Y' SELECTED>Yes (*)</option><option value='N'>No</option>"; }
	else { $c = "<option value='Y'>Yes</option><option SELECTED value='N'>(*) No</option>"; }
	$GT::TAG{"<!-- PRODUCT_TAXABLE -->"} = $c;

	$GT::TAG{"<!-- PRODUCT_IMAGE1 -->"} = &ZOOVY::incode($data{'zoovy:prod_image1'});
	$GT::TAG{"<!-- PRODUCT_WEIGHT -->"} = &ZOOVY::incode($data{'zoovy:base_weight'});
	$GT::TAG{"<!-- PRODUCT_QUANTITY -->"} = &ZOOVY::incode($data{'zoovy:quantity'});
	$GT::TAG{'<!-- SEARCH -->'} = $data{'zoovy:search'};

	if ($data{$USERNAME.":pogs"})
		{
		$c = "<font face='verdana, arial'>The following Product Options will be presented:</font><br>";
		@pogs = split(',',$data{$USERNAME.":pogs"});
	
		$c .= "<table>";
		foreach $pog (@pogs)
			{
			$pogpretty = $pog;
			$pogpretty =~ s/_/ /g;
			$c .= "<tr><td class='A'>$pogpretty:</td>";
			$c .= "<td class='A'><select>".ZSKU::pog_to_html($data{$USERNAME.":pog_".lc($pog)})."</select></td></tr>";
			}
		$c .= "</table>";
		$GT::TAG{"<!-- POG_DISPLAY -->"} = $c;	
		}
	$template_file = "edit.shtml";
	}
}

print $q->header();
&GT::print_form("",$template_file);
