#!/usr/bin/perl

use lib "/httpd/modules";
use CGI;
use GTOOLS;
require ZOOVY;
require DBINFO;
require ORDER;
require CUSTOMER;
require INVENTORY;
require ZTOOLKIT;
#require CART::VIEW;
require SITE::URLS;
require CART2;
require CART2::VIEW;
require ZWEBSITE;
require TOXML;
use strict;

&DBINFO::db_zoovy_connect();

&ZOOVY::init();

my @MSGS = ();

require LUSER;
my ($LU) = LUSER->authenticate(flags=>'_O&2');
if (not defined $LU) { exit; }

my ($MID,$USERNAME,$LUSERNAME,$FLAGS,$PRT) = $LU->authinfo();
if ($MID<=0) { exit; }

my $CMD = uc($ZOOVY::cgiv->{"CMD"});
my $ID = $ZOOVY::cgiv->{'ID'};
if ($ID eq '') { $ID = $ZOOVY::cgiv->{'order'}; }
if ($ID eq '') { $ID = $ZOOVY::cgiv->{'orderid'}; }
if ($ID eq '') { $ID = $ZOOVY::cgiv->{'ORDERID'}; }

$GTOOLS::TAG{"<!-- ID -->"} = $ID;
(my $o, my $error) = ORDER->new($USERNAME, $ID);


my $webdb = &ZWEBSITE::fetch_website_dbref($USERNAME,$o->prt());
my ($prtinfo) = &ZWEBSITE::prtinfo($USERNAME,$o->prt());
my $NS = $prtinfo->{'profile'};

# print STDERR "NS: $NS PRT: ".($o->prt())."\n";

my $merchantref = &ZOOVY::fetchmerchantns_ref($USERNAME,$NS);

my ($t) = TOXML->new('WRAPPER','default');
$t->initConfig();
my $TH = $SITE::CONFIG->{'%THEME'};
$SITE::URL = SITE::URLS->new($USERNAME,secure=>1);

#

##
## passed: cgi parameter ID=200x-0x-xxxxxx
##

my $a = "";   # this is used throughout the program as scratch
my $ts = time();
my $template_file = '';

my $cname = &ZTOOLKIT::htmlstrip($merchantref->{"zoovy:company_name"});
if (length($cname)<1) { $cname = $USERNAME; }
$GTOOLS::TAG{"<!-- COMPANY_NAME -->"} = $cname;

if ($ID eq '') { 
	print "Content-type: text/plain\n\n";
	print "<html><b>This form requires an ORDER ID be passed to it!</b></html>";
	exit;
	}
my $CUSTOMER = undef;

if ($FLAGS =~ /,CRM,/) {
	require CUSTOMER;
	($CUSTOMER) = CUSTOMER->new($USERNAME,PRT=>$o->prt(),EMAIL=>$o->get_attrib('bill_email'),INIT=>33);
	if ($CUSTOMER->{'_CID'} == -1) { $CUSTOMER = undef; }
	if ($CUSTOMER->{'_CID'} == 0) { $CUSTOMER = undef; }
	}


my $status = $o->get_attrib('pool');
my $created = $o->get_attrib('created');

if (($CMD eq 'SAVENOTE') && (defined $CUSTOMER)) {
	$CMD = '';
	if ($ZOOVY::cgiv->{'NOTE'} ne '') {
		$CUSTOMER->save_note($LUSERNAME,$ZOOVY::cgiv->{'NOTE'});
		}
	}

$GTOOLS::TAG{'<!-- CREATED -->'} = &ZTOOLKIT::pretty_date($created);
if (!defined($status)) { $status = 'RECENT'; }
$GTOOLS::TAG{'<!-- RETURN -->'} = lc($status).'.shtml';
if (defined $ZOOVY::cgiv->{'EXIT'}) {
	$GTOOLS::TAG{'<!-- RETURN -->'} = $ZOOVY::cgiv->{'EXIT'};
	}
elsif ($ENV{'REQUEST_URI'} =~ /popup/) {
	$GTOOLS::TAG{'<!-- RETURN -->'} = "javascript:window.close();";
	}

	my $ORDERREF = $o->get_attribs();
	if ($ORDERREF->{'cancelled'}>0) {
		$GTOOLS::TAG{'<!-- PAID -->'} = '<font color="red">** CANCELLED **</font>';		
		}
	elsif ($ORDERREF->{'payment_status'} =~ /^0/) {
		$GTOOLS::TAG{'<!-- PAID -->'} = "<br>PAID: ".&ZTOOLKIT::pretty_date($ORDERREF->{'paid_date'});	
		$GTOOLS::TAG{'<!-- PAYMENT_METHOD -->'} = $ORDERREF->{'payment_method'};
		}
	elsif (($ORDERREF->{'payment_status'} =~ /^4/) && ($ORDERREF->{'payment_status'} ne '499')) {
		$GTOOLS::TAG{'<!-- PAID -->'} = "<br>REVIEW: ".&ZTOOLKIT::pretty_date($ORDERREF->{'paid_date'});	
		$GTOOLS::TAG{'<!-- PAYMENT_METHOD -->'} = $ORDERREF->{'payment_method'};
		}
	else {
		$GTOOLS::TAG{'<!-- PAID -->'} = '<font color="red">** UNPAID **</font>';
		}



	if ($ORDERREF->{'ship_country'} eq 'United States') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'ship_country'} eq 'USA') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'ship_country'} eq 'US') { $ORDERREF->{'ship_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'United States') { $ORDERREF->{'bill_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'USA') { $ORDERREF->{'bill_country'} = ''; }
	if ($ORDERREF->{'bill_country'} eq 'US') { $ORDERREF->{'bill_country'} = ''; }

	# $GTOOLS::TAG{"<!-- SHIP_NAME -->"} = ($ORDERREF->{"ship_fullname"})?($ORDERREF->{"ship_fullname"}):($ORDERREF->{"ship_firstname"}." ".$ORDERREF->{"ship_lastname"});
	$GTOOLS::TAG{"<!-- SHIP_NAME -->"} = 
		$ORDERREF->{"ship_firstname"}." ".
		($ORDERREF->{"ship_middlename"}?$ORDERREF->{"ship_middlename"}.' ':'').
		$ORDERREF->{"ship_lastname"};	
   $GTOOLS::TAG{"<!-- SHIP_COMPANY -->"} = ($ORDERREF->{"ship_company"})?($ORDERREF->{"ship_company"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_ADDRESS1 -->"} = ($ORDERREF->{"ship_address1"})?($ORDERREF->{"ship_address1"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_ADDRESS2 -->"} = ($ORDERREF->{"ship_address2"})?($ORDERREF->{"ship_address2"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_CITY -->"} = ($ORDERREF->{"ship_city"})?($ORDERREF->{"ship_city"}.", "):"";
   
   if ($ORDERREF->{"ship_country"} eq '') { 
		$GTOOLS::TAG{"<!-- SHIP_STATE -->"} = ($ORDERREF->{"ship_state"})?($ORDERREF->{"ship_state"}." "):"";
		$GTOOLS::TAG{"<!-- SHIP_ZIP -->"} = ($ORDERREF->{"ship_zip"})?($ORDERREF->{"ship_zip"}." "):""; 
		}
	else {
		$GTOOLS::TAG{"<!-- SHIP_STATE -->"} = ""; 
		$GTOOLS::TAG{'<!-- SHIP_ZIP -->'} = $ORDERREF->{'ship_province'}.', '.$ORDERREF->{"ship_int_zip"}.'<br>'.$ORDERREF->{'ship_country'}; 
		}

   $GTOOLS::TAG{"<!-- SHIP_PHONE -->"} = ($ORDERREF->{"ship_phone"})?($ORDERREF->{"ship_phone"}."<br>"):"";
   $GTOOLS::TAG{"<!-- SHIP_EMAIL -->"} = ($ORDERREF->{"ship_email"});	

	# $GTOOLS::TAG{"<!-- BILL_NAME -->"} = ($ORDERREF->{"bill_fullname"})?($ORDERREF->{"bill_fullname"}):($ORDERREF->{"bill_firstname"}." ".$ORDERREF->{"bill_lastname"});
	$GTOOLS::TAG{"<!-- BILL_NAME -->"} = 
		$ORDERREF->{"bill_firstname"}." ".
		($ORDERREF->{"bill_middlename"}?$ORDERREF->{"bill_middlename"}.' ':'').
		$ORDERREF->{"bill_lastname"};	
   $GTOOLS::TAG{"<!-- BILL_COMPANY -->"} = ($ORDERREF->{"bill_company"})?($ORDERREF->{"bill_company"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_ADDRESS1 -->"} = ($ORDERREF->{"bill_address1"})?($ORDERREF->{"bill_address1"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_ADDRESS2 -->"} = ($ORDERREF->{"bill_address2"})?($ORDERREF->{"bill_address2"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_CITY -->"} = ($ORDERREF->{"bill_city"})?($ORDERREF->{"bill_city"}.", "):"";
   

   if ($ORDERREF->{"bill_country"} eq '')	{ 
		$GTOOLS::TAG{"<!-- BILL_STATE -->"} = ($ORDERREF->{"bill_state"})?($ORDERREF->{"bill_state"}." "):"";
		$GTOOLS::TAG{"<!-- BILL_ZIP -->"} = ($ORDERREF->{"bill_zip"})?($ORDERREF->{"bill_zip"}." "):""; 
		}
	else {
		$GTOOLS::TAG{"<!-- BILL_STATE -->"} = ""; 
		$GTOOLS::TAG{'<!-- BILL_ZIP -->'} = $ORDERREF->{'bill_province'}.', '.$ORDERREF->{"bill_int_zip"}.'<br>'.$ORDERREF->{'bill_country'}; 
		}

   $GTOOLS::TAG{"<!-- BILL_PHONE -->"} = ($ORDERREF->{"bill_phone"})?($ORDERREF->{"bill_phone"}."<br>"):"";
   $GTOOLS::TAG{"<!-- BILL_EMAIL -->"} = ($ORDERREF->{"bill_email"});	

	my $CID = 0;
	if ($ORDERREF->{'customer_id'}) {
		$CID = $ORDERREF->{'customer_id'};
		}
	else {
		($CID) = &CUSTOMER::customer_exists($USERNAME,$ORDERREF->{'bill_email'},$o->prt());
		}

	if ($ORDERREF->{'bill_email'} eq '') {
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = '';
		}
	elsif ($CID == 0) {
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = '';
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = "<a href=\"javascript:openWindowNR('/biz/manage/customer/index.cgi?VERB=CREATE&EMAIL=$ORDERREF->{'bill_email'}&ORDER=".$o->id()."&PRT=".$o->prt()."\');\">Create Customer Account</a>";		
		}
	elsif ($CID != $ORDERREF->{'customer_id'}) {		
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = "<a href=\"javascript:openWindowNR('/biz/manage/customer/index.cgi?VERB=SEARCH-NOW&scope=CID&searchfor=$CID&link=".$o->id()."\');\">Link Customer Account</a>";		
		}
	elsif ($CID) {
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = "<a href=\"javascript:openWindowNR('/biz/manage/customer/index.cgi?VERB=SEARCH-NOW&scope=CID&searchfor=$CID\');\">Edit Customer Account</a>";
		}
	else {
		require ZTOOLKIT;
		my $params = &ZTOOLKIT::buildparams(
			{'VERB'=>'CREATE',
			'EMAIL'=>$ORDERREF->{"bill_email"},
			'FIRST'=>$ORDERREF->{"bill_firstname"},
			'LAST'=>$ORDERREF->{"bill_lastname"},
			'ORDER'=>$ID,
			});
		$GTOOLS::TAG{'<!-- CUSTOMER_EDIT -->'} = "<a href=\"javascript:openWindowNR('/biz/manage/customer/index.cgi?$params\');\">Create New Customer Account</a>";
		}

	if ($ORDERREF->{'payment_method'} eq 'PAYPAL') {
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} = qq~
		<tr><td><br>Paypal Account: $ORDERREF->{'paypal_acct'} &nbsp; &nbsp; Transaction Id: $ORDERREF->{'payment_authorization'}</td></tr>
		~;
		}
	elsif ($ORDERREF->{'payment_method'} eq 'GOOGLE') {
		my ($payrec) = @{$o->payments('tender'=>'GOOGLE')}; 
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} = qq~<tr><td><br>Google Order #: $payrec->{'txn'}</td></tr>~;
		}	
	if ($ORDERREF->{'schedule'} ne '') {
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} .= qq~<tr><td>Schedule: $ORDERREF->{'schedule'}</td></tr>~;
		}
	if ($ORDERREF->{'sc_orderinfo'} ne '') {
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} .= qq~<tr><td>Supply Chain Order: $ORDERREF->{'sc_orderinfo'}</td></tr>~;
		}
	if ($ORDERREF->{'cancelled'}>0) {
		$GTOOLS::TAG{'<!-- PAYMENTINFO -->'} .= qq~<tr><td colspan=2><font color='red'>Order was cancelled on: ~.&ZTOOLKIT::pretty_date($ORDERREF->{'cancelled'},1).qq~</td></tr>~;
		}


	$GTOOLS::TAG{'<!-- NOTES --'} = '';
	if ($ORDERREF->{'erefid'} ne '') {
		$GTOOLS::TAG{'<!-- NOTES -->'} .= sprintf("<td><td><div class=\"hint\">External Reference: %s</div></td></tr>",$ORDERREF->{'erefid'});
		}
	if ($ORDERREF->{'po_number'} ne '') {
		$GTOOLS::TAG{'<!-- NOTES -->'} .= sprintf("<tr><td><div class\"hint\">Purchase Order #: %s</div></td></tr>",$ORDERREF->{'po_number'});
		}

	my $order_notes = '';	
	if ($ORDERREF->{'order_notes'} ne '') {
		$order_notes = &ZOOVY::incode($ORDERREF->{'order_notes'});
		$order_notes =~ s/\n/<br>/g;
		$GTOOLS::TAG{'<!-- NOTES -->'} .= "<tr><td><div class=\"hint\"><b>Order Notes:</b> ".$order_notes."</div></td></tr>\n";
		
		}

	if ($ORDERREF->{'private_notes'} ne '') {
		## NOTE: these are not *EVER* printable
		my $private_notes = &ZOOVY::incode($ORDERREF->{'private_notes'});
		$private_notes =~ s/\n/<br>/g;
		$GTOOLS::TAG{'<!-- NOTES -->'} .= "<tr><td><div class=\"hint\"><b>Private Notes:</b><br>".$private_notes."</div></td></tr>\n";
		}


if ($CMD eq "INVOICE" || $CMD eq 'PACKSLIP') {
	require ZWEBSITE;
	require IMGLIB::Lite;
	my $out;

	require ZWEBSITE;
	if ($order_notes ne '') {
		$GTOOLS::TAG{'<!-- ORDERNOTES -->'} = "<center><table width='95%'><tr><Td><b>Order Notes:</b> $order_notes</td></tr></table></center>"; 
		}

	my $logo = $merchantref->{'zoovy:logo_invoice'};
	if ($logo eq '') { 
		## LEGACY
		$logo = $merchantref->{'zoovy:invoice_logo'};
		}
	my ($width,$height) = split(/x/,$merchantref->{'zoovy:logo_invoice_xy'});
	if ($width<=0) { $width = 300; }
	if ($height<=0) { $height = 100; }

	$GTOOLS::TAG{"<!-- COMPANY_LOGO -->"} = &IMGLIB::Lite::url_to_image($USERNAME,$logo,$width,$height,'ffffff');
	$GTOOLS::TAG{'<!-- WIDTH -->'} = $width;
	$GTOOLS::TAG{'<!-- HEIGHT -->'} = $height;

	# my $MERCHREF = &ZOOVY::attrib_handler_ref(&ZOOVY::fetchmerchant($USERNAME));	
	$GTOOLS::TAG{"<!-- COMPANY_ADDRESS1 -->"} = ($merchantref->{"zoovy:address1"})?($merchantref->{"zoovy:address1"}."<br>"):"";
	$GTOOLS::TAG{"<!-- COMPANY_ADDRESS2 -->"} = ($merchantref->{"zoovy:address2"})?($merchantref->{"zoovy:address2"}."<br>"):"";
	$GTOOLS::TAG{"<!-- COMPANY_CITY -->"} = ($merchantref->{"zoovy:city"})?($merchantref->{"zoovy:city"}.", "):"";
	$GTOOLS::TAG{"<!-- COMPANY_STATE -->"} = ($merchantref->{"zoovy:state"})?($merchantref->{"zoovy:state"}." "):"";
	$GTOOLS::TAG{"<!-- COMPANY_ZIP -->"} = ($merchantref->{"zoovy:zip"})?($merchantref->{"zoovy:zip"}." "):"";
	$GTOOLS::TAG{"<!-- COMPANY_SUPPORT_PHONE -->"} = ($merchantref->{"zoovy:support_phone"});
	$GTOOLS::TAG{"<!-- COMPANY_SUPPORT_EMAIL -->"} = ($merchantref->{"zoovy:support_email"});	
	$GTOOLS::TAG{"<!-- COMPANY_URL -->"} = ($merchantref->{"zoovy:website_url"});

	my $TAXRATE = $ORDERREF->{"tax_rate"};
	my $SHIPPING = $ORDERREF->{"shp_total"};
	
	if ($CMD eq 'PACKSLIP') {
		$out = &build_packslip($USERNAME,$o);
		$template_file = 'packslip.shtml';
		}
	elsif ($CMD eq 'INVOICE') {		
		($out) = &CART2::VIEW::as_html(CART2->new_from_order($o),'PRINT_INVOICE',$webdb);
		$template_file = "invoice.shtml";
		}

	if (length($out)<1) { $out .= "<br><font color='red'>No contents found! [CMD:$CMD]</font>"; }
	if ($ORDERREF->{'meta'} ne '') { $out .= "<br>META: $ORDERREF->{'meta'}<br>\n"; }

	$GTOOLS::TAG{"<!-- DISPLAY_CONTENTS -->"} = "$out";
	} 


## NUKE ORDER
if ($CMD eq 'DELETE-CONFIRMED') {
   $ID = $ZOOVY::cgiv->{'ID'};
   print STDERR "Deleting ID: $USERNAME $ID\n";
	$LU->log("ORDER.DELETE","Removed order $ID","WARN");

 	my ($FAILED) = &ORDER::nuke_order($USERNAME,$ID);
	if ($FAILED) {
		push @MSGS, "ERROR|Sorry, cannot remove order.";
		$CMD = '';
		}
	else {
		print "Location: /biz/orders/recent.shtml?_NUKE_FAILED=$FAILED\n\n";
		exit;
		}	
	}

if ($CMD eq "DELETE") {
	$template_file = "delete-confirm.shtml";
	my $TAXRATE = $ORDERREF->{"tax_rate"};
	my $SHIPMETHOD = $ORDERREF->{"shp_method"};
	my $SHIPPING = $ORDERREF->{"shp_total"};
	if ($o->lock()) {
		push @MSGS, "WARN|This order cannot be removed because it has been synced to one or more external systems and/or is locked.";
		}
	($a) = &CART2::VIEW::as_html(CART2->new_from_order($o),'INVOICE',$webdb);
	if (length($a)<1) { $a .= "No contents found!"; }
	$GTOOLS::TAG{"<!-- DISPLAY_CONTENTS -->"} = "$a";
	}

# DEFAULT CMD displays the edit.shtml
if (!$CMD) { 
	($a) = &CART2::VIEW::as_html(CART2->new_from_order($o),'INVOICE',$webdb);
	&build_buttons('VIEW',$USERNAME,$o);

   if (length($a)<1) { $a .= "No contents found! [CMD:$CMD]"; }
	if ($ORDERREF->{'meta'} ne '') { $a = "META: $ORDERREF->{'meta'}<br>\n$a"; }
	if ($ORDERREF->{'sdomain'} ne '') { $a = "CHECKOUT DOMAIN: $ORDERREF->{'sdomain'}<br>\n$a"; }

   $GTOOLS::TAG{"<!-- DISPLAY_CONTENTS -->"} = "$a";
   $template_file = "view.shtml";

	if (defined $CUSTOMER) {
		my $NOTES = '';
		
		foreach my $note (@{$CUSTOMER->fetch_notes()}) {
			$NOTES .= "<tr><td valign='top' nowrap>".&ZTOOLKIT::pretty_date($note->{'CREATED_GMT'},-1)." $note->{'LUSER'}</td><td valign='top'>&nbsp; - &nbsp; </td><td valign='top'>$note->{'NOTE'}</td></tr>";
			}

		$GTOOLS::TAG{'<!-- CRMNOTES -->'} = qq~
		<table bgcolor="#000000" cellspacing=1 cellpadding=3 width="100%">
		<tr>
			<td bgcolor='FFFFFF'>
				<b>Customer Notes</b> 
				<i>(Reminder: customer notes are shared across all orders - they are never displayed to the customer.)</i><br>
			<table cellpadding='0' cellspacing='0'>
				$NOTES
			</table>
			<table cellpadding='0' cellspacing='0'><tr><td nowrap>
				Add Note: <input maxlength="80" type="textbox" size="80" name="NOTE"> <input onClick="document.thisFrm.CMD.value='SAVENOTE'; document.thisFrm.submit();" class="button" type="button" value=" Add ">	
			</td></tr></table>
			</td>
		</tr>
		</table>
		~;	
		}
	}


$GTOOLS::TAG{'<!-- MSGS -->'} = &GTOOLS::show_msgs(\@MSGS);
&GTOOLS::output(file=>$template_file,header=>1,jquery=>1);

&DBINFO::db_zoovy_close();

exit;

sub build_payment_status {
	my ($ORDERREF) = @_;
	
	my $c = "";
	my $ps = substr($ORDERREF->{"payment_status"},0,1);
	if ($ps eq "0") { $c .= "PAYMENT_STATUS: paid in full<br>"; }
	elsif ($ps eq "1") { $c .= "PAYMENT_STATUS: pending<br>"; }
	elsif ($ps eq "2") { $c .= "PAYMENT_STATUS: denied<br>"; }
	elsif ($ps eq "3") { $c .= "PAYMENT_STATUS: order cancelled<br>"; }
	elsif ($ps eq "4") { $c .= "PAYMENT_STATUS: review requested<br>"; }
	$c .= "PAYMENT METHOD: ".$ORDERREF->{"payment_method"}."<br>";
  
	if ($ORDERREF->{"payment_method"} eq "CREDIT") {
     # $ORDERREF->{"payment_cc_status"}
     # -1 unavailable, 0 success, 1 declined, 2 pending - voice authorization, 3 bad data
     # 4 disallowed - invalid card type? not supported, 5 unrecognized - processor bank didn't recognize merchant_info
     # 6 critical - internal inconsistency, 7 unknown - catch all
     $c .= "PAYMENT_CC_STATUS: ".$ORDERREF->{"payment_cc_status"}."<br>";

     # Ignore this, its not really used.   
     # $ORDERREF->{"payment_cc_types"}
     # AMEX, VISA, MC, NOVUS
     # $c .= "PAYMENT_CC_TYPES: ".$ORDERREF->{"payment_cc_types"}."<br>";
     
     # $ORDERREF->{"payment_cc_results"}
     $c .= "PAYMENT_CC_RESULTS: ".$ORDERREF->{"payment_cc_results"}."<br>";

     # $ORDERREF->{"payment_cc_processor"}
     $c .= "PAYMENT_CC_PROCESSOR: ".$ORDERREF->{"payment_cc_processor"}."<br>";
     }

  return ($c);  
}



##
## MODE: - "VIEW" the primary invoice view
##
sub build_buttons {
	my ($MODE,$USERNAME, $o) = @_;

	# print out the print invoice
	my $ts = time();
	my $ID = $ZOOVY::cgiv->{'ID'};

	my $NS = $o->get_attrib('profile');
	if ($NS eq '') { $NS = 'DEFAULT'; }

	$GTOOLS::TAG{'<!-- CORESTR -->'} = qq~
		<table border='0' cellpadding='0' cellspacing='0'>
			<tr>
			<td><input type='button' class="button" onClick="document.location='track.cgi?ID=$ID&ts=$ts';" value=" Tracking Info "></td>
			<td><input type='button' class="button" onClick="document.location='payment.cgi?ID=$ID&ts=$ts';" value=" Payment Status "></td>
			<td><input type='button' class="button" onClick="return(prWindow('view.cgi?CMD=INVOICE&ID=$ID&ts=$ts'));" value=" Print Invoice "></td>
			<td><input type='button' class="button" onClick="return(prWindow('view.cgi?CMD=PACKSLIP&ID=$ID&ts=$ts'));" value=" Packing Slip "></td>
			<td><input type='button' class="button" onClick='return(openWindow("notes.cgi?ID=$ID&ts=$ts"));' value=" Edit Order Notes "></td>
			</tr>
		</table>
	~;


	my $zom_warning = '';
	if ($o->lock() eq 'ZOM') {
		$zom_warning = '<tr><td><font color="red">This order has already been transmitted to order manager, please do not make edits online.</font></td></tr>';
		}

	my $email = $o->get_attrib('bill_email');
	my $phone = $o->get_attrib('bill_phone');

	my $DELETE_ORDER_BUTTON = '';
	if ($o->get_attrib('pool') eq 'DELETED') {
		$DELETE_ORDER_BUTTON = qq~<input type='button' class="button" onClick=\"document.location='view.cgi?CMD=DELETE&ID=$ID&ts=$ts';\" value=\"  Delete Order \">~;
		}


	my ($tickets) = $o->tickets();
	if (scalar(@{$tickets})>0) {
		my $c = '';
		$c .= qq~<table class="zoovytable" width="100%">~;
		$c .= qq~
<tr class="zoovytableheader">
	<td colspan=4>Open Tickets</td>
</tr>
<tr class="zoovysub1header">
	<td>Ticket</td>
	<td>Status</td>
	<td>Opened</td>
	<td>Closed</td>
</tr>
~;
		foreach my $ticketref (@{$tickets}) {
			$c .= "<tr>";
			$c .= sprintf("<td><a href=\"/biz/crm/index.cgi?VERB=EXEC-SEARCH&ticket=%s\">%s</a></td>",$ticketref->{'TKTCODE'},$ticketref->{'TKTCODE'});
			$c .= sprintf("<td>%s</td>",$ticketref->{'STATUS'});
			$c .= sprintf("<td>%s</td>",&ZTOOLKIT::pretty_date($ticketref->{'CREATED_GMT'},1));
			if ($ticketref->{'CLOSED_GMT'}==0) {
				$c .= "<td>OPEN</td>";
				}
			else {
				$c .= sprintf("<td>%s</td>",&ZTOOLKIT::pretty_date($ticketref->{'CLOSED_GMT'},1));
				}
			$c .= "</tr>";
			}
		$c .= qq~</table>~;
		$GTOOLS::TAG{'<!-- TICKETS -->'} = $c;
		}

	$GTOOLS::TAG{'<!-- OPTIONSTR -->'} = qq~
		<table border='0' cellpadding='0' cellspacing='0'>
			$zom_warning
			<tr>
				<td>
				<input type='button' class="button"  onClick=\"document.location='edit.cgi?CMD=EDIT&ID=$ID&ts=$ts';\" value=\"  Edit Contents \">
				$DELETE_ORDER_BUTTON
				<input type='button' class="button"  onClick=\"document.location='email.cgi?CMD=REVIEW&order-$ID=on';\" value=\"  Send Email \">
				<input type='button' class="button"  onClick=\"parent.document.location='/biz/crm/index.cgi?VERB=CREATE&orderid=$ID&email=$email&phone=$phone';\" value=\"  Ticket \">
				</td>
			</tr>
		</table>
	~;

	}



##
##
## parameters: MODE, USERNAME, ID, TAXRATE, SHIPPRICE, SHIPMETHOD
##   MODE is what type of invoice to print currently only "NORM" is supported
##   ID is the order ID
##   TAXRATE is the tax rate for the other (if applicable) in non-decimal format (10 = %10 tax rate)
##   SHIPPRICE is the price of shipping
##   SHIPMETHOD is the text of the method we are shipping
##
sub build_packslip {
	my ($USERNAME,$o) = @_;

	my $out = "";

	my $SHIPMETHOD = $o->get_attrib('shp_method');
	my $stuff = $o->stuff();

	my $BGCOLOR = '3366CC';
	$out .= "<table cellspacing='0' cellpadding='5' width='100%'><tr>";
	$out .= "<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: FFFFFF'><b>LOCATION</b></font></td>";
	$out .= "<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: FFFFFF'><b>SKU</b></font></td>";
	$out .= "<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: FFFFFF'><b>PRODUCT</b></font></td>";
	$out .= "<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: FFFFFF'><b><center>&nbsp;&nbsp;QTY&nbsp;&nbsp;</center></b></font></td>";
	$out .= "</tr>";


#	my ($qtyref,$resref,$locref) = (undef,undef,undef);
#	my @prods = ();
#	foreach my $p (keys %hash) {
#		if (index($p,'*')>=0) { $p = substr($p,index($p,'*')+1); }
#		push @prods, $p;
#		}

	
	my @stids = $stuff->stids();
	## take out claim number to get correct inv, loc
	foreach my $stid (@stids) {
		if (index($stid,'*')>=0) { $stid = substr($stid,index($stid,'*')+1); }
		}		
	my ($qtyref,$resref,$locref) = &INVENTORY::fetch_qty($USERNAME,\@stids,undef);

	my $counter = 0;
	my ($footer,$x) = ('','');
	foreach my $stid ($stuff->stids()) {
		my $item = $stuff->item($stid);
		next if ($item->{'qty'}==0);
		
		my $SKU = $item->{'sku'};
		if ($SKU =~ /^(.*?)\//) { $SKU = $1; }	# strip off non-inventoriable options
		
		if ($counter++ % 2) { $BGCOLOR="FFFFFF"; } else { $BGCOLOR='E0E0E0'; }
		# my ($price,$qty,$weight,$tax,$description) = split(',',$hash{$key},5); 
		
		my $extended = sprintf("\$%.2f",$item->{'price'} * $item->{'qty'});
		my $weight = $item->{'weight'};
		$weight =~ s/[^0-9\.\#\-]//g;

#  '*options' => {
#                                                                       'A800' => {
#                                                                                   'value' => 'Polished Brass',
#                                                                                   'v' => '00',
#                                                                                   'prompt' => 'Finish',
#                                                                                   'modifier' => ''
#                                                                                 },
#                                                                       'AB07' => {
#                                                                                   'value' => 'With Override Key',
#                                                                                   'v' => '07',
#                                                                                   'prompt' => 'Key Override Options',
#                                                                                   'modifier' => 'w=|p=+10'
#                                                                                 }
#                                                                     },
		my $description = $item->{'prod_name'};
		if (defined $item->{'*options'}) {
			$description .= "<br><table bgcolor='$BGCOLOR'>";
			foreach my $set (keys %{$item->{'*options'}}) {
				my $pog = $item->{'*options'}->{$set};
				$description .= sprintf(qq~<tr>
	<td><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>&nbsp;</font></td>
	<td valign=top><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>%s</font></td>
	<td valign=top><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>%s</font></td></tr>~
,$pog->{'prompt'},$pog->{'value'});
				}
			$description .= "</table>";
			}
		my $qty = $item->{'qty'};

		$x = "<tr>";

		my $pullsku = $SKU;
		if (index($pullsku,'*')>=0) { $pullsku = substr($pullsku,index($pullsku,'*')+1); }
		$x .= "<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>$locref->{$pullsku}</font></td>";

		$x .= qq~
<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>$SKU</font></td>
<td bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'>$description</font></td>
<td nowrap bgcolor='$BGCOLOR'><font style='font-family: sans-serif, helvetica, arial; font-size: 8pt; color: #000000'><center>$qty</center></font></td>
~;
		$x .= "</tr>";

		$out .= $x;
		}
	$out .= $footer;

	$out .= "<tr><td colspan='3' align='right' bgcolor='FFFFFF'><font style='font-family: sans-serif, helvetica, arial; font-size: 10pt; color: #3366CC'>Shipping: <B>$SHIPMETHOD</b></font></td></tr>\n";

	$BGCOLOR = '33333';



	$out .= "</table>";
	return($out);
}

undef $SITE::CONFIG;

