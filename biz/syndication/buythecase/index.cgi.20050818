#!/usr/bin/perl

use lib "/httpd/modules"; 
use CGI;
use GTOOLS;
use ZOOVY;
use ZWEBSITE;	
use IMGLIB;	
use ZTOOLKIT;
use DBINFO;
use NAVCAT;
require WHOLESALE;
use strict;

my $dbh = &DBINFO::db_zoovy_connect();	
my ($USERNAME,$FLAGS,$MID,$LUSER,$RESELLER) = ZOOVY::authenticate("/biz/syndication",2,'_P&16');
if ($USERNAME eq '') { exit; }

my $q = new CGI;
my $qtUSERNAME = $dbh->quote($USERNAME);
my $ACTION = $q->param('ACTION');

my $template_file = 'index.shtml';
if ($FLAGS !~ /,WS,/) {
	$template_file = 'deny.shtml';
	$ACTION = 'DENY';
	}

if ($ACTION eq 'SAVE') {
	my $pstmt = "select count(*) from BTC_FEEDS where MID=$MID /* $qtUSERNAME */";
	my $sth = $dbh->prepare($pstmt);
	$sth->execute();
	my ($count) = $sth->fetchrow();
	$sth->finish();

	
#+----------+---------------------+------+-----+---------+-------+
#| Field    | Type                | Null | Key | Default | Extra |
#+----------+---------------------+------+-----+---------+-------+
#| MID      | int(10) unsigned    |      | PRI | 0       |       |
#| USERNAME | varchar(20)         |      |     |         |       |
#| COMPANY  | varchar(60)         |      |     |         |       |
#| LOGO     | varchar(40)         |      |     |         |       |
#| ABOUT    | varchar(255)        |      |     |         |       |
#| PHONE    | varchar(12)         |      |     |         |       |
#| EMAIL    | varchar(65)         |      |     |         |       |
#| PREMIUM  | tinyint(3) unsigned |      |     | 0       |       |
#+----------+---------------------+------+-----+---------+-------+
#8 rows in set (0.01 sec)



	if ($ERROR ne '') {
		$GTOOLS::TAG{'<!-- ERROR -->'} = "<font color='red'>$ERROR</font>";
		}
	elsif ($count>0) {
		$pstmt = "update BTC_FEEDS set USERNAME=$qtUSERNAME,SCHEDULE=$qtSCHEDULE,UPDATED=0 where MID=$MID /* $qtUSERNAME */";
		}
	else {
		$pstmt = "
		}

	my $changed = 0;
	my $ncref = &NAVCAT::fetch_all($USERNAME);
	foreach my $safe (sort keys %{$ncref}) {
		next if (not defined $q->param('navcat-'.$safe));
		# next if ($q->param('navcat-'.$safe) eq '');
		my ($pretty, $children, $productstr, $sortby, $meta) = split (/\n/, $ncref->{$safe}, 6);	
		my $metaref = &NAVCAT::decode_meta($meta);
		next if ($metaref->{'BIZRATE_CAT'} eq $q->param('navcat-'.$safe));
		$metaref->{'BIZRATE_CAT'} = $q->param('navcat-'.$safe);
		$meta = &NAVCAT::encode_meta($metaref);
		&NAVCAT::save_info($USERNAME,$safe,$pretty,$children,$productstr,$sortby,$meta);
		}

	if ($changed) {
		
		}

	print STDERR $pstmt."\n";
	$dbh->do($pstmt);
	&ZWEBSITE::save_website_attrib($USERNAME,'buythecase',time());
	$ACTION = '';
	}


if ($ACTION eq '') {
my $hashref = {};
my $pstmt = "select * from BTC_FEEDS where MID=$MID";

my $c = '<option value="">Not Set</option>';
foreach my $s (@{&WHOLESALE::list_schedules($USERNAME)}) {
	$c .= "<option ".(($hashref->{'SCHEDULE'} eq $s)?'selected':'')." value=\"$s\">$s</option>\n";
	}
$GTOOLS::TAG{'<!-- SCHEDULE -->'} = $c;





my $c = '';
use Data::Dumper;
my $ncref = &NAVCAT::fetch_all($USERNAME);
foreach my $safe (sort keys %{$ncref}) {
	next if (substr($safe,0,1) eq '*');
	next if ($safe eq '');
	my ($pretty, $children, $productstr, $sortby, $meta) = split (/\n/, $ncref->{$safe}, 5);	
	print STDERR "META: $meta\n";
	next if (substr($pretty,0,1) eq '!');

	my $name = ''; 
	if ($pretty eq '') { $pretty = "UN-NAMED: $safe"; }
	if (substr($safe,0,1) eq '.') {
		foreach (split(/\./,$safe)) { $name .= "&nbsp; - &nbsp; "; } $name .= $pretty;
		if ($safe eq '.') { $name = 'HOMEPAGE'; }
		}
	elsif (substr($safe,0,1) eq '$') {
		$name = "LIST: ".$pretty;
		}
	my $metaref = &NAVCAT::decode_meta($meta);
	my $val = $metaref->{'BIZRATE_CAT'};
	$c .= "<tr><td nowrap>$name</td><td><input type='textbox' size='10' name='navcat-$safe' value='$val'></td></tr>\n";
	}
if ($c eq '') { $c = '<tr><td><i>No website categories exist??</i></td></tr>'; }
$GTOOLS::TAG{'<!-- CATEGORIES -->'} = $c;



&GTOOLS::output(
   'title'=>'Bizrate Syndication',
   'file'=>$template_file,
   'header'=>'1',
   'help'=>'detail/setup-bizrate.php',
   'tabs'=>[
      ],
   'bc'=>[
      { name=>'Syndication',link=>'http://www.zoovy.com/biz/syndication','target'=>'_top', },
      { name=>'Bizrate',link=>'http://www.zoovy.com/biz/syndication/bizrate','target'=>'_top', },
      ],
   );

&DBINFO::db_zoovy_close();

