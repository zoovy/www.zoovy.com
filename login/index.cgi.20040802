#!/usr/bin/perl

use lib "/httpd/modules";
require ZAUTH;
require ZOOVY;
use strict;
require GTOOLS;

&GTOOLS::init();

my $gmt = time();
my $t = 43200; # 12 hour tolerance for timecheck

$GTOOLS::TAG{'<!-- TIMECHECK -->'} = qq~
<script>
<!--
var nowms = (new Date()).getTime();
nowms = nowms / 1000;

// document.write(Date()+".")
if ( (nowms - $gmt > $t) || ($gmt - nowms > $t)) {
	document.write('<br><table bgcolor="yellow"><tr><td><font size="2" color="red">WARNING: SYSTEM CLOCK IS INCORRECT!<br>CANNOT SAVE COOKIES</b></font></td></tr></table><br>');
	}

//-->
</script>
~;


sub resolvehost
{
   my ($addr) = @_;


   if ($addr eq '192.168.2.60') { $addr = 'www1'; }
   elsif ($addr eq '192.168.2.65') { $addr = 'www2'; }
   elsif ($addr eq '192.168.2.70') { $addr = 'www3'; }
   elsif ($addr eq '192.168.2.75') { $addr = 'www4'; }
   elsif ($addr eq '192.168.2.80') { $addr = 'www5'; }
   elsif ($addr eq '192.168.2.85') { $addr = 'www6'; }
   elsif ($addr eq '192.168.1.12') { $addr = 'dev'; }

   return($addr);
}

&ZOOVY::init();

# print STDERR "Running ... login\n";
my $sendto = $ZOOVY::cgiv->{'sendto'};

#if (lc($ZOOVY::cgiv->{'password'}) eq 'trail') { $ZOOVY::cgiv->{'password'} = 'trial'; }


$GTOOLS::TAG{'<!-- SENDTO -->'} = $sendto;

$GTOOLS::TAG{'<!-- HOSTNAME -->'} = &resolvehost($ENV{'SERVER_ADDR'});


my ($auth_status, $auth_extra_info) = &ZAUTH::authenticate("$sendto");
&ZAUTH::set_checkcookie();


print STDERR "Login says: auth_status: $auth_status auth_extra_info: $auth_extra_info\n";

# print "Content-type: text/plain\n\nautstatus: $auth_status\n"; exit;
# The first result authenticate gives us is an error code (0 for success)
if ($auth_status != 0)
{
	# Failed login, give the user the prompt with whatever message was
	# returned from authenticate by shifting the results array again
	ZAUTH::display_login_prompt($auth_extra_info);
}
else
{
	# Successful login, send the user to the location returned from
	# authenticate by shifting the results array again
		
	print "Location: $auth_extra_info\n\n";
}


# print STDERR "End .. index.cgi\n";
